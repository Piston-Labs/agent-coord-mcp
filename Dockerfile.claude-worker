# Claude CLI Worker Container
# Spawned by Railway substrate for ephemeral task execution
#
# Features:
# - Full Claude CLI with bash, git, file editing capabilities
# - Isolated workspace for repo cloning
# - Soul injection via environment variables
# - Secure credential handling (runtime injection only)
#
# Build: docker build -f Dockerfile.claude-worker -t claude-worker .
# Run:   docker run -e ANTHROPIC_API_KEY=... -e SOUL_ID=phoenix claude-worker

FROM node:20-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    openssh-client \
    ca-certificates \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Install Claude CLI globally
RUN npm install -g @anthropic-ai/claude-code

# Create non-root user for security
RUN useradd -m -s /bin/bash worker
RUN mkdir -p /workspace && chown worker:worker /workspace

# Create entrypoint script
COPY --chown=worker:worker docker/worker-entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Copy soul loader and coordinator
COPY --chown=worker:worker dist/worker-init.js /app/worker-init.js

# Set working directory
WORKDIR /workspace

# Switch to non-root user
USER worker

# Environment variables (injected at runtime - NEVER baked in)
# ANTHROPIC_API_KEY - Required for Claude CLI
# GITHUB_TOKEN - For repo access
# SOUL_ID - Which soul/personality to load
# TARGET_REPO - Repo to clone (e.g., "Piston-Labs/agent-coord-mcp")
# TASK - Initial task description
# AGENT_ID - Unique identifier for this worker
# COORD_API - Coordination hub URL

ENV NODE_ENV=production
ENV WORKSPACE=/workspace

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3847/health || exit 1

# Run entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
