<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Piston Labs - Agent Coordination Hub</title>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border: #30363d;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --accent: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --agent-color: #58a6ff;
      --human-color: #a371f7;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 18px;
    }

    .logo svg { width: 28px; height: 28px; }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .status-dot.offline { background: var(--danger); }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 260px 1fr 280px;
      gap: 1px;
      background: var(--border);
      overflow: hidden;
      height: calc(100vh - 53px); /* Account for header */
    }

    .panel {
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }

    .panel-header {
      padding: 14px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .panel-content {
      flex: 1;
      min-height: 0; /* Critical for flex overflow */
      overflow-y: auto;
      padding: 8px;
    }

    /* Agents Panel */
    .agent-card {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .agent-card:hover { border-color: var(--accent); }

    .agent-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .agent-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .agent-avatar.human { background: var(--human-color); }

    .agent-name { font-weight: 600; font-size: 14px; }

    .agent-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      margin-left: auto;
    }

    .agent-status.active { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .agent-status.idle { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .agent-status.restored { background: rgba(88, 166, 255, 0.2); color: var(--accent); }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(63, 185, 80, 0); }
    }

    .agent-task {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Chat Panel */
    .chat-messages {
      flex: 1;
      min-height: 0; /* Critical for flex overflow */
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 10px;
      max-width: 85%;
    }

    .message.own { align-self: flex-end; flex-direction: row-reverse; }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--agent-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message-avatar.human { background: var(--human-color); }

    .message-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
    }

    .message.own .message-content {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .message-author {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--accent);
    }

    .message.own .message-author { color: rgba(255,255,255,0.8); }

    .message-text {
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message-time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .message.own .message-time { color: rgba(255,255,255,0.6); }

    .chat-input {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    .chat-input input {
      flex: 1;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
    }

    .chat-input input:focus { border-color: var(--accent); }

    .chat-input button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .chat-input button:hover { opacity: 0.9; }

    /* Context Panel */

    /* Activity Feed Styles */
    .activity-feed {
      max-height: 200px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      background: var(--bg-secondary);
      margin-bottom: 6px;
      font-size: 12px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .activity-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .activity-icon.message { background: rgba(88, 166, 255, 0.2); }
    .activity-icon.task { background: rgba(63, 185, 80, 0.2); }
    .activity-icon.claim { background: rgba(210, 153, 34, 0.2); }
    .activity-icon.lock { background: rgba(248, 81, 73, 0.2); }
    .activity-icon.agent { background: rgba(163, 113, 247, 0.2); }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-text {
      color: var(--text-primary);
      line-height: 1.3;
    }

    .activity-text strong {
      color: var(--accent);
    }

    .activity-time {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .activity-empty {
      text-align: center;
      padding: 16px;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .context-section {
      margin-bottom: 16px;
    }

    .context-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding: 0 8px;
    }

    .context-item {
      padding: 10px 12px;
      border-radius: 6px;
      background: var(--bg-secondary);
      margin-bottom: 4px;
      font-size: 13px;
      border-left: 3px solid var(--border);
    }

    .context-item.claim { border-left-color: var(--warning); }
    .context-item.lock { border-left-color: var(--danger); }
    .context-item.zone { border-left-color: var(--success); }
    .context-item.task { border-left-color: var(--accent); }
    .context-item.feature { border-left-color: #a371f7; }

    .context-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .context-item-title { font-weight: 600; }

    .context-item-owner {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .context-item-detail {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Token efficiency indicator */
    .efficiency-bar {
      background: var(--bg-tertiary);
      border-radius: 4px;
      height: 6px;
      margin-top: 8px;
      overflow: hidden;
    }

    .efficiency-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      transition: width 0.3s;
    }

    .efficiency-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Tabs */
    .tabs-header {
      padding: 0 16px;
    }

    .tabs {
      display: flex;
      gap: 4px;
    }

    .tab {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 14px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      min-height: 0;
      overflow-y: auto;
    }

    .tab-content.active {
      display: flex;
    }

    /* CRM View specific - contain the pipeline */
    .tab-content.crm-view.active {
      overflow: hidden;
    }

    /* Roadmap View */

    
    /* Metrics View */
    .metrics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
    }

    .metrics-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: visible;
      min-height: 180px;
    }

    .metrics-card-title {
      padding: 12px 14px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      background: var(--bg-tertiary);
    }

    .metrics-card-content {
      padding: 16px;
    }

    .metric-big {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
      line-height: 1.2;
    }

    .metric-big.completion-rate {
      color: var(--success);
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
    }

    .metric-row:last-child {
      border-bottom: none;
    }

    .metric-row span:first-child {
      color: var(--text-secondary);
    }

    .metric-row span:last-child {
      font-weight: 600;
      color: var(--text-primary);
    }

    .metrics-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
    }

    .top-contributors {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }

    .metrics-footer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 1200px) {
      .metrics-footer-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .metrics-footer-grid {
        grid-template-columns: 1fr;
      }
    }

    .system-status-card,
    .activity-stream-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }

    .system-status-header,
    .activity-stream-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .status-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      font-weight: 500;
    }

    .status-badge.online {
      background: rgba(63, 185, 80, 0.2);
      color: var(--success);
    }

    .system-status-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-row span:last-child {
      color: var(--text-primary);
      font-family: monospace;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-indicator::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-indicator.online::before {
      background: var(--success);
      box-shadow: 0 0 4px var(--success);
    }

    .live-pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse-live 2s infinite;
    }

    .activity-stream {
      max-height: 150px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .activity-stream .activity-item {
      font-size: 11px;
      color: var(--text-secondary);
      padding: 6px 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .activity-stream .activity-item::before {
      content: '';
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
    }

    .activity-stream .activity-item.success::before {
      background: var(--success);
    }

    .contributor-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 12px;
    }
    /* Enhanced Metrics Dashboard Styles */
    .metrics-dashboard {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .metrics-header h3::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse-dot 2s ease-in-out infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    .metrics-period-selector {
      display: flex;
      gap: 4px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 3px;
    }

    .period-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .period-btn:hover {
      color: var(--text-primary);
    }

    .period-btn.active {
      background: var(--accent);
      color: white;
    }

    .metrics-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .metrics-card.highlight {
      border-color: var(--accent);
    }

    .card-icon {
      font-size: 14px;
    }

    .metric-hero {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .metric-big.success { color: var(--success); }
    .metric-big.warning { color: var(--warning); }
    .metric-big.danger { color: var(--danger); }

    .metric-trend {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .metric-trend.up {
      color: var(--success);
      background: rgba(63, 185, 80, 0.15);
    }

    .metric-trend.down {
      color: var(--danger);
      background: rgba(248, 81, 73, 0.15);
    }

    .metric-trend.neutral {
      color: var(--text-secondary);
      background: var(--bg-tertiary);
    }

    .metric-sparkline {
      height: 32px;
      margin: 12px 0 8px 0;
      display: flex;
      align-items: flex-end;
      gap: 2px;
    }

    .sparkline-bar {
      flex: 1;
      background: var(--accent);
      border-radius: 2px 2px 0 0;
      min-height: 4px;
      transition: height 0.3s ease;
      opacity: 0.6;
    }

    .sparkline-bar:last-child {
      opacity: 1;
    }

    .sparkline-bar:hover {
      opacity: 1;
    }

    .metric-progress-bar {
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
      margin: 8px 0;
    }

    .metric-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease-out;
    }

    .metric-progress-fill.success { background: linear-gradient(90deg, var(--success), #4ac969); }
    .metric-progress-fill.warning { background: linear-gradient(90deg, var(--warning), #e5b42a); }
    .metric-progress-fill.danger { background: linear-gradient(90deg, var(--danger), #f96a64); }
    .metric-progress-fill.accent { background: linear-gradient(90deg, var(--accent), #7bb8ff); }

    .metric-row-icon {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      font-size: 10px;
    }

    .metric-row-icon.lock { background: rgba(248, 81, 73, 0.2); }
    .metric-row-icon.claim { background: rgba(210, 153, 34, 0.2); }
    .metric-row-icon.handoff { background: rgba(88, 166, 255, 0.2); }
    .metric-row-icon.workflow { background: rgba(163, 113, 247, 0.2); }

    .contributors-header {
      padding: 12px 14px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contributor-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .contributor-rank.gold { background: linear-gradient(135deg, #ffd700, #ffec8b); color: #000; }
    .contributor-rank.silver { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #000; }
    .contributor-rank.bronze { background: linear-gradient(135deg, #cd7f32, #daa06d); color: #000; }

    .contributor-bar {
      width: 60px;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .contributor-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--success);
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--success);
      border-radius: 50%;
      animation: live-pulse 1.5s ease-in-out infinite;
    }

    @keyframes live-pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.4); }
      50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(63, 185, 80, 0); }
    }

    /* Metrics mobile */
    @media (max-width: 1200px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }



    /* === ENHANCED MOBILE EXPERIENCE === */
    @media (max-width: 768px) {
      /* Smooth transitions for tab switching */
      .tab-content {
        animation: fadeIn 0.2s ease-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      /* Better touch scrolling */
      .panel-content,
      .chat-messages,
      .metrics-grid,
      .roadmap-board {
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }
      
      /* Improved metrics on mobile */
      .metrics-header {
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }
      
      .metrics-header h3 {
        font-size: 15px;
      }
      
      .metrics-period-selector {
        width: 100%;
        justify-content: center;
      }
      
      .period-btn {
        flex: 1;
        padding: 8px;
        text-align: center;
      }
      
      .metric-big {
        font-size: 28px;
      }
      
      .metric-hero {
        flex-wrap: wrap;
      }
      
      /* Better contributor cards on mobile */
      .contributor-item {
        padding: 8px 10px;
      }
      
      .contributor-avatar {
        width: 28px;
        height: 28px;
        font-size: 11px;
      }
      
      .contributor-name {
        font-size: 12px;
      }
      
      .contributor-bar {
        width: 50px;
      }
      
      /* Improved telemetry on mobile */
      .telemetry-header {
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }
      
      /* Fix: Fleet stat labels - increase from 10px to 12px for readability */
      .fleet-stat-label {
        font-size: 12px !important;
        letter-spacing: 0.2px;
      }
      
      /* Fix: Fleet stat values - ensure readable size */
      .fleet-stat-value {
        font-size: 18px;
      }
      
      /* Fix: Fleet summary wrapping and spacing */
      .fleet-summary {
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }
      
      .fleet-stat {
        flex: 1 1 calc(33% - 8px);
        min-width: 65px;
        max-width: 100px;
        padding: 8px 10px;
      }
      
      /* Fix: Telemetry controls - ensure proper touch targets (44x44px minimum) */
      .telemetry-controls {
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }
      
      .telemetry-controls button,
      .telemetry-controls .map-btn,
      .telemetry-controls .refresh-btn,
      .telemetry-controls .overview-toggle {
        min-width: 44px;
        min-height: 44px;
        padding: 10px 14px;
        font-size: 12px;
      }
      
      /* Fix: Live indicator spacing */
      .live-indicator {
        font-size: 11px;
        gap: 6px;
      }
      
      .last-updated {
        font-size: 10px;
      }
      
      /* Fix: Device list table - horizontal scrolling */
      .device-list-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 0;
      }
      
      .device-list-table {
        min-width: 600px;
        font-size: 11px;
      }
      
      .device-list-table th,
      .device-list-table td {
        padding: 8px 6px;
        font-size: 11px;
      }
      
      .device-list-header {
        padding: 10px 12px;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .device-list-header h3 {
        font-size: 14px;
      }
      
      .device-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 12px;
      }
      
      .device-card {
        padding: 12px;
      }
      
      .device-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      /* Fix: Health overview on mobile */
      .health-overview {
        padding: 12px;
        gap: 16px;
      }
      
      .health-gauge {
        transform: scale(0.85);
        margin: -10px 0;
      }
      
      .gauge-score {
        font-size: 24px;
      }
      
      .breakdown-label {
        font-size: 11px;
      }
      
      .breakdown-value {
        font-size: 12px;
      }
      
      /* Fix: Alerts banner on mobile */
      .alerts-banner {
        padding: 8px 12px;
      }
      
      .alert-indicator {
        padding: 6px 10px;
        font-size: 11px;
        min-height: 36px;
      }
      
      /* System health on mobile */
      .health-overview {
        flex-direction: column;
        gap: 12px;
      }
      
      .health-gauge-container {
        width: 100%;
        max-width: 200px;
        margin: 0 auto;
      }
      
      /* Bottom nav improvements */
      .mobile-nav {
        padding: 8px 4px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
      }
      
      .mobile-nav-item {
        padding: 8px 6px;
        font-size: 10px;
        gap: 3px;
      }
      
      .mobile-nav-icon {
        font-size: 18px;
      }
      
      /* Roadmap on mobile */
      .roadmap-board {
        grid-template-columns: 1fr;
        overflow-x: visible;
      }
      
      .roadmap-column {
        min-height: auto;
      }
      
      .roadmap-stats {
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px;
      }
      
      .roadmap-stat {
        flex: 1 1 calc(50% - 8px);
        min-width: 80px;
      }
      
      .roadmap-filters {
        flex-wrap: wrap;
      }
      
      .roadmap-filters select {
        flex: 1;
        min-width: 100px;
      }
      
      /* Login modal mobile */
      .login-modal {
        width: 95%;
        max-width: 400px;
        padding: 20px;
      }
      
      .login-modal h2 {
        font-size: 20px;
      }
      
      /* DM panel mobile */
      .dm-panel {
        width: 100%;
        right: -100%;
      }
      
      .dm-panel.open {
        right: 0;
      }
      
      /* Pull-to-refresh hint */
      .pull-hint {
        text-align: center;
        padding: 8px;
        font-size: 11px;
        color: var(--text-secondary);
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .pulling .pull-hint {
        opacity: 1;
      }
    }

    /* Extra small screens (iPhone SE, etc) */
    @media (max-width: 375px) {
      header {
        padding: 8px 10px;
      }
      
      .logo {
        font-size: 14px;
        gap: 6px;
      }
      
      .logo svg {
        width: 22px;
        height: 22px;
      }
      
      .status-bar {
        gap: 10px;
        font-size: 11px;
      }
      
      .metric-big {
        font-size: 28px;
      }
      
      .metrics-card-content {
        padding: 14px;
      }
      
      .chat-input {
        padding: 8px;
      }
      
      .chat-input button#sendBtn {
        padding: 10px 12px;
        min-width: 50px;
      }
      
      /* Extra small telemetry fixes */
      .fleet-stat {
        flex: 1 1 calc(50% - 6px);
        min-width: 60px;
        padding: 6px 8px;
      }
      
      .fleet-stat-value {
        font-size: 16px;
      }
      
      .fleet-stat-label {
        font-size: 11px !important;
      }
      
      .telemetry-controls button,
      .telemetry-controls .map-btn,
      .telemetry-controls .refresh-btn {
        padding: 8px 12px;
        font-size: 11px;
      }
      
      .device-list-table {
        font-size: 10px;
      }
      
      .device-list-table th,
      .device-list-table td {
        padding: 6px 4px;
      }
      
      .health-gauge {
        transform: scale(0.75);
        margin: -15px 0;
      }
    }

    /* Landscape mobile */
    @media (max-width: 896px) and (orientation: landscape) {
      main {
        height: calc(100vh - 45px);
      }
      
      .mobile-nav {
        padding: 4px;
      }
      
      .mobile-nav-item {
        padding: 6px 8px;
      }
      
      .modal {
        max-height: 80vh;
      }
    }

    /* High contrast / reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Dark mode improvements (already dark, but ensure consistency) */
    @media (prefers-color-scheme: dark) {
      :root {
        color-scheme: dark;
      }
    }


    .contributor-name {
      color: var(--text-primary);
      font-weight: 500;
    }

    .contributor-count {
      color: var(--accent);
      font-weight: 600;
    }

    .category-tag {
      display: inline-block;
      padding: 2px 6px;
      margin: 2px;
      font-size: 10px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      color: var(--text-secondary);
    }


    
    
    
    /* Device Detail Modal */

    /* Sparkline Charts */
    .sparkline-container {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .sparkline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .sparkline-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .sparkline-value {
      font-size: 12px;
      color: var(--accent);
    }
    
    .sparkline {
      height: 40px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      background: var(--bg-primary);
      border-radius: 4px;
      padding: 4px;
    }
    
    .sparkline-bar {
      flex: 1;
      background: var(--accent);
      border-radius: 2px 2px 0 0;
      min-width: 4px;
      transition: height 0.3s ease;
      opacity: 0.7;
    }
    
    .sparkline-bar:hover {
      opacity: 1;
    }
    
    .sparkline-bar.warning {
      background: var(--warning);
    }
    
    .sparkline-bar.critical {
      background: var(--danger);
    }
    
    .sparkline-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 9px;
      color: var(--text-secondary);
    }
    
    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 12px;
    }
    
    .chart-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--border);
    }
    
    .chart-card-title {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .device-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .device-modal-overlay.visible {
      display: flex;
    }

    .device-modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .device-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .device-modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .device-modal-content {
      padding: 16px 20px;
    }

    .modal-section {
      margin-bottom: 20px;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section h4 {
      margin: 0 0 12px 0;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
    }

    .modal-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .info-item {
      background: var(--bg-tertiary);
      padding: 10px;
      border-radius: 6px;
    }

    .info-label {
      display: block;
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .info-value {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: monospace;
    }

    .modal-metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .modal-metric {
      background: var(--bg-tertiary);
      padding: 12px;
      border-radius: 6px;
      text-align: center;
    }

    .modal-metric-value {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }

    .modal-metric-label {
      display: block;
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .modal-status-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-indicator .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .status-indicator.active {
      color: var(--success);
    }

    .status-indicator.active .status-dot {
      background: var(--success);
    }

    .modal-health {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .health-bar-container {
      flex: 1;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .health-bar {
      height: 100%;
      background: var(--success);
      border-radius: 4px;
      transition: width 0.3s, background 0.3s;
    }

    .health-bar.warning {
      background: var(--warning);
    }

    .health-bar.critical {
      background: var(--danger);
    }

    .health-score-label {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      min-width: 40px;
      text-align: right;
    }

    .modal-issues {
      margin-top: 10px;
    }

    .modal-issue {
      padding: 8px 12px;
      background: rgba(248, 81, 73, 0.1);
      border-left: 3px solid var(--danger);
      border-radius: 4px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .modal-issue.warning {
      background: rgba(210, 153, 34, 0.1);
      border-left-color: var(--warning);
    }

    .modal-location {
      background: var(--bg-tertiary);
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      color: var(--text-primary);
    }

    .location-meta {
      display: block;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 8px;
    }


    /* Fleet Map */
    .fleet-map-container {
      position: relative;
      height: 200px;
      margin: 0 16px 16px 16px;
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      display: none;
    }

    .fleet-map-container.visible {
      display: block;
    }

    .fleet-map {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a2332 0%, #0d1117 100%);
      position: relative;
      overflow: hidden;
    }

    .fleet-map::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        linear-gradient(rgba(88, 166, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(88, 166, 255, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }

    .map-overlay {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .map-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      background: var(--bg-primary);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .map-legend {
      display: flex;
      gap: 12px;
      font-size: 10px;
      color: var(--text-secondary);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .legend-item.active .legend-dot {
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .legend-item.parked .legend-dot {
      background: var(--text-secondary);
    }

    .map-devices {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .map-device {
      position: absolute;
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .map-device:hover {
      transform: translate(-50%, -50%) scale(1.2);
      z-index: 100;
    }

    .map-device-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-secondary);
      border: 2px solid var(--bg-primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .map-device.active .map-device-dot {
      background: var(--success);
      animation: pulse-map 2s infinite;
    }

    .map-device.moving .map-device-dot {
      background: var(--accent);
      animation: pulse-map 1s infinite;
    }

    @keyframes pulse-map {
      0%, 100% { box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(63, 185, 80, 0); }
    }

    .map-device-label {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 4px;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-primary);
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: 3px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .map-device:hover .map-device-label {
      opacity: 1;
    }

    .map-toggle {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      z-index: 10;
    }

    .map-toggle:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }


    /* Health indicators */
    .fleet-stat.health .fleet-stat-value {
      color: var(--success);
    }

    .fleet-stat.health.warning .fleet-stat-value {
      color: var(--warning);
    }

    .fleet-stat.health.critical .fleet-stat-value {
      color: var(--danger);
    }

    
    .map-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 12px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .map-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .map-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

.telemetry-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(248, 81, 73, 0.15);
      border: 1px solid var(--danger);
      border-radius: 6px;
      color: var(--danger);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .alert-indicator:hover {
      background: rgba(248, 81, 73, 0.25);
    }

    .alert-count {
      background: var(--danger);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
    }

    .alerts-banner {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 8px 16px;
      max-height: 120px;
      overflow-y: auto;
    }

    .alert-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      margin: 4px 0;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 12px;
      border-left: 3px solid var(--warning);
    }

    .alert-item.critical {
      border-left-color: var(--danger);
      background: rgba(248, 81, 73, 0.1);
    }

    .alert-item.warning {
      border-left-color: var(--warning);
    }

    .alert-item.info {
      border-left-color: var(--accent);
    }

    .alert-device {
      font-weight: 600;
      color: var(--text-primary);
      min-width: 80px;
    }

    .alert-message {
      flex: 1;
      color: var(--text-secondary);
    }

    .alert-time {
      font-size: 10px;
      color: var(--text-secondary);
    }

    /* Health status on device cards */
    .device-health {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border);
      font-size: 11px;
    }

    .health-score {
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .health-score.excellent {
      background: rgba(63, 185, 80, 0.2);
      color: var(--success);
    }

    .health-score.good {
      background: rgba(88, 166, 255, 0.2);
      color: var(--accent);
    }

    .health-score.warning {
      background: rgba(210, 153, 34, 0.2);
      color: var(--warning);
    }

    .health-score.critical {
      background: rgba(248, 81, 73, 0.2);
      color: var(--danger);
    }

    .health-issues {
      flex: 1;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }


    /* Telemetry View */


    /* Real-time Indicators */
    .live-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: livePulse 2s infinite;
    }
    
    @keyframes livePulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }
    
    .last-updated {
      font-size: 10px;
      color: var(--text-secondary);
      margin-left: auto;
    }
    
    .refresh-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .data-stale {
      color: var(--warning);
    }
    
    .refresh-btn.loading {
      pointer-events: none;
      opacity: 0.7;
    }

    /* Health Overview Panel */
    .health-overview {
      display: none;
      padding: 20px;
      background: linear-gradient(135deg, rgba(63, 185, 80, 0.05), rgba(139, 92, 246, 0.05));
      border-bottom: 1px solid var(--border);
      min-height: 180px;
    }
    
    .health-overview.visible {
      display: grid;
      grid-template-columns: 180px 1fr 280px;
      gap: 24px;
      align-items: start;
    }
    
    .health-gauge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .gauge-circle {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: conic-gradient(
        var(--success) calc(var(--score) * 1%),
        var(--border) calc(var(--score) * 1%)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .gauge-circle.warning {
      background: conic-gradient(
        var(--warning) calc(var(--score) * 1%),
        var(--border) calc(var(--score) * 1%)
      );
    }
    
    .gauge-circle.critical {
      background: conic-gradient(
        var(--danger) calc(var(--score) * 1%),
        var(--border) calc(var(--score) * 1%)
      );
    }
    
    .gauge-inner {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .gauge-score {
      font-size: 36px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }
    
    .gauge-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    .health-breakdown {
      display: grid;
      grid-template-rows: repeat(4, 1fr);
      gap: 10px;
    }
    
    .breakdown-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border);
      min-height: 48px;
    }
    
    .breakdown-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .breakdown-icon.excellent { background: rgba(63, 185, 80, 0.2); }
    .breakdown-icon.good { background: rgba(88, 166, 255, 0.2); }
    .breakdown-icon.warning { background: rgba(210, 153, 34, 0.2); }
    .breakdown-icon.critical { background: rgba(248, 81, 73, 0.2); }
    
    .breakdown-info {
      flex: 1;
    }
    
    .breakdown-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .breakdown-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .breakdown-bar {
      width: 60px;
      height: 6px;
      background: var(--bg-primary);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .breakdown-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .breakdown-bar-fill.excellent { background: var(--success); }
    .breakdown-bar-fill.good { background: var(--accent); }
    .breakdown-bar-fill.warning { background: var(--warning); }
    .breakdown-bar-fill.critical { background: var(--danger); }
    
    .health-alerts {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .health-alerts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .health-alerts-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .health-alerts-toggle {
      font-size: 11px;
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
    }
    
    .health-alert-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border-left: 3px solid var(--warning);
    }
    
    .health-alert-item.critical {
      border-left-color: var(--danger);
    }
    
    .health-alert-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--warning);
      flex-shrink: 0;
    }
    
    .health-alert-item.critical .health-alert-dot {
      background: var(--danger);
      animation: pulse 1.5s infinite;
    }
    
    .health-alert-text {
      flex: 1;
      font-size: 12px;
      color: var(--text-primary);
    }
    
    .health-alert-time {
      font-size: 10px;
      color: var(--text-secondary);
    }
    
    .no-alerts {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-secondary);
      text-align: center;
    }
    
    .no-alerts svg {
      width: 40px;
      height: 40px;
      margin-bottom: 8px;
      color: var(--success);
    }
    
    .overview-toggle {
      padding: 4px 10px;
      font-size: 11px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      cursor: pointer;
      margin-left: 8px;
    }
    
    .overview-toggle:hover {
      background: var(--bg-primary);
    }

    .telemetry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .fleet-summary {
      display: flex;
      gap: 16px;
    }

    .fleet-stat {
      text-align: center;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 10px;
      border: 1px solid var(--border);
      min-width: 80px;
    }

    .fleet-stat.active { border-color: var(--success); background: rgba(63, 185, 80, 0.1); }
    .fleet-stat.moving { border-color: var(--accent); background: rgba(88, 166, 255, 0.1); }
    .fleet-stat.health { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }

    .fleet-stat-value {
      display: block;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .fleet-stat.active .fleet-stat-value { color: var(--success); }
    .fleet-stat.moving .fleet-stat-value { color: var(--accent); }

    .fleet-stat-label {
      display: block;
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .refresh-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 16px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .refresh-btn:hover { border-color: var(--accent); }

    .telemetry-grid {
      flex: 1;
      display: grid !important;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      padding: 20px;
      overflow-y: auto;
    }

    .device-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: visible;
      transition: border-color 0.15s, transform 0.15s, box-shadow 0.15s;
      padding-bottom: 8px;
    }

    .device-card:hover { 
      border-color: var(--accent); 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .device-card.ignition-on { border-left: 4px solid var(--success); }
    .device-card.ignition-off { border-left: 4px solid var(--text-secondary); }

    .device-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }

    .device-name {
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
    }

    .device-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      background: var(--bg-tertiary);
    }

    .device-status.moving {
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent);
    }

    .device-status.parked {
      background: rgba(139, 148, 158, 0.15);
      color: var(--text-secondary);
    }

    .device-status.offline {
      background: rgba(248, 81, 73, 0.15);
      color: var(--danger);
    }

    .device-card.device-offline {
      border-left: 4px solid var(--danger);
    }

    .live-dot.offline {
      background: var(--danger);
      animation: none;
    }

    .device-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .device-metrics {
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .metric {
      text-align: center;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .metric-value.speed { color: var(--accent); }
    .metric-value.battery-good { color: var(--success); }
    .metric-value.battery-warn { color: var(--warning); }
    .metric-value.battery-low { color: var(--danger); }

    .metric-label {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .device-vehicle {
      padding: 8px 12px;
      background: var(--bg-tertiary);
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }

    .device-vin {
      font-family: monospace;
      color: var(--text-primary);
      font-size: 10px;
      word-break: break-all;
    }

    /* New Device Card Elements */
    .device-title-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .device-imei {
      font-family: monospace;
      font-size: 10px;
      color: var(--accent);
      opacity: 0.8;
      letter-spacing: 0.5px;
    }

    .device-live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(88, 166, 255, 0.1);
      font-size: 11px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }

    .live-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse-live 2s infinite;
    }

    @keyframes pulse-live {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.4); }
      50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(63, 185, 80, 0); }
    }

    .signal-bars {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      margin-left: auto;
    }

    .signal-bar {
      width: 3px;
      background: var(--border);
      border-radius: 1px;
    }

    .signal-bar:nth-child(1) { height: 4px; }
    .signal-bar:nth-child(2) { height: 6px; }
    .signal-bar:nth-child(3) { height: 8px; }
    .signal-bar:nth-child(4) { height: 10px; }
    .signal-bar:nth-child(5) { height: 12px; }

    .signal-bar.active {
      background: var(--success);
    }

    .device-metrics-row2 {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }

    .metric-small {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .metric-icon-sm {
      font-size: 12px;
    }

    .device-location {
      display: flex;
      justify-content: space-between;
      padding: 6px 12px;
      font-size: 10px;
      color: var(--text-secondary);
      font-family: monospace;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
    }

    .location-coords {
      color: var(--accent);
    }

    .location-heading {
      opacity: 0.7;
    }

    /* Enhanced Telemetry Styles */
    .device-card {
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.15s;
    }

    .device-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .device-card.health-excellent { border-left-color: var(--success) !important; }
    .device-card.health-good { border-left-color: #4ac969 !important; }
    .device-card.health-warning { border-left-color: var(--warning) !important; }
    .device-card.health-critical { border-left-color: var(--danger) !important; }

    .device-health-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
    }

    .device-health-badge.warning { background: var(--warning); }
    .device-health-badge.critical { background: var(--danger); animation: pulse-badge 1.5s infinite; }

    @keyframes pulse-badge {
      0%, 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(248, 81, 73, 0); }
    }

    .device-mini-chart {
      height: 24px;
      display: flex;
      align-items: flex-end;
      gap: 1px;
      padding: 4px 12px;
      background: var(--bg-primary);
      border-top: 1px solid var(--border);
    }

    .mini-chart-bar {
      flex: 1;
      background: var(--accent);
      border-radius: 1px 1px 0 0;
      opacity: 0.5;
      min-height: 2px;
      max-height: 20px;
      transition: height 0.3s ease;
    }

    .mini-chart-bar:last-child {
      opacity: 1;
    }

    .device-metrics {
      position: relative;
    }

    .metric-icon {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .metric-value {
      font-variant-numeric: tabular-nums;
      transition: color 0.3s ease;
    }

    .metric-trend {
      display: inline-flex;
      align-items: center;
      font-size: 10px;
      margin-left: 4px;
    }

    .metric-trend.up { color: var(--success); }
    .metric-trend.down { color: var(--danger); }

    /* Fleet summary enhancements */
    .fleet-summary {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .fleet-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      min-width: 70px;
      transition: transform 0.2s;
    }

    .fleet-stat:hover {
      transform: translateY(-2px);
    }

    .fleet-stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .fleet-stat.active .fleet-stat-value { color: var(--success); }
    .fleet-stat.moving .fleet-stat-value { color: var(--accent); }
    .fleet-stat.health .fleet-stat-value { color: var(--success); }

    .fleet-stat-label {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Health gauge enhancements */
    .health-gauge {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .gauge-circle {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: conic-gradient(
        var(--success) 0deg calc(var(--score) * 3.6deg),
        var(--bg-tertiary) calc(var(--score) * 3.6deg) 360deg
      );
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: background 0.5s ease;
    }

    .gauge-inner {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .gauge-score {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
    }

    .gauge-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    /* Breakdown bars */
    .health-breakdown {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
    }

    .breakdown-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .breakdown-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .breakdown-icon.excellent { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .breakdown-icon.good { background: rgba(74, 201, 105, 0.2); color: #4ac969; }
    .breakdown-icon.warning { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .breakdown-icon.critical { background: rgba(248, 81, 73, 0.2); color: var(--danger); }

    .breakdown-info {
      flex: 1;
    }

    .breakdown-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .breakdown-value {
      font-size: 14px;
      font-weight: 600;
    }

    .breakdown-bar {
      width: 80px;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .breakdown-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .breakdown-bar-fill.excellent { background: var(--success); }
    .breakdown-bar-fill.good { background: #4ac969; }
    .breakdown-bar-fill.warning { background: var(--warning); }
    .breakdown-bar-fill.critical { background: var(--danger); }

    /* Alerts styling */
    .health-alerts {
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 8px;
      margin: 12px;
    }

    .health-alerts-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .health-alerts-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .health-alerts-toggle {
      font-size: 11px;
      color: var(--accent);
      cursor: pointer;
    }

    .no-alerts {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .no-alerts svg {
      width: 20px;
      height: 20px;
      color: var(--success);
    }

    .alert-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 12px;
      border-left: 3px solid var(--warning);
    }

    .alert-item.critical {
      border-left-color: var(--danger);
      background: rgba(248, 81, 73, 0.1);
    }

    .alert-icon {
      font-size: 14px;
    }

    .alert-message {
      flex: 1;
    }

    .alert-time {
      font-size: 10px;
      color: var(--text-secondary);
    }


    /* Roadmap Enhancements */
    .roadmap-stats {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    
    .roadmap-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 13px;
    }
    
    .roadmap-stat-value {
      font-weight: 700;
      font-size: 16px;
    }
    
    .roadmap-stat-value.backlog { color: var(--text-secondary); }
    .roadmap-stat-value.in-progress { color: var(--accent); }
    .roadmap-stat-value.review { color: var(--warning); }
    .roadmap-stat-value.done { color: var(--success); }
    
    .roadmap-progress {
      flex: 1;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .roadmap-progress-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
    }
    
    .roadmap-progress-segment {
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .roadmap-progress-segment.done { background: var(--success); }
    .roadmap-progress-segment.review { background: var(--warning); }
    .roadmap-progress-segment.in-progress { background: var(--accent); }
    
    .roadmap-progress-label {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }
    
    /* Priority filter badges */
    .priority-filters {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }
    
    .priority-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s;
    }
    
    .priority-badge.critical { background: rgba(248, 81, 73, 0.15); color: var(--danger); border-color: rgba(248, 81, 73, 0.3); }
    .priority-badge.high { background: rgba(210, 153, 34, 0.15); color: var(--warning); border-color: rgba(210, 153, 34, 0.3); }
    .priority-badge.medium { background: rgba(88, 166, 255, 0.15); color: var(--accent); border-color: rgba(88, 166, 255, 0.3); }
    .priority-badge.low { background: rgba(139, 148, 158, 0.15); color: var(--text-secondary); border-color: rgba(139, 148, 158, 0.3); }
    
    .priority-badge.active {
      border-width: 2px;
    }
    
    .priority-badge:hover {
      opacity: 0.8;
    }
    
    /* Roadmap item enhancements */
    .roadmap-item-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 6px 0;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .roadmap-item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }
    
    .roadmap-item-tag {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      color: var(--text-secondary);
    }
    
    .roadmap-item-due {
      font-size: 10px;
      color: var(--text-secondary);
    }
    
    .roadmap-item-due.overdue {
      color: var(--danger);
      font-weight: 600;
    }
    
    .roadmap-item-due.soon {
      color: var(--warning);
    }
    
    /* Quick actions on hover */
    .roadmap-item-actions {
      display: none;
      gap: 4px;
      margin-top: 8px;
    }
    
    .roadmap-item:hover .roadmap-item-actions {
      display: flex;
    }
    
    .roadmap-action-btn {
      padding: 4px 8px;
      font-size: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .roadmap-action-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }


    /* Drag and Drop */
    .roadmap-item[draggable="true"] {
      cursor: grab;
    }
    
    .roadmap-item[draggable="true"]:active {
      cursor: grabbing;
    }
    
    .roadmap-item.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    
    .roadmap-column.drag-over {
      background: rgba(88, 166, 255, 0.1);
      border: 2px dashed var(--accent);
    }
    
    .column-items {
      min-height: 100px;
      transition: background 0.2s ease;
    }
    
    .column-items.drag-over {
      background: rgba(88, 166, 255, 0.05);
    }
    
    .drop-indicator {
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
      margin: 4px 0;
      display: none;
    }
    
    .drop-indicator.active {
      display: block;
    }

    .roadmap-filters {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .roadmap-filters select {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
    }

    .roadmap-filters select:focus {
      border-color: var(--accent);
      outline: none;
    }

    .workload-bar {
      display: flex;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      align-items: center;
    }

    .workload-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--bg-secondary);
      border-radius: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .workload-item .avatar {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
      color: #fff;
    }

    .workload-item .count {
      font-weight: 600;
      color: var(--text-primary);
    }

    .workload-item.high-load .count {
      color: var(--error);
    }

    .add-item-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-left: auto;
      transition: opacity 0.15s;
    }

    .add-item-btn:hover {
      opacity: 0.9;
    }

    .roadmap-board {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 16px;
      overflow-x: auto;
      min-height: 0;
    }

    .roadmap-column {
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }

    .column-header {
      padding: 12px 14px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }

    .column-items {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .roadmap-item {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .roadmap-item:hover {
      border-color: var(--accent);
    }

    .roadmap-item-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
    }

    .roadmap-item-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .roadmap-item-project {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .roadmap-item-priority {
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .roadmap-item-priority.critical { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    .roadmap-item-priority.high { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .roadmap-item-priority.medium { background: rgba(88, 166, 255, 0.2); color: var(--accent); }
    .roadmap-item-priority.low { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }

    .roadmap-item-assignee {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }

    .assignee-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }

    .assignee-avatar.human { background: var(--human-color); }
    .assignee-avatar.bot { background: var(--agent-color); }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--accent);
      outline: none;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .modal-actions button {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn-cancel {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-primary);
    }

    .btn-submit {
      background: var(--accent);
      border: none;
      color: #fff;
    }

    .btn-submit:hover,
    .btn-cancel:hover {
      opacity: 0.9;
    }

    /* Mobile Responsiveness */
    @media (max-width: 1024px) {
      main {
        display: flex !important;
        flex-direction: column;
        height: calc(100vh - 53px);
        overflow: hidden;
      }

      /* Hide side panels on mobile - show only chat */
      .panel:first-child,
      .panel:last-child {
        display: none !important;
      }

      /* Chat panel takes full space */
      .panel:nth-child(2) {
        display: flex !important;
        flex-direction: column;
        flex: 1;
        height: 100%;
        width: 100%;
        max-height: none;
      }

      /* Ensure chat content fills available space */
      .tab-content.active {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow-y: auto;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
      }

      .chat-input {
        flex-shrink: 0;
      }
    }

    @media (max-width: 768px) {
      main {
        display: flex !important;
        flex-direction: column;
        height: calc(100vh - 50px);
      }

      header {
        padding: 10px 12px;
      }

      header h1 {
        font-size: 16px;
      }
      
      /* Tabs header - stack on mobile */
      .tabs-header {
        flex-direction: column;
        align-items: stretch !important;
        padding: 8px 12px !important;
        gap: 8px;
      }
      
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        gap: 2px;
      }
      
      .tabs::-webkit-scrollbar {
        display: none;
      }
      
      .tab {
        padding: 10px 12px;
        font-size: 12px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      #messageCount {
        font-size: 11px;
        text-align: center;
        padding: 4px 8px;
        background: var(--bg-tertiary);
        border-radius: 4px;
        order: -1;
      }

      .panel-header {
        padding: 10px 12px;
        font-size: 12px;
      }

      .panel-content {
        padding: 6px;
      }

      /* Chat adjustments */
      .chat-messages {
        padding: 10px;
        gap: 8px;
      }

      .message {
        max-width: 95%;
      }

      .message-content {
        padding: 8px 10px;
        font-size: 13px;
      }

      .message-avatar {
        width: 28px;
        height: 28px;
        font-size: 10px;
      }

      /* Chat input - sticky at bottom */
      .chat-input {
        padding: 8px;
        gap: 6px;
      }

      .chat-input input[type="text"] {
        padding: 10px;
        font-size: 14px;
      }

      .chat-input button {
        padding: 10px 14px;
        font-size: 13px;
      }

      /* Agent cards */
      .agent-card {
        padding: 10px;
      }

      .agent-avatar {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }

      .agent-name {
        font-size: 13px;
      }

      /* Modal adjustments */
      .modal {
        width: 95%;
        max-width: none;
        margin: 10px;
        max-height: 90vh;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        font-size: 16px; /* Prevents iOS zoom on focus */
      }
    }


    /* Mobile Chat Fix - Ensure send button is always accessible */
    @media (max-width: 768px) {
      .chat-input {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        z-index: 100;
        padding: 12px;
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .chat-input input[type="text"] {
        flex: 1;
        min-width: 0;
        font-size: 16px !important; /* Prevent iOS zoom */
        -webkit-appearance: none;
        appearance: none;
      }
      
      .chat-input button#sendBtn {
        flex-shrink: 0;
        padding: 12px 16px;
        min-width: 60px;
        font-size: 14px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        cursor: pointer;
      }
      
      /* Ensure chat panel fills available space */
      .chat-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Touch-friendly adjustments */
    @media (pointer: coarse) {
      .chat-input button,
      .agent-card,
      .context-item,
      .modal button {
        min-height: 44px; /* iOS minimum touch target */
      }

      .chat-input input[type="text"] {
        min-height: 44px;
      }
    }

    /* Mobile Telemetry Optimizations */
    @media (max-width: 768px) {
      /* Telemetry header - stack controls vertically */
      .telemetry-header {
        flex-direction: column;
        gap: 12px;
        padding: 8px;
      }

      /* Fleet summary - horizontal scroll on small screens */
      .fleet-summary {
        display: flex;
        flex-wrap: nowrap;
        justify-content: flex-start;
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 4px 0;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
      }

      .fleet-summary::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }

      .fleet-stat {
        flex: 0 0 auto;
        min-width: 72px;
        max-width: none;
        padding: 8px 10px;
      }

      .fleet-stat-value {
        font-size: 18px;
        font-weight: 600;
      }

      .fleet-stat-label {
        font-size: 10px;
        white-space: nowrap;
      }

      .telemetry-controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        width: 100%;
      }

      .telemetry-controls button,
      .telemetry-controls .alert-indicator,
      .telemetry-controls .live-indicator {
        flex: 1;
        min-width: 60px;
        text-align: center;
        justify-content: center;
      }

      /* Health overview - single column on mobile */
      .health-overview.visible {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 12px;
      }

      .health-gauge {
        order: 1;
      }

      .gauge-circle {
        width: 120px;
        height: 120px;
      }

      .gauge-inner {
        width: 90px;
        height: 90px;
      }

      .gauge-score {
        font-size: 28px;
      }

      .health-breakdown {
        order: 2;
        grid-template-rows: repeat(2, 1fr);
        grid-template-columns: 1fr 1fr;
      }

      .breakdown-row {
        padding: 6px 10px;
      }

      .breakdown-icon {
        width: 24px;
        height: 24px;
        font-size: 12px;
      }

      .breakdown-value {
        font-size: 14px;
      }

      .health-alerts {
        order: 3;
      }

      /* Device cards - full width single column */
      .telemetry-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 8px;
      }

      .device-card {
        padding: 14px;
        width: 100%;
        box-sizing: border-box;
      }

      .device-header {
        margin-bottom: 12px;
      }

      .device-name {
        font-size: 15px;
        font-weight: 600;
      }

      .device-metrics {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .device-metric {
        padding: 8px;
      }

      .device-metric-label {
        font-size: 11px;
      }

      .device-metric-value {
        font-size: 16px;
        font-weight: 600;
      }

      /* Fleet map optimizations */
      .fleet-map-container {
        height: 200px;
      }

      .fleet-map {
        height: 100%;
      }

      /* Mobile Device List Table - scrollable wrapper */
      .device-list-container {
        margin: 8px;
        border-radius: 8px;
        overflow: hidden;
      }

      .device-list-header {
        flex-direction: column;
        gap: 8px;
        padding: 10px 12px;
      }

      .device-list-header h3 {
        font-size: 14px;
      }

      .device-list-controls {
        width: 100%;
        justify-content: space-between;
      }

      /* Table wrapper for horizontal scroll */
      .device-list-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -1px;
      }

      .device-list-table {
        font-size: 12px;
        min-width: 500px; /* Force scroll when needed */
        width: 100%;
      }

      .device-list-table th,
      .device-list-table td {
        padding: 10px 8px;
        font-size: 11px;
        white-space: nowrap;
      }

      .device-list-table .imei-cell {
        font-size: 10px;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Hide less important columns on mobile */
      .device-list-table th:nth-child(6),
      .device-list-table td:nth-child(6),
      .device-list-table th:nth-child(7),
      .device-list-table td:nth-child(7),
      .device-list-table th:nth-child(8),
      .device-list-table td:nth-child(8) {
        display: none;
      }

      .device-list-table .status-badge {
        padding: 3px 8px;
        font-size: 10px;
      }

      .device-list-table .health-score {
        padding: 3px 8px;
        font-size: 11px;
      }

      /* Empty state text */
      .device-list-table td[colspan] {
        text-align: center;
        padding: 20px;
        font-size: 13px;
        color: var(--text-secondary);
      }

      /* Device modal - full screen on mobile */
      .device-modal {
        width: 100%;
        max-width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
        margin: 0;
      }

      .device-modal-content {
        padding: 12px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .modal-info-grid {
        grid-template-columns: 1fr;
      }

      .modal-metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .chart-row {
        grid-template-columns: 1fr;
      }

      /* Roadmap mobile fixes */
    }
    
    /* Device List Table Styles */
    .device-list-container {
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      margin-top: 20px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .device-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }
    
    .device-list-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .device-list-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .device-list-controls select {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 6px 10px;
      color: var(--text-primary);
      font-size: 12px;
      cursor: pointer;
    }
    
    .view-toggle-btn {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 8px 12px;
      min-width: 44px;
      min-height: 44px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .view-toggle-btn:hover {
      background: var(--bg-tertiary);
    }

    /* Table wrapper for horizontal scrolling */
    .device-list-table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .device-list-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    .device-list-table th {
      background: var(--bg-tertiary);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .device-list-table th:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    .device-list-table td {
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      color: var(--text-primary);
      vertical-align: middle;
    }
    
    .device-list-table tr:hover {
      background: var(--bg-tertiary);
    }
    
    .device-list-table .imei-cell {
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }
    
    .device-list-table .vin-cell {
      font-family: monospace;
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .device-list-table .vehicle-cell {
      font-weight: 500;
    }
    
    .device-list-table .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .device-list-table .status-badge.active {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
    }
    
    .device-list-table .status-badge.parked {
      background: rgba(149, 165, 166, 0.2);
      color: #95a5a6;
    }
    
    .device-list-table .status-badge.moving {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
    }
    
    .device-list-table .health-score {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 12px;
    }
    
    .device-list-table .health-score.excellent {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
    }
    
    .device-list-table .health-score.good {
      background: rgba(241, 196, 15, 0.2);
      color: #f1c40f;
    }
    
    .device-list-table .health-score.warning {
      background: rgba(230, 126, 34, 0.2);
      color: #e67e22;
    }
    
    .device-list-table .health-score.critical {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }
    
    .device-list-table .action-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .device-list-table .action-btn:hover {
      opacity: 0.8;
    }
    
    .loading-row {
      text-align: center;
      padding: 24px;
      color: var(--text-secondary);
    }
  
    /* Roadmap Enhancements */
    .roadmap-stats {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    
    .roadmap-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 13px;
    }
    
    .roadmap-stat-value {
      font-weight: 700;
      font-size: 16px;
    }
    
    .roadmap-stat-value.backlog { color: var(--text-secondary); }
    .roadmap-stat-value.in-progress { color: var(--accent); }
    .roadmap-stat-value.review { color: var(--warning); }
    .roadmap-stat-value.done { color: var(--success); }
    
    .roadmap-progress {
      flex: 1;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .roadmap-progress-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
    }
    
    .roadmap-progress-segment {
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .roadmap-progress-segment.done { background: var(--success); }
    .roadmap-progress-segment.review { background: var(--warning); }
    .roadmap-progress-segment.in-progress { background: var(--accent); }
    
    .roadmap-progress-label {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }
    
    /* Priority filter badges */
    .priority-filters {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }
    
    .priority-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s;
    }
    
    .priority-badge.critical { background: rgba(248, 81, 73, 0.15); color: var(--danger); border-color: rgba(248, 81, 73, 0.3); }
    .priority-badge.high { background: rgba(210, 153, 34, 0.15); color: var(--warning); border-color: rgba(210, 153, 34, 0.3); }
    .priority-badge.medium { background: rgba(88, 166, 255, 0.15); color: var(--accent); border-color: rgba(88, 166, 255, 0.3); }
    .priority-badge.low { background: rgba(139, 148, 158, 0.15); color: var(--text-secondary); border-color: rgba(139, 148, 158, 0.3); }
    
    .priority-badge.active {
      border-width: 2px;
    }
    
    .priority-badge:hover {
      opacity: 0.8;
    }
    
    /* Roadmap item enhancements */
    .roadmap-item-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 6px 0;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .roadmap-item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }
    
    .roadmap-item-tag {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      color: var(--text-secondary);
    }
    
    .roadmap-item-due {
      font-size: 10px;
      color: var(--text-secondary);
    }
    
    .roadmap-item-due.overdue {
      color: var(--danger);
      font-weight: 600;
    }
    
    .roadmap-item-due.soon {
      color: var(--warning);
    }
    
    /* Quick actions on hover */
    .roadmap-item-actions {
      display: none;
      gap: 4px;
      margin-top: 8px;
    }
    
    .roadmap-item:hover .roadmap-item-actions {
      display: flex;
    }
    
    .roadmap-action-btn {
      padding: 4px 8px;
      font-size: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .roadmap-action-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }


    /* Drag and Drop */
    .roadmap-item[draggable="true"] {
      cursor: grab;
    }
    
    .roadmap-item[draggable="true"]:active {
      cursor: grabbing;
    }
    
    .roadmap-item.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    
    .roadmap-column.drag-over {
      background: rgba(88, 166, 255, 0.1);
      border: 2px dashed var(--accent);
    }
    
    .column-items {
      min-height: 100px;
      transition: background 0.2s ease;
    }
    
    .column-items.drag-over {
      background: rgba(88, 166, 255, 0.05);
    }
    
    .drop-indicator {
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
      margin: 4px 0;
      display: none;
    }
    
    .drop-indicator.active {
      display: block;
    }

    .roadmap-filters {
        flex-direction: column;
        gap: 8px;
      }
      
      .roadmap-filters select,
      .roadmap-filters button {
        width: 100%;
      }
      
      .roadmap-item {
        padding: 12px;
      }
      
      .roadmap-item-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      /* Metrics tab mobile */
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      
      /* Bottom navigation - ensure it stays visible */
      .mobile-nav {
        padding-bottom: env(safe-area-inset-bottom, 0);
      }
    }
    
    /* Very small screens (phones in portrait) */
    @media (max-width: 480px) {
      /* Very small screens - optimize for readability */
      .fleet-summary {
        justify-content: flex-start;
        gap: 6px;
      }

      .fleet-stat {
        min-width: 65px;
        max-width: none;
        padding: 6px 8px;
      }

      .fleet-stat-value {
        font-size: 16px;
      }

      .fleet-stat-label {
        font-size: 9px;
        letter-spacing: 0.3px;
      }

      .telemetry-grid {
        padding: 6px;
        gap: 8px;
      }

      .device-card {
        padding: 12px;
      }

      .device-name {
        font-size: 14px;
      }

      .device-metrics {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .device-metric {
        padding: 6px;
      }

      .device-metric-label {
        font-size: 10px;
      }

      .device-metric-value {
        font-size: 15px;
      }

      .modal-metrics-grid {
        grid-template-columns: 1fr 1fr;
      }

      .health-breakdown {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, 1fr);
      }

      /* Table - show fewer columns on tiny screens */
      .device-list-table th:nth-child(4),
      .device-list-table td:nth-child(4),
      .device-list-table th:nth-child(5),
      .device-list-table td:nth-child(5) {
        display: none;
      }
    }


    /* Enhanced Touch Targets */
    @media (pointer: coarse) {
      /* Minimum touch target sizes */
      button,
      .tab-btn,
      .agent-card,
      .device-card,
      .roadmap-item,
      select,
      input[type="text"],
      input[type="password"],
      .nav-btn {
        min-height: 44px;
      }
      
      /* Better tap feedback */
      button:active,
      .tab-btn:active,
      .agent-card:active,
      .device-card:active,
      .nav-btn:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
      
      /* Prevent text selection on tap */
      .tab-btn,
      .nav-btn,
      .agent-card,
      .device-card,
      button {
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
      }
      
      /* Larger hit areas for small buttons */
      .modal-close {
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .alert-indicator {
        min-height: 44px;
        padding: 8px 16px;
      }
      
      /* Better spacing for mobile interaction */
      .chat-messages .message {
        padding: 10px 14px;
        margin: 6px 0;
      }
    }
    
    /* Smooth scrolling everywhere */
    * {
      scroll-behavior: smooth;
    }
    
    /* Better focus states for accessibility */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    .tab-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Login overlay styles */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(13, 17, 23, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .login-modal {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      width: 100%;
      max-width: 380px;
      text-align: center;
    }

    .login-modal h2 {
      margin: 0 0 8px 0;
      color: var(--text-primary);
    }

    .login-modal .form-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .login-modal .form-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .login-modal .form-group input {
      width: 100%;
      padding: 10px 12px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .login-modal .btn-primary {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .login-modal .btn-primary:hover {
      background: #1f6feb;
    }




    /* Mobile Bottom Navigation - Professional Mobile Experience */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    .mobile-nav-inner {
      display: flex;
      height: 100%;
      max-width: 600px;
      margin: 0 auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .mobile-nav-inner::-webkit-scrollbar {
      display: none;
    }

    .mobile-nav-item {
      flex: 1;
      min-width: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 8px 4px;
      position: relative;
      flex-shrink: 0;
    }

    .mobile-nav-item:active {
      background: var(--bg-tertiary);
    }

    .mobile-nav-item.active {
      color: var(--accent);
    }

    .mobile-nav-item.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 3px;
      background: var(--accent);
      border-radius: 0 0 3px 3px;
    }

    .mobile-nav-icon {
      font-size: 22px;
      line-height: 1;
    }

    .mobile-nav-badge {
      position: absolute;
      top: 6px;
      right: calc(50% - 18px);
      background: var(--danger);
      color: white;
      font-size: 9px;
      font-weight: 700;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* Mobile panel visibility */
    @media (max-width: 1024px) {
      .mobile-nav {
        display: block;
      }

      body {
        padding-bottom: calc(64px + env(safe-area-inset-bottom, 0));
      }

      main {
        display: block !important;
        height: calc(100vh - 53px - 64px - env(safe-area-inset-bottom, 0)) !important;
        overflow: hidden;
      }

      .panel {
        display: none !important;
        height: 100% !important;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .panel.mobile-active {
        display: flex !important;
      }

      /* Header adjustments for mobile */
      header {
        padding: 8px 12px;
      }

      .logo {
        font-size: 14px;
        gap: 6px;
      }

      .logo svg {
        width: 22px;
        height: 22px;
      }

      .status-bar {
        gap: 8px;
        font-size: 11px;
      }

      .status-item:not(:first-child) {
        display: none;
      }

      /* Chat input optimization for mobile */
      .chat-input {
        padding: 10px 12px;
        gap: 8px;
      }

      .chat-input input[type="text"] {
        padding: 12px 14px;
        font-size: 16px; /* Prevents iOS zoom */
        border-radius: 20px;
      }

      .chat-input button {
        padding: 12px 16px;
        border-radius: 20px;
      }

      #usernameBtn, #imageBtn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      /* Context panel sections for mobile */
  
    /* Activity Feed Styles */
    .activity-feed {
      max-height: 200px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      background: var(--bg-secondary);
      margin-bottom: 6px;
      font-size: 12px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .activity-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .activity-icon.message { background: rgba(88, 166, 255, 0.2); }
    .activity-icon.task { background: rgba(63, 185, 80, 0.2); }
    .activity-icon.claim { background: rgba(210, 153, 34, 0.2); }
    .activity-icon.lock { background: rgba(248, 81, 73, 0.2); }
    .activity-icon.agent { background: rgba(163, 113, 247, 0.2); }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-text {
      color: var(--text-primary);
      line-height: 1.3;
    }

    .activity-text strong {
      color: var(--accent);
    }

    .activity-time {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .activity-empty {
      text-align: center;
      padding: 16px;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .context-section {
        margin-bottom: 12px;
      }

      .context-title {
        font-size: 12px;
        padding: 0 4px;
        margin-bottom: 6px;
      }

      .context-item {
        padding: 12px;
        margin-bottom: 6px;
      }

      /* Agent cards for mobile */
      .agent-card {
        padding: 14px;
        margin-bottom: 8px;
      }

      .agent-avatar {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }

      .agent-name {
        font-size: 14px;
      }

      .agent-task {
        font-size: 13px;
        white-space: normal;
        line-height: 1.4;
      }

      /* Messages optimization */
      .chat-messages {
        padding: 12px;
      }

      .message {
        max-width: 88%;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }

      .message-content {
        padding: 10px 12px;
        border-radius: 16px;
      }

      .message-text {
        font-size: 15px;
        line-height: 1.45;
      }

      /* Roadmap adjustments for mobile */
      .roadmap-board {
        grid-template-columns: 1fr !important;
        gap: 16px;
        padding: 12px;
      }

      .roadmap-column {
        min-height: auto;
      }

  
    /* Roadmap Enhancements */
    .roadmap-stats {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    
    .roadmap-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 13px;
    }
    
    .roadmap-stat-value {
      font-weight: 700;
      font-size: 16px;
    }
    
    .roadmap-stat-value.backlog { color: var(--text-secondary); }
    .roadmap-stat-value.in-progress { color: var(--accent); }
    .roadmap-stat-value.review { color: var(--warning); }
    .roadmap-stat-value.done { color: var(--success); }
    
    .roadmap-progress {
      flex: 1;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .roadmap-progress-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
    }
    
    .roadmap-progress-segment {
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .roadmap-progress-segment.done { background: var(--success); }
    .roadmap-progress-segment.review { background: var(--warning); }
    .roadmap-progress-segment.in-progress { background: var(--accent); }
    
    .roadmap-progress-label {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }
    
    /* Priority filter badges */
    .priority-filters {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }
    
    .priority-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s;
    }
    
    .priority-badge.critical { background: rgba(248, 81, 73, 0.15); color: var(--danger); border-color: rgba(248, 81, 73, 0.3); }
    .priority-badge.high { background: rgba(210, 153, 34, 0.15); color: var(--warning); border-color: rgba(210, 153, 34, 0.3); }
    .priority-badge.medium { background: rgba(88, 166, 255, 0.15); color: var(--accent); border-color: rgba(88, 166, 255, 0.3); }
    .priority-badge.low { background: rgba(139, 148, 158, 0.15); color: var(--text-secondary); border-color: rgba(139, 148, 158, 0.3); }
    
    .priority-badge.active {
      border-width: 2px;
    }
    
    .priority-badge:hover {
      opacity: 0.8;
    }
    
    /* Roadmap item enhancements */
    .roadmap-item-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 6px 0;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .roadmap-item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }
    
    .roadmap-item-tag {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      color: var(--text-secondary);
    }
    
    .roadmap-item-due {
      font-size: 10px;
      color: var(--text-secondary);
    }
    
    .roadmap-item-due.overdue {
      color: var(--danger);
      font-weight: 600;
    }
    
    .roadmap-item-due.soon {
      color: var(--warning);
    }
    
    /* Quick actions on hover */
    .roadmap-item-actions {
      display: none;
      gap: 4px;
      margin-top: 8px;
    }
    
    .roadmap-item:hover .roadmap-item-actions {
      display: flex;
    }
    
    .roadmap-action-btn {
      padding: 4px 8px;
      font-size: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .roadmap-action-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }


    /* Drag and Drop */
    .roadmap-item[draggable="true"] {
      cursor: grab;
    }
    
    .roadmap-item[draggable="true"]:active {
      cursor: grabbing;
    }
    
    .roadmap-item.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    
    .roadmap-column.drag-over {
      background: rgba(88, 166, 255, 0.1);
      border: 2px dashed var(--accent);
    }
    
    .column-items {
      min-height: 100px;
      transition: background 0.2s ease;
    }
    
    .column-items.drag-over {
      background: rgba(88, 166, 255, 0.05);
    }
    
    .drop-indicator {
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
      margin: 4px 0;
      display: none;
    }
    
    .drop-indicator.active {
      display: block;
    }

    .roadmap-filters {
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px 12px;
      }

      .roadmap-filters select {
        flex: 1;
        min-width: 120px;
      }

      .add-item-btn {
        width: 100%;
        margin-left: 0;
        margin-top: 4px;
      }

      /* Modal full-screen on mobile */
      .modal {
        width: 100%;
        height: 100%;
        max-height: 100vh;
        max-width: 100%;
        border-radius: 0;
        margin: 0;
      }

      .modal-overlay.active {
        align-items: flex-start;
      }

      /* Quick actions grid for mobile */
      .context-section > div[style*="grid-template-columns: 1fr 1fr"] {
        gap: 8px !important;
      }

      .context-section button.context-item {
        min-height: 60px;
        padding: 12px 8px !important;
      }
    }

    /* Extra small screens */
    @media (max-width: 380px) {
      .logo span:not(:first-child) {
        display: none;
      }

      .mobile-nav-item {
        font-size: 9px;
      }

      .mobile-nav-icon {
        font-size: 20px;
      }
    }


    /* ========== CRM STYLES ========== */

    /* CRM Header */
    .crm-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    .crm-stats {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 8px;
    }

    .crm-stat {
      flex: 0 0 auto;
      min-width: 80px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .crm-stat.prospect { border-color: #6366f1; background: rgba(99, 102, 241, 0.1); }
    .crm-stat.qualified { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
    .crm-stat.demo { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
    .crm-stat.customer { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }

    .crm-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      display: block;
    }

    .crm-stat.prospect .crm-stat-value { color: #6366f1; }
    .crm-stat.qualified .crm-stat-value { color: #f59e0b; }
    .crm-stat.demo .crm-stat-value { color: #3b82f6; }
    .crm-stat.customer .crm-stat-value { color: #22c55e; }

    .crm-stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .crm-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .crm-add-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.2s;
    }

    .crm-add-btn:hover {
      background: #4a90e0;
    }

    .crm-controls select,
    .crm-controls input {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 14px;
      color: var(--text-primary);
      font-size: 13px;
      min-width: 140px;
    }

    .crm-controls input {
      flex: 1;
      min-width: 200px;
    }

    /* CRM Pipeline View */
    .crm-pipeline {
      display: flex;
      gap: 12px;
      padding: 16px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      min-height: 400px;
      flex: 1;
      /* Contain the scrollable area */
      max-width: 100%;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .crm-pipeline::-webkit-scrollbar {
      height: 8px;
    }

    .crm-pipeline::-webkit-scrollbar-track {
      background: transparent;
    }

    .crm-pipeline::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .crm-pipeline::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    .pipeline-column {
      flex: 0 0 240px;
      min-width: 240px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 260px);
    }

    .pipeline-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 3px solid var(--border);
      border-radius: 8px 8px 0 0;
    }

    .pipeline-header.prospect { border-top-color: #6366f1; }
    .pipeline-header.qualified { border-top-color: #f59e0b; }
    .pipeline-header.demo { border-top-color: #3b82f6; }
    .pipeline-header.proposal { border-top-color: #8b5cf6; }
    .pipeline-header.customer { border-top-color: #22c55e; }

    .pipeline-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .pipeline-count {
      background: var(--bg-tertiary);
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .pipeline-cards {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pipeline-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pipeline-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .pipeline-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .pipeline-card-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .pipeline-card-value {
      font-size: 12px;
      color: var(--success);
      font-weight: 600;
    }

    .pipeline-card-contact {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .pipeline-card-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .pipeline-card-location {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pipeline-card-date {
      opacity: 0.7;
    }

    .pipeline-empty {
      text-align: center;
      padding: 24px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    /* CRM Shop Cards */
    .crm-shop-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .crm-shop-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Overdue card styling (NEW) */
    .crm-shop-card.card-overdue {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }

    /* Next action styling (NEW) */
    .crm-next-action {
      font-size: 11px;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .crm-next-action.overdue {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      font-weight: 500;
    }

    /* Health badge styling */
    .crm-health-badge {
      font-size: 10px !important;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .crm-shop-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 8px;
    }

    .crm-shop-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.3;
      flex: 1;
      word-break: break-word;
    }

    .crm-shop-value {
      font-size: 12px;
      color: var(--success);
      font-weight: 600;
      white-space: nowrap;
      background: rgba(34, 197, 94, 0.1);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .crm-shop-contact {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .crm-shop-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .crm-shop-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }

    .crm-assignee {
      color: var(--accent);
      font-weight: 500;
    }

    .crm-last-contact {
      color: var(--text-secondary);
    }

    .crm-empty-column {
      text-align: center;
      padding: 24px 12px;
      color: var(--text-secondary);
      font-size: 13px;
      font-style: italic;
    }

    /* CRM List View */
    .crm-list-view {
      padding: 16px;
    }

    .crm-list-table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .crm-list-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 800px;
    }

    .crm-list-table th {
      background: var(--bg-tertiary);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .crm-list-table th:hover {
      background: var(--bg-secondary);
    }

    .crm-list-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
    }

    .crm-list-table tr:hover {
      background: var(--bg-tertiary);
    }

    .crm-list-table .shop-name {
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
    }

    .crm-list-table .shop-name:hover {
      text-decoration: underline;
    }

    /* Stage Badges */
    .crm-stage-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .crm-stage-badge.prospect { background: rgba(99, 102, 241, 0.2); color: #6366f1; }
    .crm-stage-badge.qualified { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .crm-stage-badge.demo { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .crm-stage-badge.proposal { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .crm-stage-badge.customer { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .crm-stage-badge.churned { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    /* CRM Modals */
    .crm-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .crm-modal {
      background: var(--bg-secondary);
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
    }

    .crm-modal-large {
      max-width: 1000px;
    }

    .crm-modal-small {
      max-width: 450px;
    }

    .crm-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-tertiary);
    }

    .crm-modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary);
    }

    .crm-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .crm-modal-close:hover {
      color: var(--text-primary);
    }

    .crm-modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    /* CRM Forms */
    .crm-form-section {
      margin-bottom: 24px;
    }

    .crm-form-section h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .crm-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .crm-form-group {
      margin-bottom: 12px;
    }

    .crm-form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .crm-form-group input,
    .crm-form-group select,
    .crm-form-group textarea {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
      box-sizing: border-box;
    }

    .crm-form-group input:focus,
    .crm-form-group select:focus,
    .crm-form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .crm-form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .crm-form-group small.form-hint {
      display: block;
      font-size: 11px;
      color: var(--text-muted, #666);
      margin-top: 4px;
      font-style: italic;
    }

    .crm-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      margin-top: 16px;
    }

    .crm-btn-cancel {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      padding: 10px 20px;
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
    }

    .crm-btn-save {
      background: var(--accent);
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .crm-btn-save:hover {
      background: #4a90e0;
    }

    /* CRM Detail View */
    .crm-detail-body {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
    }

    .crm-detail-main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .crm-detail-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .crm-detail-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .crm-detail-card-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
    }

    .crm-detail-card-header h4 {
      margin: 0;
      font-size: 14px;
      color: var(--text-primary);
    }

    .crm-btn-edit,
    .crm-btn-add {
      background: none;
      border: 1px solid var(--border);
      padding: 4px 12px;
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 12px;
    }

    .crm-btn-edit:hover,
    .crm-btn-add:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .crm-detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--border);
      padding: 1px;
    }

    .crm-detail-item {
      background: var(--bg-tertiary);
      padding: 12px 16px;
    }

    .crm-detail-item.full-width {
      grid-column: 1 / -1;
    }

    .crm-detail-item label {
      display: block;
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .crm-detail-item span,
    .crm-detail-item a {
      font-size: 14px;
      color: var(--text-primary);
    }

    .crm-detail-item a {
      color: var(--accent);
      text-decoration: none;
    }

    .crm-detail-item a:hover {
      text-decoration: underline;
    }

    /* Quick Actions */
    .crm-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .crm-action-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .crm-action-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--accent);
    }

    .crm-action-btn.advance {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .crm-action-btn.advance:hover {
      background: #2da44e;
    }

    /* Activity Timeline */
    .crm-activity-timeline {
      padding: 16px;
      max-height: 400px;
      overflow-y: auto;
    }

    .crm-activity-item {
      display: flex;
      gap: 12px;
      padding-bottom: 16px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .crm-activity-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .crm-activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .crm-activity-icon.call { background: rgba(59, 130, 246, 0.2); }
    .crm-activity-icon.email { background: rgba(139, 92, 246, 0.2); }
    .crm-activity-icon.meeting { background: rgba(34, 197, 94, 0.2); }
    .crm-activity-icon.demo { background: rgba(245, 158, 11, 0.2); }
    .crm-activity-icon.note { background: rgba(99, 102, 241, 0.2); }
    .crm-activity-icon.proposal { background: rgba(236, 72, 153, 0.2); }

    .crm-activity-content {
      flex: 1;
      min-width: 0;
    }

    .crm-activity-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .crm-activity-type {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
    }

    .crm-activity-date {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .crm-activity-summary {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .crm-activity-empty {
      text-align: center;
      color: var(--text-secondary);
      font-size: 13px;
      padding: 20px;
    }

    /* CRM Mobile Responsive */
    @media (max-width: 768px) {
      .crm-header {
        padding: 12px;
      }

      .crm-stats {
        gap: 8px;
      }

      .crm-stat {
        min-width: 70px;
        padding: 10px 12px;
      }

      .crm-stat-value {
        font-size: 20px;
      }

      .crm-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .crm-controls input {
        min-width: auto;
      }

      .crm-pipeline {
        padding: 12px;
        gap: 8px;
      }

      .pipeline-column {
        flex: 0 0 220px;
        min-width: 220px;
      }

      .crm-modal {
        margin: 10px;
        max-height: calc(100vh - 20px);
      }

      .crm-modal-large {
        max-width: 100%;
      }

      .crm-form-row {
        grid-template-columns: 1fr;
      }

      .crm-detail-body {
        grid-template-columns: 1fr;
      }

      .crm-detail-sidebar {
        order: -1;
      }

      .crm-detail-grid {
        grid-template-columns: 1fr;
      }

      .crm-quick-actions {
        flex-direction: column;
      }

      .crm-action-btn {
        width: 100%;
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .crm-stat {
        min-width: 60px;
        padding: 8px 10px;
      }

      .crm-stat-value {
        font-size: 18px;
      }

      .crm-stat-label {
        font-size: 9px;
      }

      .pipeline-column {
        flex: 0 0 240px;
        min-width: 240px;
      }

      .crm-modal-header h3 {
        font-size: 16px;
      }
    }

    /* ========== END CRM STYLES ========== */

    /* ========== SALES ENGINEERING STYLES ========== */

    /* Sales View Layout */
    .sales-view.active {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    /* Sales Header */
    .sales-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      flex-wrap: wrap;
      gap: 12px;
    }

    .sales-stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .sales-stat {
      text-align: center;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .sales-stat.templates { border-color: var(--accent); background: rgba(88, 166, 255, 0.1); }
    .sales-stat.pending { border-color: var(--warning); background: rgba(210, 153, 34, 0.1); }
    .sales-stat.generated { border-color: var(--success); background: rgba(63, 185, 80, 0.1); }

    .sales-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .sales-stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .sales-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .sales-add-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }

    .sales-add-btn:hover {
      background: #4493e6;
    }

    .sales-controls input {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 6px;
      color: var(--text-primary);
      width: 200px;
    }

    /* Sales Content - 3 Column Layout */
    .sales-content {
      display: grid;
      grid-template-columns: 300px 1fr 250px;
      gap: 1px;
      background: var(--border);
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* Sales Chat Panel */
    .sales-chat-panel {
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sales-chat-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 14px;
    }

    .sales-agent-status {
      font-size: 12px;
      color: var(--success);
    }

    .sales-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sales-chat-msg {
      display: flex;
      gap: 10px;
    }

    .sales-chat-msg.user {
      flex-direction: row-reverse;
    }

    .sales-msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .sales-msg-content {
      background: var(--bg-secondary);
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 85%;
      font-size: 13px;
      line-height: 1.5;
    }

    .sales-msg-content strong {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--accent);
    }

    .sales-msg-content ul {
      margin: 8px 0;
      padding-left: 18px;
    }

    .sales-msg-content li {
      margin: 4px 0;
    }

    .sales-chat-msg.user .sales-msg-content {
      background: var(--accent);
      color: white;
    }

    .sales-chat-msg.user .sales-msg-avatar {
      background: var(--human-color);
    }

    .sales-chat-input {
      display: flex;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid var(--border);
    }

    .sales-chat-input input {
      flex: 1;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
    }

    .sales-chat-input button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Sales Doc Panel */
    .sales-doc-panel {
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sales-doc-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 14px;
    }

    .sales-doc-actions {
      display: flex;
      gap: 6px;
    }

    .sales-doc-actions button {
      background: var(--bg-tertiary);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .sales-doc-actions button:hover {
      background: var(--bg-secondary);
    }

    .sales-doc-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* Template Grid */
    .sales-template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }

    .sales-template-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sales-template-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .template-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    .template-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
    }

    .template-desc {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Sales Files Panel */
    .sales-files-panel {
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sales-files-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 14px;
    }

    .sales-files-header button {
      background: var(--bg-tertiary);
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .sales-folder-tree {
      padding: 8px;
      border-bottom: 1px solid var(--border);
    }

    .sales-folder {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .sales-folder:hover {
      background: var(--bg-secondary);
    }

    .sales-folder.active {
      background: var(--bg-tertiary);
      border: 1px solid var(--accent);
    }

    .folder-icon { font-size: 14px; }
    .folder-name { flex: 1; }
    .folder-count {
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .sales-files-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .sales-file-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .sales-file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      border: 1px solid transparent;
    }

    .sales-file-item:hover {
      background: var(--bg-secondary);
      border-color: var(--border);
    }

    .sales-file-icon { font-size: 16px; }
    .sales-file-name { flex: 1; }
    .sales-file-date {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Sales Mobile Responsive */
    @media (max-width: 768px) {
      .sales-content {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }

      .sales-chat-panel {
        max-height: 200px;
      }

      .sales-files-panel {
        max-height: 200px;
      }

      .sales-stats {
        flex-wrap: wrap;
        justify-content: center;
      }

      .sales-stat {
        min-width: 80px;
      }
    }

    /* ========== END SALES ENGINEERING STYLES ========== */

    /* Direct Messaging Styles */
    .dm-badge {
      position: relative;
      cursor: pointer;
      padding: 10px 14px;
      min-width: 44px;
      min-height: 44px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      border: none;
      color: var(--text-primary);
    }

    .dm-badge:hover {
      background: var(--bg-secondary);
    }

    .dm-badge-count {
      background: var(--danger);
      color: white;
      font-size: 10px;
      font-weight: 700;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
    }

    .dm-panel {
      position: fixed;
      top: 53px;
      right: 0;
      width: 360px;
      max-width: 100vw;
      height: calc(100vh - 53px);
      background: var(--bg-primary);
      border-left: 1px solid var(--border);
      z-index: 900;
      display: none;
      flex-direction: column;
    }

    .dm-panel.active {
      display: flex;
    }

    .dm-panel-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dm-panel-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .dm-close-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
    }

    .dm-close-btn:hover {
      color: var(--text-primary);
    }

    .dm-conversations {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .dm-convo-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      transition: all 0.15s;
    }

    .dm-convo-item:hover {
      border-color: var(--accent);
    }

    .dm-convo-item.unread {
      border-left: 3px solid var(--accent);
    }

    .dm-convo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .dm-convo-name {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dm-convo-time {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .dm-convo-preview {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dm-unread-badge {
      background: var(--accent);
      color: white;
      font-size: 10px;
      font-weight: 700;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .dm-chat-view {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .dm-chat-view.active {
      display: flex;
    }

    .dm-chat-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dm-back-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
    }

    .dm-back-btn:hover {
      color: var(--text-primary);
    }

    .dm-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dm-message {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
    }

    .dm-message.sent {
      align-self: flex-end;
      background: var(--accent);
      color: white;
    }

    .dm-message.received {
      align-self: flex-start;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
    }

    .dm-message-time {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .dm-message-attachment {
      margin-top: 8px;
    }

    .dm-message-attachment img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 8px;
      cursor: pointer;
    }

    .dm-chat-input {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .dm-chat-input input {
      flex: 1;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 10px 16px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .dm-chat-input input:focus {
      border-color: var(--accent);
      outline: none;
    }

    .dm-chat-input button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .dm-attach-btn {
      background: var(--bg-tertiary) !important;
      color: var(--text-primary) !important;
    }

    .dm-new-chat-btn {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin: 8px 0;
    }

    .dm-new-chat-btn:hover {
      opacity: 0.9;
    }

    .dm-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .dm-empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    /* New DM Modal */
    .dm-new-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .dm-new-modal.active {
      display: flex;
    }

    .dm-new-modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
    }

    .dm-user-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 16px 0;
    }

    .dm-user-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .dm-user-item:hover {
      background: var(--bg-tertiary);
    }

    .dm-user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .dm-user-avatar.agent {
      background: var(--accent);
    }

    .dm-user-avatar.human {
      background: var(--human-color);
    }

    @media (max-width: 768px) {
      .dm-panel {
        width: 100%;
        top: 0;
        height: 100vh;
        z-index: 1000;
      }
    }


    /* === FINAL POLISH === */
    
    /* Subtle glow effects */
    .metric-big {
      text-shadow: 0 0 20px currentColor;
    }

    /* Better button styles */
    button, .btn-primary, .btn-submit {
      transition: all 0.2s ease;
    }

    button:active, .btn-primary:active {
      transform: scale(0.98);
    }

    /* Improved scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* Selection color */
    ::selection {
      background: var(--accent);
      color: white;
    }

    /* Focus states for accessibility */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Smooth page transitions */
    .panel, .tab-content, .modal {
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    /* Loading shimmer effect */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .loading-shimmer {
      background: linear-gradient(
        90deg,
        var(--bg-secondary) 25%,
        var(--bg-tertiary) 50%,
        var(--bg-secondary) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    /* Better empty state styling */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      text-align: center;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 14px;
      margin: 0;
    }

    /* Card shine effect on hover */
    .agent-card::before,
    .device-card::before,
    .metrics-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.03),
        transparent
      );
      transition: left 0.5s ease;
      pointer-events: none;
    }

    .agent-card:hover::before,
    .device-card:hover::before,
    .metrics-card:hover::before {
      left: 100%;
    }

    .agent-card,
    .metrics-card {
      position: relative;
      overflow: visible;
    }
    
    .device-card {
      position: relative;
      /* overflow: visible to prevent clipping device content */
    }

    /* Notification badge pulse */
    .mobile-nav-badge,
    .alert-count {
      animation: badge-pulse 2s ease-in-out infinite;
    }

    @keyframes badge-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Status indicator improvements */
    .status-dot {
      box-shadow: 0 0 8px currentColor;
    }

    /* Panel header gradient */
    .panel-header {
      background: linear-gradient(180deg, var(--bg-secondary), var(--bg-primary));
    }

    /* Tab active indicator */
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
      border-radius: 2px 2px 0 0;
    }

    .tab-btn {
      position: relative;
    }

    /* Improve modal backdrop */
    .modal-overlay {
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    /* Better link styling in chat */
    .message-content a {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px dotted var(--accent);
    }

    .message-content a:hover {
      border-bottom-style: solid;
    }

    /* Header logo animation */
    .logo svg {
      transition: transform 0.3s ease;
    }

    .logo:hover svg {
      transform: rotate(10deg);
    }

    /* Keyboard shortcut hints */
    kbd {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      font-family: inherit;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      box-shadow: 0 1px 0 var(--border);
    }


  
    /* Telemetry content visibility fixes */
    #telemetryView {
      overflow-y: auto !important;
      padding: 16px;
    }

    #telemetryView .telemetry-grid {
      display: grid !important;
      min-height: 300px;
      margin-bottom: 20px;
    }

    #telemetryView .device-list-container {
      display: block !important;
      min-height: 200px;
      margin-bottom: 20px;
    }

    /* Make sure health overview doesn't take all space */
    .health-overview {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    </style>
</head>
<body>
  <!-- Loading Screen (shown while JS initializes) -->
  <div id="loadingScreen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0d1117; display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 16px;">
    <div style="width: 40px; height: 40px; border: 3px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div style="color: #8b949e; font-size: 14px;">Loading Piston Labs Hub...</div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }
    /* Enhanced table cell styles */
    .speed-cell {
      font-family: 'Monaco', 'Consolas', monospace;
      font-weight: 600;
      color: #4ade80;
    }
    .speed-cell .unit {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      font-weight: 400;
    }
    .battery-cell {
      font-family: 'Monaco', 'Consolas', monospace;
      font-weight: 600;
    }
    .battery-cell.good { color: #4ade80; }
    .battery-cell.warn { color: #fbbf24; }
    .battery-cell.low { color: #f87171; }
    .location-cell {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.7);
    }
    .time-cell {
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
    }
    .imei-cell {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85rem;
      color: #60a5fa;
    }
    .vehicle-cell {
      font-weight: 500;
    }

    
    /* ===== MOBILE RESPONSIVENESS FIX ===== */
    /* Ensure minimum readable font sizes on mobile devices */
    @media (max-width: 768px) {
      /* Increase base font size for readability */
      body {
        font-size: 14px !important;
      }

      /* Ensure minimum 12px for all text */
      .context-item-detail,
      .context-item-owner,
      .status-badge,
      .efficiency-label,
      .activity-time,
      .agent-task,
      .agent-meta,
      .input-label,
      .device-imei,
      .device-live-indicator,
      .device-metric-label,
      .token-stat-label,
      .agent-status-indicator,
      .roadmap-status,
      .roadmap-priority {
        font-size: 12px !important;
      }

      /* Slightly larger for important elements */
      .context-item-title,
      .agent-name,
      .message-header,
      .panel-header,
      .tab-btn,
      .device-name,
      .metric-value,
      .roadmap-title {
        font-size: 14px !important;
      }

      /* Message text should be very readable */
      .message-text {
        font-size: 15px !important;
        line-height: 1.5 !important;
      }

      /* Headers */
      .context-title,
      .panel-title,
      .section-title {
        font-size: 14px !important;
        font-weight: 600 !important;
      }

      /* Increase tap targets for touch */
      .tab-btn,
      .btn,
      button,
      .context-item[onclick],
      .quick-action-btn {
        min-height: 44px !important;
        padding: 12px !important;
      }

      /* Make inputs larger for touch */
      input, textarea, select {
        font-size: 16px !important; /* Prevents zoom on iOS */
        min-height: 44px !important;
        padding: 12px !important;
      }

      /* Improve spacing on mobile */
      .panel-content {
        padding: 12px !important;
      }

      .context-section {
        margin-bottom: 16px !important;
      }

      .context-item {
        padding: 12px !important;
        margin-bottom: 8px !important;
      }

      /* Device cards on mobile */
      .device-card {
        padding: 16px !important;
      }

      .device-metric {
        font-size: 12px !important;
      }

      .device-metric-value {
        font-size: 16px !important;
      }

      /* Agent cards on mobile */
      .agent-card {
        padding: 16px !important;
      }

      /* Task items on mobile */
      .task-item {
        padding: 14px !important;
      }

      /* Chat messages on mobile */
      .message {
        padding: 14px !important;
        margin-bottom: 10px !important;
      }

      /* Roadmap items on mobile */
      .roadmap-item {
        padding: 14px !important;
      }

      /* Metrics cards on mobile */
      .metric-card {
        padding: 16px !important;
        min-height: 100px !important;
      }

      .metric-number {
        font-size: 28px !important;
      }

      /* Fix navigation tabs on mobile */
      .tabs {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        padding: 8px !important;
      }

      .tab-btn {
        white-space: nowrap !important;
        font-size: 13px !important;
      }

      /* Context panel full width on mobile */
      .panel {
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 0 !important;
      }

      /* Better spacing for send button area */
      .input-area {
        padding: 12px !important;
        gap: 8px !important;
      }

      .send-btn {
        min-width: 80px !important;
        font-size: 14px !important;
      }
    }

    /* Extra small screens (iPhone SE, etc) */
    @media (max-width: 375px) {
      body {
        font-size: 13px !important;
      }

      .tab-btn {
        font-size: 12px !important;
        padding: 8px 12px !important;
      }

      .message-text {
        font-size: 14px !important;
      }

      .metric-number {
        font-size: 24px !important;
      }
    }
    /* ===== END MOBILE RESPONSIVENESS FIX ===== */

  </style>
  </div>

  <!-- Login Modal -->
  <div id="loginOverlay" class="login-overlay" style="display: none;">
    <div class="login-modal">
      <h2 id="authTitle"> Piston Labs Agent Hub</h2>
      <p id="authSubtitle" style="color: var(--text-secondary); margin-bottom: 20px;">Login required to access the coordination system</p>

      <!-- Login Form -->
      <form id="loginForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="loginUsername" placeholder="Enter username" required />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter password" required />
        </div>
        <div id="loginError" style="color: #f85149; margin-bottom: 12px; display: none;"></div>
        <button type="submit" class="btn-primary" style="width: 100%;">Login</button>
      </form>

      <!-- Register Form (hidden by default) -->
      <form id="registerForm" style="display: none;">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="regUsername" placeholder="Choose username (3-30 chars)" required minlength="3" maxlength="30" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="regPassword" placeholder="Choose password (min 8 chars)" required minlength="8" />
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="regPasswordConfirm" placeholder="Confirm password" required />
        </div>
        <div class="form-group">
          <label>Invite Code</label>
          <input type="text" id="regInviteCode" placeholder="Enter invite code" required />
        </div>
        <div id="registerError" style="color: #f85149; margin-bottom: 12px; display: none;"></div>
        <div id="registerSuccess" style="color: #3fb950; margin-bottom: 12px; display: none;"></div>
        <button type="submit" class="btn-primary" style="width: 100%;">Create Account</button>
      </form>

      <!-- Toggle between login/register -->
      <div style="margin-top: 16px; font-size: 13px; color: var(--text-secondary);">
        <span id="authToggleText">Don't have an account?</span>
        <a href="#" id="authToggleLink" style="color: var(--accent); text-decoration: none; margin-left: 4px;">Register</a>
      </div>
    </div>
  </div>


  <header>
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 6v6l4 2"/>
      </svg>
      Piston Labs Agent Hub
    </div>
    <div class="status-bar">
      <button class="dm-badge" onclick="toggleDMPanel()" title="Direct Messages">
         <span id="dmBadgeCount" class="dm-badge-count" style="display: none;">0</span>
      </button>
      <div class="status-item">
        <span class="status-dot" id="connectionDot"></span>
        <span id="connectionStatus">Connecting...</span>
      </div>
      <div class="status-item">
        <span id="agentCount">0</span> agents online
      </div>
      <div class="status-item">
        <span id="tokenEfficiency">--</span>% token efficiency
      </div>
    </div>
  </header>

  <main>
    <!-- Agents Panel -->
    <div class="panel">
      <div class="panel-header">
        <span>Team</span>
        <div style="display:flex;align-items:center;gap:8px;">
          <span id="activeCount">0 active</span>
          <button onclick="showAddAgentModal()" style="background:var(--accent);color:white;border:none;width:24px;height:24px;border-radius:4px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;" title="Add External Agent">+</button>
        </div>
      </div>
      <div class="panel-content" id="agentsList">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <p>No agents online</p>
        </div>
      </div>
    </div>

    <!-- Main Panel with Tabs -->
    <div class="panel">
      <div class="panel-header tabs-header">
        <div class="tabs">
          <button class="tab active" data-tab="chat" onclick="switchTab('chat')">Chat</button>
          <button class="tab" data-tab="roadmap" onclick="switchTab('roadmap')">Roadmap</button>
          <button class="tab" data-tab="telemetry" onclick="switchTab('telemetry')">Telemetry</button>
          <button class="tab" data-tab="metrics" onclick="switchTab('metrics')">Metrics</button>
          <button class="tab" data-tab="crm" onclick="switchTab('crm')">CRM</button>
          <button class="tab" data-tab="sales" onclick="switchTab('sales')">Sales Eng</button>
        </div>
        <span id="messageCount">0 messages</span>
      </div>

      <!-- Chat View -->
      <div class="tab-content active" id="chatView">
        <div class="chat-messages" id="chatMessages">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <p>No messages yet</p>
          </div>
        </div>
        <div id="imagePreview" style="display: none; padding: 8px; background: var(--bg-tertiary); margin: 0 16px 8px 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <img id="previewImg" style="max-height: 60px; border-radius: 4px;" />
            <span id="previewName" style="flex: 1; font-size: 12px;"></span>
            <button id="clearImage" style="background: var(--error); color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">Remove</button>
          </div>
        </div>
        <div class="chat-input">
          <button id="usernameBtn" style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; cursor: pointer; font-size: 12px;" title="Click to set username"></button>
          <input type="file" id="imageInput" accept="image/*" style="display: none;" />
          <button id="imageBtn" style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px;" title="Upload image"></button>
          <input type="text" id="messageInput" placeholder="Type a message... (@mention agents)" />
          <button id="sendBtn">Send</button>
        </div>
      </div>

      <!-- Roadmap View -->
      <div class="tab-content" id="roadmapView">
        <div class="roadmap-stats" id="roadmapStats">
          <div class="roadmap-stat">
            <span class="roadmap-stat-value backlog" id="roadmapBacklogCount">0</span>
            <span>Backlog</span>
          </div>
          <div class="roadmap-stat">
            <span class="roadmap-stat-value in-progress" id="roadmapInProgressCount">0</span>
            <span>In Progress</span>
          </div>
          <div class="roadmap-stat">
            <span class="roadmap-stat-value review" id="roadmapReviewCount">0</span>
            <span>Review</span>
          </div>
          <div class="roadmap-stat">
            <span class="roadmap-stat-value done" id="roadmapDoneCount">0</span>
            <span>Done</span>
          </div>
          <div class="roadmap-progress">
            <div class="roadmap-progress-bar">
              <div class="roadmap-progress-segment done" id="progressDone" style="width: 0%"></div>
              <div class="roadmap-progress-segment review" id="progressReview" style="width: 0%"></div>
              <div class="roadmap-progress-segment in-progress" id="progressInProgress" style="width: 0%"></div>
            </div>
            <div class="roadmap-progress-label">
              <span id="progressPercent">0%</span>
              <span>Complete</span>
            </div>
          </div>
        </div>
        <div class="roadmap-filters">
          <select id="projectFilter" onchange="fetchRoadmap()">
            <option value="">All Projects</option>
            <option value="piston-dashboard">Piston Dashboard (Consumer + Shop)</option>
            <option value="piston-hardware">Piston Hardware (IoT/Telemetry)</option>
            <option value="teltonika">Teltonika Fleet</option>
            <option value="gran-autismo">Gran Autismo Dashboard</option>
            <option value="agent-coord">Agent Coordination</option>
          </select>
          <select id="assigneeFilter" onchange="fetchRoadmap()">
            <option value="">All Assignees</option>
          </select>
          <select id="priorityFilter" onchange="fetchRoadmap()">
            <option value="">All Priorities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
          <select id="cycleFilter" onchange="fetchRoadmap()">
            <option value="">All Sprints</option>
          </select>
          <button class="add-item-btn" onclick="showAddRoadmapItem()">+ Add Item</button>
        </div>
        <div class="workload-bar" id="workloadBar">
          <!-- Populated by JS -->
        </div>
        <div class="roadmap-board" id="roadmapBoard">
          <div class="roadmap-column" data-status="backlog">
            <div class="column-header">Backlog</div>
            <div class="column-items" id="backlogItems"></div>
          </div>
          <div class="roadmap-column" data-status="in-progress">
            <div class="column-header">In Progress</div>
            <div class="column-items" id="inProgressItems"></div>
          </div>
          <div class="roadmap-column" data-status="review">
            <div class="column-header">Review</div>
            <div class="column-items" id="reviewItems"></div>
          </div>
          <div class="roadmap-column" data-status="done">
            <div class="column-header">Done</div>
            <div class="column-items" id="doneItems"></div>
          </div>
        </div>
      </div>

      <!-- Metrics View -->
      <div class="tab-content" id="metricsView">
        <div class="metrics-header">
          <h3 style="margin: 0; font-size: 16px;">System Analytics</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div class="live-indicator">
              <span class="live-dot"></span>
              <span>Live</span>
            </div>
            <div class="metrics-period-selector">
              <button class="period-btn active" onclick="setMetricsPeriod('24h')">24h</button>
              <button class="period-btn" onclick="setMetricsPeriod('7d')">7d</button>
              <button class="period-btn" onclick="setMetricsPeriod('30d')">30d</button>
            </div>
            <span id="metricsLoadTime" style="font-size: 11px; color: var(--text-secondary);">--</span>
            <button class="refresh-btn" onclick="fetchMetrics()"></button>
          </div>
        </div>
        <div class="metrics-grid" id="metricsGrid">
          <div class="metrics-card">
            <div class="metrics-card-title"><span class="card-icon"></span> Agents</div>
            <div class="metrics-card-content">
              <div class="metric-hero">
                <div class="metric-big" id="metricAgentsActive">0</div>
                <span class="metric-trend up" id="agentsTrend">+0</span>
              </div>
              <div class="metric-label">Active Now</div>
              <div class="metric-sparkline" id="agentsSparkline"></div>
              <div class="metric-row">
                <span>Total registered:</span>
                <span id="metricAgentsTotal">0</span>
              </div>
              <div class="metric-row">
                <span>Active (24h):</span>
                <span id="metricAgents24h">0</span>
              </div>
            </div>
          </div>
          <div class="metrics-card">
            <div class="metrics-card-title"><span class="card-icon"></span> Messages</div>
            <div class="metrics-card-content">
              <div class="metric-hero">
                <div class="metric-big" id="metricMessagesTotal">0</div>
                <span class="metric-trend neutral" id="messagesTrend">--</span>
              </div>
              <div class="metric-label">Total Messages</div>
              <div class="metric-sparkline" id="messagesSparkline"></div>
              <div class="metric-row">
                <span>Last 24h:</span>
                <span id="metricMessages24h">0</span>
              </div>
              <div class="metric-row">
                <span>Avg/day:</span>
                <span id="metricMessagesAvg">0</span>
              </div>
            </div>
          </div>
          <div class="metrics-card">
            <div class="metrics-card-title"><span class="card-icon"></span> Tasks</div>
            <div class="metrics-card-content">
              <div class="metric-hero">
                <div class="metric-big success" id="metricTasksRate">0%</div>
              </div>
              <div class="metric-label">Completion Rate</div>
              <div class="metric-progress-bar">
                <div class="metric-progress-fill success" id="tasksProgressBar" style="width: 0%"></div>
              </div>
              <div class="metric-row">
                <span> Completed:</span>
                <span id="metricTasksCompleted">0</span>
              </div>
              <div class="metric-row">
                <span> In Progress:</span>
                <span id="metricTasksProgress">0</span>
              </div>
              <div class="metric-row">
                <span> Total:</span>
                <span id="metricTasksTotal">0</span>
              </div>
            </div>
          </div>
          <div class="metrics-card">
            <div class="metrics-card-title"><span class="card-icon"></span> Coordination</div>
            <div class="metrics-card-content">
              <div class="metric-row">
                <span><span class="metric-row-icon lock"></span> Active Locks:</span>
                <span id="metricLocks">0</span>
              </div>
              <div class="metric-row">
                <span><span class="metric-row-icon claim"></span> Active Claims:</span>
                <span id="metricClaims">0</span>
              </div>
              <div class="metric-row">
                <span><span class="metric-row-icon handoff"></span> Pending Handoffs:</span>
                <span id="metricHandoffs">0</span>
              </div>
              <div class="metric-row">
                <span><span class="metric-row-icon workflow"></span> Workflow Runs:</span>
                <span id="metricWorkflows">0</span>
              </div>
            </div>
          </div>
          <div class="metrics-card">
            <div class="metrics-card-title"><span class="card-icon"></span> Memory</div>
            <div class="metrics-card-content">
              <div class="metric-hero">
                <div class="metric-big" id="metricMemoryTotal">0</div>
              </div>
              <div class="metric-label">Total Items Stored</div>
              <div class="metric-progress-bar">
                <div class="metric-progress-fill accent" id="memoryProgressBar" style="width: 50%"></div>
              </div>
              <div id="memoryCategories" style="margin-top: 8px;"></div>
            </div>
          </div>
          <div class="metrics-card">
            <div class="metrics-card-title"><span class="card-icon"></span> Fleet Telemetry</div>
            <div class="metrics-card-content">
              <div class="metric-hero">
                <div class="metric-big" id="metricDevices">0</div>
              </div>
              <div class="metric-label">Total Devices</div>
              <div class="metric-progress-bar">
                <div class="metric-progress-fill success" id="fleetActiveBar" style="width: 0%"></div>
              </div>
              <div class="metric-row">
                <span> Active (ignition on):</span>
                <span id="metricDevicesActive">0</span>
              </div>
              <div class="metric-row">
                <span> Avg Battery:</span>
                <span id="metricBattery">--</span>
              </div>
            </div>
          </div>
        </div>
        <div class="metrics-footer">
          <div class="metrics-footer-grid">
            <div class="top-contributors" id="topContributors">
              <div class="contributors-header">
                <span> Top Contributors</span>
                <span id="contributorPeriod">24h</span>
              </div>
              <div id="contributorsList">Loading...</div>
            </div>
            <div class="system-status-card">
              <div class="system-status-header">
                <span> System Status</span>
                <span class="status-badge online">Online</span>
              </div>
              <div class="system-status-content">
                <div class="status-row">
                  <span>Version:</span>
                  <span id="systemVersion">0.1.0</span>
                </div>
                <div class="status-row">
                  <span>API Endpoints:</span>
                  <span id="systemTools">21</span>
                </div>
                <div class="status-row">
                  <span>Uptime:</span>
                  <span id="systemUptime">--</span>
                </div>
                <div class="status-row">
                  <span>Redis:</span>
                  <span class="status-indicator online">Connected</span>
                </div>
                <div class="status-row">
                  <span>Last Deploy:</span>
                  <span id="lastDeploy">--</span>
                </div>
              </div>
            </div>
            <div class="activity-stream-card">
              <div class="activity-stream-header">
                <span> Live Activity</span>
                <span class="live-pulse"></span>
              </div>
              <div class="activity-stream" id="metricsActivityStream">
                <div class="activity-item">Waiting for activity...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Telemetry View -->
      <div class="tab-content" id="telemetryView" style="overflow-y: auto;">
        <div class="telemetry-header">
          <div class="fleet-summary" id="fleetSummary">
            <div class="fleet-stat">
              <span class="fleet-stat-value" id="fleetTotal">0</span>
              <span class="fleet-stat-label">Total</span>
            </div>
            <div class="fleet-stat active">
              <span class="fleet-stat-value" id="fleetActive">0</span>
              <span class="fleet-stat-label">Active</span>
            </div>
            <div class="fleet-stat moving">
              <span class="fleet-stat-value" id="fleetMoving">0</span>
              <span class="fleet-stat-label">Moving</span>
            </div>
            <div class="fleet-stat">
              <span class="fleet-stat-value" id="fleetAvgBattery">--</span>
              <span class="fleet-stat-label">Avg Battery</span>
            </div>
            <div class="fleet-stat health">
              <span class="fleet-stat-value" id="fleetHealthScore">--</span>
              <span class="fleet-stat-label">Health Score</span>
            </div>
          </div>
          <div class="telemetry-controls">
            <div class="live-indicator" id="liveIndicator">
              <span class="live-dot"></span>
              <span>Live</span>
              <span class="last-updated" id="telemetryLastUpdated">--</span>
            </div>
            <button class="map-btn" onclick="toggleMapView()" title="Toggle Fleet Map">Map</button>
            <button class="overview-toggle" onclick="toggleHealthOverview()" title="Toggle Health Overview">Overview</button>
            <div class="alert-indicator" id="alertIndicator" style="display: none;">
              <span class="alert-count" id="alertCount">0</span> Alerts
            </div>
            <button class="refresh-btn" id="telemetryRefreshBtn" onclick="fetchTelemetry()">Refresh</button>
          </div>
        </div>
        <div class="alerts-banner" id="alertsBanner" style="display: none;">
          <div class="alerts-list" id="alertsList"></div>
        </div>
        <div class="health-overview" id="healthOverview">
          <div class="health-gauge">
            <div class="gauge-circle" id="gaugeCircle" style="--score: 85;">
              <div class="gauge-inner">
                <span class="gauge-score" id="gaugeScore">--</span>
                <span class="gauge-label">Fleet Health</span>
              </div>
            </div>
          </div>
          <div class="health-breakdown">
            <div class="breakdown-row">
              <div class="breakdown-icon excellent"></div>
              <div class="breakdown-info">
                <div class="breakdown-label">Excellent (90-100)</div>
                <div class="breakdown-value" id="breakdownExcellent">0</div>
              </div>
              <div class="breakdown-bar">
                <div class="breakdown-bar-fill excellent" id="barExcellent" style="width: 0%"></div>
              </div>
            </div>
            <div class="breakdown-row">
              <div class="breakdown-icon good"></div>
              <div class="breakdown-info">
                <div class="breakdown-label">Good (70-89)</div>
                <div class="breakdown-value" id="breakdownGood">0</div>
              </div>
              <div class="breakdown-bar">
                <div class="breakdown-bar-fill good" id="barGood" style="width: 0%"></div>
              </div>
            </div>
            <div class="breakdown-row">
              <div class="breakdown-icon warning">!</div>
              <div class="breakdown-info">
                <div class="breakdown-label">Warning (50-69)</div>
                <div class="breakdown-value" id="breakdownWarning">0</div>
              </div>
              <div class="breakdown-bar">
                <div class="breakdown-bar-fill warning" id="barWarning" style="width: 0%"></div>
              </div>
            </div>
            <div class="breakdown-row">
              <div class="breakdown-icon critical"></div>
              <div class="breakdown-info">
                <div class="breakdown-label">Critical (0-49)</div>
                <div class="breakdown-value" id="breakdownCritical">0</div>
              </div>
              <div class="breakdown-bar">
                <div class="breakdown-bar-fill critical" id="barCritical" style="width: 0%"></div>
              </div>
            </div>
          </div>
          <div class="health-alerts">
            <div class="health-alerts-header">
              <span class="health-alerts-title">Recent Alerts</span>
              <span class="health-alerts-toggle" onclick="toggleAllAlerts()">View All</span>
            </div>
            <div id="healthAlertsList">
              <div class="no-alerts">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <span>All systems operational</span>
              </div>
            </div>
          </div>
        </div>

        <div class="fleet-map-container" id="fleetMapContainer">
          <div class="fleet-map" id="fleetMap">
            <div class="map-overlay">
              <span class="map-title">Fleet Locations</span>
              <span class="map-legend">
                <span class="legend-item active"><span class="legend-dot"></span> Active</span>
                <span class="legend-item parked"><span class="legend-dot"></span> Parked</span>
              </span>
            </div>
            <div class="map-devices" id="mapDevices"></div>
          </div>
          <button class="map-toggle" onclick="toggleMapView()">Toggle Map</button>
        </div>
        
        <!-- Device List View -->
        <div class="device-list-container" id="deviceListContainer">
          <div class="device-list-header">
            <h3> Enrolled Devices</h3>
            <div class="device-list-controls">
              <select id="deviceSortBy" onchange="sortDeviceList()">
                <option value="imei">Sort by IMEI</option>
                <option value="vin">Sort by VIN</option>
                <option value="name">Sort by Name</option>
                <option value="health">Sort by Health</option>
              </select>
              <button class="view-toggle-btn" onclick="toggleDeviceView()" title="Toggle Grid/List View">
                <span id="viewToggleIcon"></span>
              </button>
            </div>
          </div>
          <div class="device-list-table-wrapper">
            <table class="device-list-table" id="deviceListTable">
              <thead>
                <tr>
                  <th onclick="sortDeviceListBy('imei')">IMEI </th>
                  <th onclick="sortDeviceListBy('name')">Vehicle </th>
                  <th onclick="sortDeviceListBy('status')">Status</th>
                  <th onclick="sortDeviceListBy('speed')">Speed </th>
                  <th onclick="sortDeviceListBy('battery')">Battery </th>
                  <th>Location</th>
                  <th onclick="sortDeviceListBy('health')">Health </th>
                  <th>Last Seen</th>
                </tr>
              </thead>
              <tbody id="deviceListBody">
                <tr><td colspan="8" class="loading-row">Loading devices...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="telemetry-grid" id="telemetryGrid">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </svg>
            <p>Loading telemetry data...</p>
          </div>
        </div>
      </div>

      <!-- CRM View -->
      <div class="tab-content crm-view" id="crmView">
        <!-- CRM Header with Stats -->
        <div class="crm-header">
          <div class="crm-stats">
            <div class="crm-stat">
              <span class="crm-stat-value" id="crmTotalShops">0</span>
              <span class="crm-stat-label">Total Shops</span>
            </div>
            <div class="crm-stat prospect">
              <span class="crm-stat-value" id="crmProspects">0</span>
              <span class="crm-stat-label">Prospects</span>
            </div>
            <div class="crm-stat qualified">
              <span class="crm-stat-value" id="crmQualified">0</span>
              <span class="crm-stat-label">Qualified</span>
            </div>
            <div class="crm-stat demo">
              <span class="crm-stat-value" id="crmDemo">0</span>
              <span class="crm-stat-label">Demo</span>
            </div>
            <div class="crm-stat customer">
              <span class="crm-stat-value" id="crmCustomers">0</span>
              <span class="crm-stat-label">Customers</span>
            </div>
            <div class="crm-stat health-indicator" id="healthIndicator" style="border-color: #22c55e;">
              <span class="crm-stat-value" id="crmAvgHealth">--</span>
              <span class="crm-stat-label">Avg Health</span>
            </div>
            <div class="crm-stat overdue-indicator" style="border-color: #ef4444; background: rgba(239, 68, 68, 0.1);">
              <span class="crm-stat-value" style="color: #ef4444;" id="crmOverdue">0</span>
              <span class="crm-stat-label">Overdue</span>
            </div>
          </div>
          <div class="crm-controls">
            <button class="crm-add-btn" onclick="openAddShopModal()">+ Add Shop</button>
            <select id="crmViewMode" onchange="switchCrmView(this.value)">
              <option value="pipeline">Pipeline View</option>
              <option value="list">List View</option>
            </select>
            <input type="text" id="crmSearchInput" placeholder="Search shops..." oninput="filterShops(this.value)">
          </div>
        </div>

        <!-- Pipeline View -->
        <div class="crm-pipeline" id="crmPipeline">
          <div class="pipeline-column" data-stage="prospect">
            <div class="pipeline-header prospect">
              <span class="pipeline-title">Prospect</span>
              <span class="pipeline-count" id="pipelineProspectCount">0</span>
            </div>
            <div class="pipeline-cards" id="pipelineProspect"></div>
          </div>
          <div class="pipeline-column" data-stage="qualified">
            <div class="pipeline-header qualified">
              <span class="pipeline-title">Qualified</span>
              <span class="pipeline-count" id="pipelineQualifiedCount">0</span>
            </div>
            <div class="pipeline-cards" id="pipelineQualified"></div>
          </div>
          <div class="pipeline-column" data-stage="demo">
            <div class="pipeline-header demo">
              <span class="pipeline-title">Demo Scheduled</span>
              <span class="pipeline-count" id="pipelineDemoCount">0</span>
            </div>
            <div class="pipeline-cards" id="pipelineDemo"></div>
          </div>
          <div class="pipeline-column" data-stage="proposal">
            <div class="pipeline-header proposal">
              <span class="pipeline-title">Proposal</span>
              <span class="pipeline-count" id="pipelineProposalCount">0</span>
            </div>
            <div class="pipeline-cards" id="pipelineProposal"></div>
          </div>
          <div class="pipeline-column" data-stage="customer">
            <div class="pipeline-header customer">
              <span class="pipeline-title">Customer</span>
              <span class="pipeline-count" id="pipelineCustomerCount">0</span>
            </div>
            <div class="pipeline-cards" id="pipelineCustomer"></div>
          </div>
        </div>

        <!-- List View (hidden by default) -->
        <div class="crm-list-view" id="crmListView" style="display: none;">
          <div class="crm-list-table-wrapper">
            <table class="crm-list-table" id="crmListTable">
              <thead>
                <tr>
                  <th onclick="sortCrmList('name')">Shop Name</th>
                  <th onclick="sortCrmList('stage')">Stage</th>
                  <th onclick="sortCrmList('contact')">Contact</th>
                  <th onclick="sortCrmList('location')">Location</th>
                  <th onclick="sortCrmList('bays')">Bays</th>
                  <th onclick="sortCrmList('lastContact')">Last Contact</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="crmListBody">
                <tr><td colspan="7" class="loading-row">Loading shops...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sales Engineering View -->
      <div class="tab-content sales-view" id="salesView">
        <!-- Sales Eng Header with Stats -->
        <div class="sales-header">
          <div class="sales-stats">
            <div class="sales-stat">
              <span class="sales-stat-value" id="salesTotalDocs">0</span>
              <span class="sales-stat-label">Documents</span>
            </div>
            <div class="sales-stat templates">
              <span class="sales-stat-value" id="salesTemplates">5</span>
              <span class="sales-stat-label">Templates</span>
            </div>
            <div class="sales-stat pending">
              <span class="sales-stat-value" id="salesPending">0</span>
              <span class="sales-stat-label">Pending Tasks</span>
            </div>
            <div class="sales-stat generated">
              <span class="sales-stat-value" id="salesGenerated">0</span>
              <span class="sales-stat-label">Generated Today</span>
            </div>
          </div>
          <div class="sales-controls">
            <button class="sales-add-btn" onclick="openNewDocModal()">+ New Document</button>
            <input type="text" id="salesSearchInput" placeholder="Search files..." oninput="filterSalesFiles(this.value)">
          </div>
        </div>

        <!-- Main Sales Content: Chat + Files -->
        <div class="sales-content">
          <!-- Left: Agent Chat for Eli -->
          <div class="sales-chat-panel">
            <div class="sales-chat-header">
              <span> Sales Assistant</span>
              <span class="sales-agent-status"> Online</span>
            </div>
            <div class="sales-chat-messages" id="salesChatMessages">
              <div class="sales-chat-msg assistant">
                <div class="sales-msg-avatar"></div>
                <div class="sales-msg-content">
                  <strong>Sales Assistant</strong>
                  <p>Hi Eli! I'm here to help with sales engineering tasks. I can:</p>
                  <ul>
                    <li>Generate pitch decks and proposals</li>
                    <li>Create customer-specific materials</li>
                    <li>Draft follow-up emails</li>
                    <li>Help prepare for demos</li>
                  </ul>
                  <p>What would you like to work on?</p>
                </div>
              </div>
            </div>
            <div class="sales-chat-input">
              <input type="text" id="salesChatInput" placeholder="Ask me to generate a document..." onkeypress="if(event.key==='Enter')sendSalesChat()" />
              <button onclick="sendSalesChat()">Send</button>
            </div>
          </div>

          <!-- Center: Document Generator/Preview -->
          <div class="sales-doc-panel">
            <div class="sales-doc-header">
              <span> Document Generator</span>
              <div class="sales-doc-actions">
                <button onclick="previewDoc()" title="Preview"></button>
                <button onclick="downloadDoc()" title="Download"></button>
                <button onclick="saveDoc()" title="Save"></button>
              </div>
            </div>
            <div class="sales-doc-content" id="salesDocContent">
              <div class="sales-template-grid">
                <div class="sales-template-card" onclick="selectTemplate('pitch-deck')">
                  <div class="template-icon"></div>
                  <div class="template-name">Pitch Deck</div>
                  <div class="template-desc">Investor & partner presentations</div>
                </div>
                <div class="sales-template-card" onclick="selectTemplate('proposal')">
                  <div class="template-icon"></div>
                  <div class="template-name">Proposal</div>
                  <div class="template-desc">Customer proposals & quotes</div>
                </div>
                <div class="sales-template-card" onclick="selectTemplate('one-pager')">
                  <div class="template-icon"></div>
                  <div class="template-name">One-Pager</div>
                  <div class="template-desc">Product overview sheets</div>
                </div>
                <div class="sales-template-card" onclick="selectTemplate('email')">
                  <div class="template-icon"></div>
                  <div class="template-name">Email Template</div>
                  <div class="template-desc">Follow-up & outreach emails</div>
                </div>
                <div class="sales-template-card" onclick="selectTemplate('demo-script')">
                  <div class="template-icon"></div>
                  <div class="template-name">Demo Script</div>
                  <div class="template-desc">Product demo talking points</div>
                </div>
                <div class="sales-template-card" onclick="selectTemplate('case-study')">
                  <div class="template-icon"></div>
                  <div class="template-name">Case Study</div>
                  <div class="template-desc">Customer success stories</div>
                </div>
                <div class="sales-template-card" onclick="selectTemplate('other')">
                  <div class="template-icon"></div>
                  <div class="template-name">Other Document</div>
                  <div class="template-desc">Custom documents & notes</div>
                </div>
                <div class="sales-template-card blank" onclick="openBlankEditor()">
                  <div class="template-icon"></div>
                  <div class="template-name">Blank Document</div>
                  <div class="template-desc">Start from scratch</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: File Browser -->
          <div class="sales-files-panel">
            <div class="sales-files-header">
              <span> My Files</span>
              <button onclick="createNewFolder()" title="New Folder"></button>
            </div>
            <div class="sales-folder-tree" id="salesFolderTree">
              <div class="sales-folder" data-folder="proposals">
                <span class="folder-icon"></span>
                <span class="folder-name">Proposals</span>
                <span class="folder-count" id="folderProposalsCount">0</span>
              </div>
              <div class="sales-folder" data-folder="pitch-decks">
                <span class="folder-icon"></span>
                <span class="folder-name">Pitch Decks</span>
                <span class="folder-count" id="folderPitchCount">0</span>
              </div>
              <div class="sales-folder" data-folder="emails">
                <span class="folder-icon"></span>
                <span class="folder-name">Email Templates</span>
                <span class="folder-count" id="folderEmailsCount">0</span>
              </div>
              <div class="sales-folder" data-folder="one-pagers">
                <span class="folder-icon"></span>
                <span class="folder-name">One-Pagers</span>
                <span class="folder-count" id="folderOnePagersCount">0</span>
              </div>
              <div class="sales-folder" data-folder="demos">
                <span class="folder-icon"></span>
                <span class="folder-name">Demo Scripts</span>
                <span class="folder-count" id="folderDemosCount">0</span>
              </div>
              <div class="sales-folder" data-folder="case-studies">
                <span class="folder-icon"></span>
                <span class="folder-name">Case Studies</span>
                <span class="folder-count" id="folderCaseStudiesCount">0</span>
              </div>
              <div class="sales-folder" data-folder="other">
                <span class="folder-icon"></span>
                <span class="folder-name">Other</span>
                <span class="folder-count" id="folderOtherCount">0</span>
              </div>
            </div>
            <div class="sales-files-list" id="salesFilesList">
              <div class="sales-file-empty">Select a folder to view files</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Context Panel -->
    <div class="panel">
      <div class="panel-header">
        <span>Active Context</span>
        <span id="contextUpdateTime" style="font-size: 10px; font-weight: normal; opacity: 0.7;">--</span>
      </div>
      <div class="panel-content" id="contextPanel" onclick="handleContextPanelClick(event)">
        <div class="context-section">
          <div class="context-title"> System Stats</div>
          <div id="systemStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
            <div class="context-item" style="text-align: center; padding: 8px;">
              <div style="font-size: 20px; font-weight: 700; color: var(--accent);" id="statAgents">0</div>
              <div style="font-size: 10px; color: var(--text-secondary);">Agents</div>
            </div>
            <div class="context-item" style="text-align: center; padding: 8px;">
              <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="statMessages">0</div>
              <div style="font-size: 10px; color: var(--text-secondary);">Messages</div>
            </div>
          </div>
        </div>
        <div class="context-section">
          <div class="context-title"> Recent Activity</div>
          <div class="activity-feed" id="activityFeed">
            <div class="activity-empty">Loading activity...</div>
          </div>
        </div>
        <div class="context-section">
          <div class="context-title"> Quick Actions</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
            <button onclick="quickCreateTask()" class="context-item" style="cursor: pointer; border: none; text-align: center; padding: 10px 6px; font-size: 11px;">
              <div style="font-size: 16px; margin-bottom: 2px;"></div>
              New Task
            </button>
            <button onclick="quickClaimFile()" class="context-item" style="cursor: pointer; border: none; text-align: center; padding: 10px 6px; font-size: 11px;">
              <div style="font-size: 16px; margin-bottom: 2px;"></div>
              Claim File
            </button>
            <button onclick="quickUpdateStatus()" class="context-item" style="cursor: pointer; border: none; text-align: center; padding: 10px 6px; font-size: 11px;">
              <div style="font-size: 16px; margin-bottom: 2px;"></div>
              My Status
            </button>
            <button onclick="quickCreateZone()" class="context-item" style="cursor: pointer; border: none; text-align: center; padding: 10px 6px; font-size: 11px;">
              <div style="font-size: 16px; margin-bottom: 2px;"></div>
              New Zone
            </button>
          </div>
        </div>
        <div class="context-section">
          <div class="context-title"> Claims <span id="claimsCount" style="opacity: 0.6; font-weight: normal;">(0)</span></div>
          <div id="claimsList"></div>
        </div>
        <div class="context-section">
          <div class="context-title"> Zones <span id="zonesCount" style="opacity: 0.6; font-weight: normal;">(0)</span></div>
          <div id="zonesList"></div>
        </div>
        <div class="context-section">
          <div class="context-title"> Locks <span id="locksCount" style="opacity: 0.6; font-weight: normal;">(0)</span></div>
          <div id="locksList"></div>
        </div>
        <div class="context-section">
          <div class="context-title"> Tasks <span id="tasksCount" style="opacity: 0.6; font-weight: normal;">(0)</span></div>
          <div id="tasksList"></div>
        </div>
        <div class="context-section">
          <div class="context-title"> Planned Features <span id="featuresCount" style="opacity: 0.6; font-weight: normal;">(0)</span></div>
          <div id="plannedFeaturesList"></div>
        </div>
        <div class="context-section">
          <div class="context-title"> Token Efficiency</div>
          <div class="efficiency-bar">
            <div class="efficiency-fill" id="efficiencyBar" style="width: 0%"></div>
          </div>
          <div class="efficiency-label">
            <span>Context optimized</span>
            <span id="efficiencyPercent">0%</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Roadmap Item Modal -->
  <div class="modal-overlay" id="addItemModal">
    <div class="modal">
      <div class="modal-title">Add Roadmap Item</div>
      <form id="addItemForm">
        <div class="form-group">
          <label for="itemTitle">Title</label>
          <input type="text" id="itemTitle" required placeholder="Feature name or task" />
        </div>
        <div class="form-group">
          <label for="itemDescription">Description</label>
          <textarea id="itemDescription" placeholder="Details about this item..."></textarea>
        </div>
        <div class="form-group">
          <label for="itemProject">Project</label>
          <select id="itemProject" required>
            <option value="piston-dashboard">Piston Dashboard (Consumer + Shop)</option>
            <option value="piston-hardware">Piston Hardware (IoT/Telemetry)</option>
            <option value="teltonika">Teltonika Fleet</option>
            <option value="gran-autismo">Gran Autismo Dashboard</option>
            <option value="agent-coord">Agent Coordination</option>
          </select>
        </div>
        <div class="form-group">
          <label for="itemPriority">Priority</label>
          <select id="itemPriority">
            <option value="medium">Medium</option>
            <option value="low">Low</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        <div class="form-group">
          <label for="itemAssignee">Assignee</label>
          <select id="itemAssignee">
            <option value="">Unassigned</option>
          </select>
        </div>
        <div class="form-group">
          <label for="itemStatus">Status</label>
          <select id="itemStatus">
            <option value="backlog">Backlog</option>
            <option value="planned">Planned</option>
            <option value="in-progress">In Progress</option>
            <option value="review">Review</option>
            <option value="done">Done</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="hideAddRoadmapItem()">Cancel</button>
          <button type="submit" class="btn-submit">Add Item</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add External Agent Modal -->
  <div class="modal-overlay" id="addAgentModal" style="display:none;">
    <div class="modal" style="max-width:450px;">
      <div class="modal-title">Add External Agent</div>
      <form id="addAgentForm">
        <div class="form-group">
          <label for="agentName">Agent Name *</label>
          <input type="text" id="agentName" required placeholder="e.g., Team B Helper Agent" />
        </div>
        <div class="form-group">
          <label for="agentDescription">Description</label>
          <textarea id="agentDescription" placeholder="What does this agent do?" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label for="agentCapabilities">Capabilities (comma-separated)</label>
          <input type="text" id="agentCapabilities" placeholder="e.g., testing, code-review, deployment" />
        </div>
        <div class="form-group">
          <label for="agentContact">Contact Info (optional)</label>
          <input type="text" id="agentContact" placeholder="e.g., Slack: @team-b" />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="hideAddAgentModal()">Cancel</button>
          <button type="submit" class="btn-submit">Add Agent</button>
        </div>
      </form>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
        <div style="text-align:center;margin-bottom:12px;color:var(--text-secondary);font-size:12px;">OR</div>
        <button onclick="generateAgentInvite()" style="width:100%;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;">
          Generate Invite Link
        </button>
        <div id="inviteLinkResult" style="display:none;margin-top:12px;padding:12px;background:var(--surface);border-radius:6px;">
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;">Share this link:</div>
          <input type="text" id="inviteLinkInput" readonly style="width:100%;padding:8px;background:var(--background);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px;" />
          <button onclick="copyInviteLink()" style="margin-top:8px;padding:6px 12px;background:var(--accent);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Copy Link</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin + '/api';
    const POLL_INTERVAL = 2000;
    
    // Username persistence - check localStorage or generate random
    let USERNAME = localStorage.getItem('agent-hub-username') || 'human-' + Math.random().toString(36).substr(2, 6);
    const HUMAN_ID = USERNAME;
    
    // Global pending image for upload
    let pendingImage = null;
    
    // Allow user to set their name
    function setUsername(name) {
      if (name && name.trim()) {
        USERNAME = name.trim();
        localStorage.setItem('agent-hub-username', USERNAME);
        alert('Username set to: ' + USERNAME);
        return true;
      }
      return false;
    }
    
    // Expose globally so it can be called from console or UI
    window.setUsername = setUsername;

    let lastMessageTime = null;
    let tokensSaved = 0;
    let totalTokens = 0;


    // Cache for agent display names (id -> name)
    const agentNameCache = {};

    function getAgentDisplayName(authorId) {
      // Check cache first
      if (agentNameCache[authorId]) {
        return agentNameCache[authorId];
      }
      // Return the ID if no cached name (will be updated on next agent fetch)
      return authorId;
    }
    
    // Authentication functions
    let isAuthenticated = false;

    async function checkSession() {
      try {
        const res = await fetch(API_BASE + '/auth/session', {
          credentials: 'include'
        });
        const data = await res.json();
        if (data.authenticated === true && data.session?.username) { USERNAME = data.session.username; localStorage.setItem('agent-hub-username', USERNAME); } return data.authenticated === true;
      } catch (e) {
        console.error('Session check failed:', e);
        return false;
      }
    }

    async function login(username, password) {
      try {
        const res = await fetch(API_BASE + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) {
          isAuthenticated = true;
          // Update USERNAME to the logged-in user's actual username
          if (data.session?.username) {
            USERNAME = data.session.username;
            localStorage.setItem('agent-hub-username', USERNAME);
          }
          return { success: true };
        }
        return { success: false, error: data.error || 'Login failed' };
      } catch (e) {
        return { success: false, error: 'Network error' };
      }
    }

    async function register(username, password, inviteCode) {
      try {
        const res = await fetch(API_BASE + '/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password, inviteCode })
        });
        const data = await res.json();
        if (data.success) {
          return { success: true, user: data.user };
        }
        return { success: false, error: data.error || 'Registration failed' };
      } catch (e) {
        return { success: false, error: 'Network error' };
      }
    }

    function showLoginModal() {
      document.getElementById('loginOverlay').style.display = 'flex';
    }

    function hideLoginModal() {
      document.getElementById('loginOverlay').style.display = 'none';
    }

    function setupLoginForm() {
      const form = document.getElementById('loginForm');
      const errorDiv = document.getElementById('loginError');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorDiv.style.display = 'none';

        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        const result = await login(username, password);
        if (result.success) {
          hideLoginModal();
          init();
        } else {
          errorDiv.textContent = result.error;
          errorDiv.style.display = 'block';
        }
      });
    }

    function setupRegisterForm() {
      const form = document.getElementById('registerForm');
      const errorDiv = document.getElementById('registerError');
      const successDiv = document.getElementById('registerSuccess');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const passwordConfirm = document.getElementById('regPasswordConfirm').value;
        const inviteCode = document.getElementById('regInviteCode').value;

        if (password !== passwordConfirm) {
          errorDiv.textContent = 'Passwords do not match';
          errorDiv.style.display = 'block';
          return;
        }

        const result = await register(username, password, inviteCode);
        if (result.success) {
          successDiv.textContent = 'Account created! You can now login.';
          successDiv.style.display = 'block';
          form.reset();
          setTimeout(() => toggleAuthMode(), 2000);
        } else {
          errorDiv.textContent = result.error;
          errorDiv.style.display = 'block';
        }
      });
    }

    function toggleAuthMode() {
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const title = document.getElementById('authTitle');
      const subtitle = document.getElementById('authSubtitle');
      const toggleText = document.getElementById('authToggleText');
      const toggleLink = document.getElementById('authToggleLink');

      if (loginForm.style.display !== 'none') {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        title.textContent = ' Create Account';
        subtitle.textContent = 'Register to join the Piston Labs Agent Hub';
        toggleText.textContent = 'Already have an account?';
        toggleLink.textContent = 'Login';
      } else {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        title.textContent = ' Piston Labs Agent Hub';
        subtitle.textContent = 'Login required to access the coordination system';
        toggleText.textContent = "Don't have an account?";
        toggleLink.textContent = 'Register';
      }

      // Clear error messages
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
      document.getElementById('registerSuccess').style.display = 'none';
    }

    function setupAuthToggle() {
      document.getElementById('authToggleLink').addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthMode();
      });
    }

// Initialize
    async function init() {
      console.log('Init starting...');
      updateConnectionStatus(true);
      try {
        await Promise.all([
          fetchAgents().catch(e => console.error('fetchAgents failed:', e)),
          fetchMessages().catch(e => console.error('fetchMessages failed:', e)),
          fetchContext().catch(e => console.error('fetchContext failed:', e))
        ]);
        console.log('Init fetch complete');
      } catch (e) {
        console.error('Init error:', e);
      }

      // Start polling
      setInterval(poll, POLL_INTERVAL);

      // Setup event listeners
      const sendBtn = document.getElementById('sendBtn');
      const messageInput = document.getElementById('messageInput');
      const usernameBtn = document.getElementById('usernameBtn');
      
      console.log('sendBtn:', sendBtn);
      console.log('messageInput:', messageInput);
      
      // Username button - click to change name
      usernameBtn.addEventListener('click', function() {
        const newName = prompt('Enter your username:', USERNAME);
        if (newName && newName.trim()) {
          USERNAME = newName.trim();
          localStorage.setItem('agent-hub-username', USERNAME);
          usernameBtn.textContent = USERNAME.substring(0, 2).toUpperCase();
          usernameBtn.title = 'Logged in as: ' + USERNAME;
        }
      });
      // Show current username initial
      usernameBtn.textContent = USERNAME.substring(0, 2).toUpperCase();
      usernameBtn.title = 'Logged in as: ' + USERNAME + ' (click to change)';

      // Image upload handling
      const imageBtn = document.getElementById('imageBtn');
      const imageInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      const previewName = document.getElementById('previewName');
      const clearImage = document.getElementById('clearImage');

      imageBtn.addEventListener('click', () => imageInput.click());

      imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 500000) {
          alert('Image too large. Max 500KB allowed.');
          imageInput.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = (evt) => {
          pendingImage = { data: evt.target.result, name: file.name };
          previewImg.src = evt.target.result;
          previewName.textContent = file.name;
          imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });

      clearImage.addEventListener('click', () => {
        pendingImage = null;
        imageInput.value = '';
        imagePreview.style.display = 'none';
      });
      
      sendBtn.addEventListener('click', function(e) {
        console.log('Send button clicked');
        e.preventDefault();
        sendMessage();
      });
      
      // Touch support for mobile
      sendBtn.addEventListener('touchend', function(e) {
        console.log('Send button touched');
        e.preventDefault();
        e.stopPropagation();
        sendMessage();
      }, { passive: false });
      
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          console.log('Enter pressed');
          e.preventDefault();
          sendMessage();
        }
      });
      
      console.log('Event listeners attached');

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // Ctrl/Cmd + shortcuts
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'k': // Focus message input
              e.preventDefault();
              document.getElementById('messageInput').focus();
              break;
            case 't': // Quick create task
              e.preventDefault();
              quickCreateTask();
              break;
            case 'l': // Quick claim file
              e.preventDefault();
              quickClaimFile();
              break;
          }
        }

        // Number keys for tabs (without modifier)
        if (e.key >= '1' && e.key <= '3' && !e.ctrlKey && !e.metaKey && !e.altKey) {
          const tabs = ['chat', 'roadmap', 'telemetry', 'metrics', 'messages'];
          const idx = parseInt(e.key) - 1;
          if (tabs[idx]) switchTab(tabs[idx]);
        }
      });

      console.log('Keyboard shortcuts: Ctrl+K=focus, Ctrl+T=task, Ctrl+L=claim, 1-3=tabs');
    }

    async function poll() {
      try {
        await Promise.all([
          fetchAgents(),
          fetchNewMessages(),
          fetchContext()
        ]);
        updateConnectionStatus(true);
      } catch (err) {
        updateConnectionStatus(false);
      }
    }

    function updateConnectionStatus(connected) {
      const dot = document.getElementById('connectionDot');
      const status = document.getElementById('connectionStatus');
      if (connected) {
        dot.classList.remove('offline');
        status.textContent = 'Connected';
      } else {
        dot.classList.add('offline');
        status.textContent = 'Disconnected';
      }
    }

    async function fetchAgents() {
      try {
        console.log('Fetching agents from:', API_BASE + '/agents?includeOffline=true');
        const [agentsRes, externalRes] = await Promise.all([
          fetch(API_BASE + '/agents?includeOffline=true'),
          fetch(API_BASE + '/external-agents')
        ]);

        const data = agentsRes.ok ? await agentsRes.json() : { agents: [], offlineAgents: [] };
        const externalData = externalRes.ok ? await externalRes.json() : { agents: [] };

        console.log('Agents fetched:', data.agents?.length || 0, 'External:', externalData.agents?.length || 0);
        renderAgents(data.agents || [], data.offlineAgents || [], externalData.agents || []);
      } catch (e) {
        console.error('fetchAgents error:', e);
      }
    }

    // Corporate-style agent hierarchy tiers
    const HIERARCHY = {
      leadership: { ids: ['autonomous-agent', 'claude-code', 'claude-desktop'], title: 'Core Leadership', icon: '', color: '#a371f7' },
      senior: { ids: ['opus-agent', 'piston-lead'], title: 'Technical Leads', icon: '', color: '#58a6ff' },
      engineers: { ids: ['piston-dev-1', 'piston-dev-2'], title: 'Development Team', icon: '', color: '#3fb950' },
      specialists: { roles: ['specialist', 'architect', 'designer', 'ux', 'memory', 'trainer'], title: 'Specialists', icon: '', color: '#d29922' },
      taskWorkers: { title: 'Task Workers', icon: '', color: '#8b949e' }
    };

    const ROLE_TAGS = {
      'orchestrator': { label: 'ORCH', color: '#a371f7' },
      'developer': { label: 'DEV', color: '#58a6ff' },
      'frontend': { label: 'FE', color: '#3fb950' },
      'backend': { label: 'BE', color: '#f85149' },
      'protege': { label: 'TRAINEE', color: '#8b949e' },
      'tech-lead': { label: 'LEAD', color: '#58a6ff' }
    };

    function getAgentTier(a) {
      const id = (a.id || '').toLowerCase();
      const role = (a.role || '').toLowerCase();
      const roles = a.roles || [];
      if (HIERARCHY.leadership.ids.includes(id)) return 'leadership';
      if (HIERARCHY.senior.ids.includes(id)) return 'senior';
      if (HIERARCHY.engineers.ids.includes(id)) return 'engineers';
      if (HIERARCHY.specialists.roles.some(r => role.includes(r) || roles.some(ar => ar.toLowerCase().includes(r)))) return 'specialists';
      return 'taskWorkers';
    }

    function getRoleTags(a) {
      const tags = [];
      const role = (a.role || '').toLowerCase();
      for (const [k, v] of Object.entries(ROLE_TAGS)) { if (role.includes(k)) { tags.push(v); break; } }
      return tags.slice(0, 2);
    }

    function renderAgents(agents, offlineAgents = [], externalAgents = []) {
      const container = document.getElementById('agentsList');
      const countEl = document.getElementById('activeCount');
      const totalEl = document.getElementById('agentCount');
      countEl.textContent = agents.length + ' active';
      totalEl.textContent = agents.length + offlineAgents.length + externalAgents.length;

      // Update agent name cache
      [...agents, ...offlineAgents].forEach(a => {
        if (a.name && a.name !== a.id) {
          agentNameCache[a.id] = a.name;
        }
      });

      if (agents.length === 0 && externalAgents.length === 0) {
        container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><p>No agents online</p></div>`;
        return;
      }

      const grouped = { leadership: [], senior: [], engineers: [], specialists: [], taskWorkers: [] };
      agents.forEach(a => grouped[getAgentTier(a)].push(a));

      const renderCard = (a, tier) => {
        const cfg = HIERARCHY[tier];
        const tags = getRoleTags(a).map(t => `<span style="background:${t.color}22;color:${t.color};padding:1px 4px;border-radius:3px;font-size:9px;font-weight:600;margin-left:4px;">${t.label}</span>`).join('');
        const lastSeen = a.lastSeen ? timeAgo(new Date(a.lastSeen)) : '';
        const isRecent = a.lastSeen && (Date.now() - new Date(a.lastSeen).getTime()) < 60000; // Within 1 min
        const pulseStyle = isRecent ? 'animation: pulse 2s infinite;' : '';
        return `<div class="agent-card" style="border-left:3px solid ${cfg.color};"><div class="agent-header"><div class="agent-avatar" style="background:${cfg.color};${pulseStyle}">${getInitials(a.id)}</div><span class="agent-name">${a.name||a.id}${tags}</span><span class="agent-status ${a.status}">${a.status}</span></div><div class="agent-task">${a.currentTask||a.workingOn||'Idle'}</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;"><span style="font-size:10px;color:var(--text-secondary);">${a.spawnedBy?' '+a.spawnedBy:''}</span><button onclick="openDMWithAgent('${a.id}', 'agent')" style="background:var(--accent);color:white;border:none;padding:2px 8px;border-radius:4px;font-size:10px;cursor:pointer;">DM</button><span style="font-size:9px;color:${isRecent?'var(--success)':'var(--text-secondary)'};">${lastSeen?' '+lastSeen:''}</span></div></div>`;
      };

      let html = '';
      for (const [k, cfg] of Object.entries(HIERARCHY)) {
        if (grouped[k].length > 0) {
          html += `<div class="context-title" style="margin:${k==='leadership'?'4px':'12px'} 0 4px 0;">${cfg.icon} ${cfg.title}</div>`;
          html += grouped[k].map(a => renderCard(a, k)).join('');
        }
      }
      // External agents section
      if (externalAgents.length > 0) {
        html += `<div class="context-title" style="margin:16px 0 8px 0;"> External Agents (${externalAgents.length})</div>`;
        html += externalAgents.map(a => {
          const caps = (a.capabilities || []).slice(0, 3).join(', ');
          const sourceIcon = a.source === 'invited' ? '' : '';
          const connType = a.connectionType === 'active' ? 'active' : 'display';
          return `<div class="agent-card" style="border-left:3px solid #f0883e;">
            <div class="agent-header">
              <div class="agent-avatar" style="background:#f0883e;"></div>
              <span class="agent-name">${a.name}</span>
              <span class="agent-status" style="color:#f0883e;">${connType}</span>
            </div>
            <div class="agent-task" style="color:var(--text-secondary);">${a.description || 'External agent'}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <span style="font-size:9px;color:var(--text-secondary);">${sourceIcon} Added by ${a.owner}</span>
              ${caps ? `<span style="font-size:9px;color:var(--accent);">${caps}</span>` : ''}
            </div>
          </div>`;
        }).join('');
      }

      // Offline agents section
      if (offlineAgents.length > 0) {
        html += `<div class="context-title" style="margin:16px 0 8px 0; opacity: 0.7;"> Offline (${offlineAgents.length})</div>`;
        html += offlineAgents.slice(0, 10).map(a => {
          const lastSeen = a.lastSeen ? timeAgo(new Date(a.lastSeen)) : 'Unknown';
          const task = a.currentTask || a.workingOn || 'N/A';
          const truncatedTask = task.length > 60 ? task.substring(0, 60) + '...' : task;
          return `<div class="agent-card" style="border-left:3px solid #484f58; opacity: 0.6;">
            <div class="agent-header">
              <div class="agent-avatar" style="background:#484f58;">${getInitials(a.id)}</div>
              <span class="agent-name">${a.name||a.id}</span>
              <span class="agent-status" style="color:#484f58;">offline</span>
            </div>
            <div class="agent-task" style="color:var(--text-secondary);">${truncatedTask}</div>
            <div style="font-size:9px;color:var(--text-secondary);margin-top:4px;">Last seen: ${lastSeen}</div>
          </div>`;
        }).join('');
        if (offlineAgents.length > 10) {
          html += `<div style="text-align:center;padding:8px;font-size:11px;color:var(--text-secondary);">+${offlineAgents.length - 10} more offline agents</div>`;
        }
      }

      container.innerHTML = html;
    }

    async function fetchMessages() {
      try {
        console.log('Fetching messages from:', API_BASE + '/chat?limit=50');
        const res = await fetch(API_BASE + '/chat?limit=50');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        console.log('Messages fetched:', data.messages?.length || 0);
        renderMessages(data.messages || []);
        if (data.messages && data.messages.length > 0) {
          // API returns newest first, so messages[0] is the most recent
          lastMessageTime = data.messages[0].timestamp;
        }
      } catch (e) {
        console.error('fetchMessages error:', e);
      }
    }

    async function fetchNewMessages() {
      if (!lastMessageTime) return fetchMessages();
      const res = await fetch(API_BASE + '/chat?since=' + encodeURIComponent(lastMessageTime));
      const data = await res.json();
      if (data.messages && data.messages.length > 0) {
        appendMessages(data.messages);
        // API returns newest first, so messages[0] is the most recent
        lastMessageTime = data.messages[0].timestamp;
      }
    }

    function renderMessages(messages) {
      const container = document.getElementById('chatMessages');
      const countEl = document.getElementById('messageCount');

      countEl.textContent = messages.length + ' messages';

      if (messages.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <p>No messages yet</p>
          </div>`;
        return;
      }

      // Reverse messages so newest are at the bottom (API returns newest first)
      const chronological = [...messages].reverse();
      container.innerHTML = chronological.map(m => renderMessage(m)).join('');
      container.scrollTop = container.scrollHeight;
    }

    function appendMessages(messages) {
      const container = document.getElementById('chatMessages');
      const countEl = document.getElementById('messageCount');

      // Remove empty state if present
      const emptyState = container.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      // Get existing message IDs to prevent duplicates
      const existingIds = new Set(
        Array.from(container.querySelectorAll('.message[data-id]'))
          .map(el => el.dataset.id)
      );

      // Only append messages that don't already exist (reverse to maintain order)
      [...messages].reverse().forEach(m => {
        if (!existingIds.has(m.id)) {
          container.insertAdjacentHTML('beforeend', renderMessage(m));
        }
      });

      const total = container.querySelectorAll('.message').length;
      countEl.textContent = total + ' messages';
      container.scrollTop = container.scrollHeight;

      // Update token efficiency (messages are compressed)
      totalTokens += messages.reduce((sum, m) => sum + m.message.length / 4, 0);
      tokensSaved += messages.reduce((sum, m) => sum + m.message.length / 8, 0);
      updateEfficiency();
    }

    function renderMessage(m) {
      const isOwn = m.author === HUMAN_ID;
      const isHuman = m.authorType === 'human';
      const time = new Date(m.timestamp).toLocaleTimeString();
      
      let imageHtml = '';
      if (m.imageData) {
        imageHtml = `<div class="message-image"><img src="${m.imageData}" alt="${m.imageName || 'image'}" style="max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer; margin-top: 8px;" onclick="window.open(this.src, '_blank')"/></div>`;
      }

      return `
        <div class="message ${isOwn ? 'own' : ''}" data-id="${m.id}">
          <div class="message-avatar ${isHuman ? 'human' : ''}">${getInitials(getAgentDisplayName(m.author))}</div>
          <div class="message-content">
            <div class="message-author">${getAgentDisplayName(m.author)}</div>
            ${m.message ? `<div class="message-text">${escapeHtml(m.message)}</div>` : ''}
            ${imageHtml}
            <div class="message-time">${time}</div>
          </div>
        </div>
      `;
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const message = input.value.trim();

      console.log('sendMessage called, message:', message);

      // Check if we have an image or message
      if (!message && !pendingImage) {
        console.log('Empty message and no image, returning');
        return;
      }

      // Disable button while sending
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        console.log('Sending to:', API_BASE + '/chat');
        const payload = {
          author: HUMAN_ID,
          authorType: 'human',
          message: message || ''
        };

        // Add image if present
        if (pendingImage) {
          payload.imageData = pendingImage.data;
          payload.imageName = pendingImage.name;
        }

        const res = await fetch(API_BASE + '/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        console.log('Response status:', res.status);
        const responseData = await res.json();

        if (!res.ok) {
          throw new Error(responseData.error || 'Failed to send');
        }

        input.value = '';

        // Clear pending image
        if (pendingImage) {
          pendingImage = null;
          document.getElementById('imageInput').value = '';
          document.getElementById('imagePreview').style.display = 'none';
        }

        // Append just our message optimistically (no full re-fetch needed)
        if (responseData.timestamp) {
          const msgObj = {
            id: responseData.id,
            author: HUMAN_ID,
            authorType: 'human',
            message: message,
            timestamp: responseData.timestamp
          };
          if (payload.imageData) {
            msgObj.imageData = payload.imageData;
            msgObj.imageName = payload.imageName;
          }
          appendMessages([msgObj]);
          lastMessageTime = responseData.timestamp;
        }
      } catch (err) {
        console.error('Send failed:', err);
        alert('Failed to send message: ' + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    }

    // Quick Action Functions
    async function quickCreateTask() {
      const title = prompt('Task title:');
      if (!title) return;
      const description = prompt('Task description (optional):') || '';
      
      try {
        const res = await fetch(API_BASE + '/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            description,
            status: 'todo',
            priority: 'medium',
            createdBy: USERNAME
          })
        });
        if (res.ok) {
          alert('Task created!');
          fetchContext();
        } else {
          alert('Failed to create task');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function quickClaimFile() {
      const filePath = prompt('File path to claim:');
      if (!filePath) return;
      const description = prompt('What are you doing with this file?') || 'Editing';
      
      try {
        const res = await fetch(API_BASE + '/claims', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            what: filePath,
            by: USERNAME,
            description
          })
        });
        const data = await res.json();
        if (res.ok) {
          alert('File claimed!');
          fetchContext();
        } else {
          alert(data.message || data.error || 'Failed to claim file');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function quickUpdateStatus() {
      const status = prompt('Your current status (active/idle/waiting):') || 'active';
      const task = prompt('What are you working on?') || '';
      
      try {
        const res = await fetch(API_BASE + '/agents/' + encodeURIComponent(USERNAME) + '/status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            status,
            currentTask: task,
            authorType: 'human'
          })
        });
        if (res.ok) {
          alert('Status updated!');
          fetchAgents();
        } else {
          alert('Failed to update status');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function quickCreateZone() {
      const zoneId = prompt('Zone ID (e.g., frontend, backend):');
      if (!zoneId) return;
      const path = prompt('Directory path for this zone:') || '/';
      const description = prompt('Zone description (optional):') || '';
      
      try {
        const res = await fetch(API_BASE + '/zones', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            zoneId,
            owner: USERNAME,
            path,
            description
          })
        });
        if (res.ok) {
          alert('Zone created!');
          fetchContext();
        } else {
          alert('Failed to create zone');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }


    // Activity Feed Functions
    let activityItems = [];

    function addActivity(type, text, author) {
      const item = {
        type,
        text,
        author,
        time: new Date()
      };
      activityItems.unshift(item);
      if (activityItems.length > 20) activityItems.pop();
      renderActivityFeed();
    }

    function renderActivityFeed() {
      const feed = document.getElementById('activityFeed');
      if (!feed) return;

      if (activityItems.length === 0) {
        feed.innerHTML = '<div class="activity-empty">No recent activity</div>';
        return;
      }

      feed.innerHTML = activityItems.slice(0, 8).map(item => {
        const iconClass = {
          message: 'message',
          task: 'task',
          claim: 'claim',
          lock: 'lock',
          agent: 'agent'
        }[item.type] || 'message';

        const icon = {
          message: '',
          task: '',
          claim: '',
          lock: '',
          agent: ''
        }[item.type] || '';

        const timeAgo = formatActivityTime(item.time);

        return '<div class="activity-item">' +
          '<div class="activity-icon ' + iconClass + '">' + icon + '</div>' +
          '<div class="activity-content">' +
            '<div class="activity-text">' + item.text + '</div>' +
            '<div class="activity-time">' + timeAgo + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function formatActivityTime(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return 'just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      return Math.floor(diff / 86400) + 'd ago';
    }

    // Hook into existing functions to track activity
    const originalSendMessage = typeof sendMessage === 'function' ? sendMessage : null;

    async function fetchContext() {
      const fetchSafe = async (url) => {
        try {
          const res = await fetch(url);
          if (!res.ok) return { claims: [], zones: [], locks: [], tasks: [], agents: [], count: 0 };
          return await res.json();
        } catch {
          return { claims: [], zones: [], locks: [], tasks: [], agents: [], count: 0 };
        }
      };

      const [claims, zones, locks, tasks, agents, features] = await Promise.all([
        fetchSafe(API_BASE + '/claims'),
        fetchSafe(API_BASE + '/zones'),
        fetchSafe(API_BASE + '/locks'),
        fetchSafe(API_BASE + '/tasks'),
        fetchSafe(API_BASE + '/agents'),
        fetchSafe(API_BASE + '/planned-features')
      ]);

      // Update system stats
      const agentCount = (agents.agents || []).length;
      const msgCount = document.querySelectorAll('.message').length;
      document.getElementById('statAgents').textContent = agentCount;
      document.getElementById('statMessages').textContent = msgCount;
      document.getElementById('contextUpdateTime').textContent = new Date().toLocaleTimeString();

      // Update counts
      const claimsList = claims.claims || [];
      const zonesList = zones.zones || [];
      const locksList = locks.locks || [];
      const tasksList = (tasks.tasks || []).filter(t => t.status !== 'done');
      const featuresList = features.features || [];
      
      document.getElementById('claimsCount').textContent = '(' + claimsList.length + ')';
      document.getElementById('zonesCount').textContent = '(' + zonesList.length + ')';
      document.getElementById('locksCount').textContent = '(' + locksList.length + ')';
      document.getElementById('tasksCount').textContent = '(' + tasksList.length + ')';
      document.getElementById('featuresCount').textContent = '(' + featuresList.length + ')';

      // Populate activity feed with recent items
      if (activityItems.length === 0) {
        // Initialize with current context data
        claimsList.slice(0, 3).forEach(c => {
          activityItems.push({
            type: 'claim',
            text: '<strong>' + c.by + '</strong> claimed ' + c.what,
            time: new Date(c.claimedAt || Date.now())
          });
        });
        locksList.slice(0, 3).forEach(l => {
          activityItems.push({
            type: 'lock',
            text: '<strong>' + l.lockedBy + '</strong> locked ' + l.resourcePath,
            time: new Date(l.lockedAt || Date.now())
          });
        });
        tasksList.slice(0, 3).forEach(t => {
          activityItems.push({
            type: 'task',
            text: '<strong>' + (t.createdBy || 'Someone') + '</strong> created task: ' + t.title,
            time: new Date(t.createdAt || Date.now())
          });
        });
        (agents.agents || []).filter(a => a.status === 'active').slice(0, 2).forEach(a => {
          activityItems.push({
            type: 'agent',
            text: '<strong>' + a.id + '</strong> is now active',
            time: new Date(a.lastSeen || Date.now())
          });
        });
        // Sort by time
        activityItems.sort((a, b) => b.time - a.time);
        renderActivityFeed();
      }

      renderContextSection('claimsList', claimsList, 'claim', c => ({
        title: c.what,
        owner: c.by,
        detail: c.description || ''
      }));

      renderContextSection('zonesList', zonesList, 'zone', z => ({
        title: z.zoneId,
        owner: z.owner,
        detail: z.path
      }));

      renderContextSection('locksList', locksList, 'lock', l => ({
        title: l.resourcePath,
        owner: l.lockedBy,
        detail: l.reason || ''
      }));

      renderContextSection('tasksList', tasksList, 'task', t => ({
        title: t.title,
        owner: t.assignee || t.createdBy,
        detail: t.status + ' - ' + t.priority
      }));

      renderContextSection('plannedFeaturesList', featuresList, 'feature', f => ({
        title: f.title,
        owner: f.assignedTo || 'unassigned',
        detail: f.status + ' - ' + f.priority
      }));
    }

    function renderContextSection(containerId, items, type, mapper) {
      const container = document.getElementById(containerId);
      if (items.length === 0) {
        container.innerHTML = '<div class="context-item" style="color: var(--text-secondary); font-size: 12px;">None</div>';
        return;
      }
      container.innerHTML = items.map(item => {
        const { title, owner, detail } = mapper(item);
        const itemId = item.id || '';
        const isFeature = type === 'feature';
        const clickStyle = isFeature ? 'cursor: pointer;' : '';
        const clickHandler = isFeature ? `onclick="showTestModal('${escapeHtml(itemId)}', '${escapeHtml(title)}')"` : '';
        return `
          <div class="context-item ${type}" data-id="${escapeHtml(itemId)}" data-title="${escapeHtml(title)}" style="${clickStyle}" ${clickHandler}>
            <div class="context-item-header">
              <span class="context-item-title">${escapeHtml(title)}</span>
              <span class="context-item-owner">${escapeHtml(owner)}</span>
            </div>
            <div class="context-item-detail">${escapeHtml(detail)}</div>
            ${isFeature ? '<div style="font-size: 10px; color: var(--accent); margin-top: 4px;">Click to run tests</div>' : ''}
          </div>
        `;
      }).join('');
    }

    function updateEfficiency() {
      if (totalTokens === 0) return;
      const efficiency = Math.round((tokensSaved / totalTokens) * 100);
      document.getElementById('efficiencyBar').style.width = Math.min(efficiency, 100) + '%';
      document.getElementById('efficiencyPercent').textContent = efficiency + '%';
      document.getElementById('tokenEfficiency').textContent = efficiency;
    }

    function getInitials(name) {
      return name.split('-').map(p => p[0]).join('').toUpperCase().substr(0, 2);
    }

    function timeAgo(date) {
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      if (seconds < 60) return 'now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm ago';
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + 'h ago';
      return Math.floor(hours / 24) + 'd ago';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // === ROADMAP FUNCTIONS ===

    let teamMembers = [];
    let roadmapItems = [];

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabName + 'View');
      });

      // Fetch roadmap data when switching to roadmap tab
      if (tabName === 'roadmap') {
        fetchTeam();
        fetchCycles();
        fetchRoadmap();
        // Initialize drag-drop after a brief delay for DOM update
        setTimeout(initDragDrop, 100);
      }

      // Fetch telemetry data when switching to telemetry tab
      if (tabName === 'telemetry') {
        fetchTelemetry();
      }

      // Fetch metrics data when switching to metrics tab
      if (tabName === 'metrics') {
        fetchMetrics();
      }

      // Initialize CRM when switching to crm tab
      if (tabName === 'crm') {
        initCrm();
      }

      // Initialize Sales Engineering when switching to sales tab
      if (tabName === 'sales') {
        initSalesEng();
      }
    }

    async function fetchTeam() {
      try {
        const res = await fetch(API_BASE + '/roadmap?type=team');
        const data = await res.json();
        teamMembers = data.team || [];

        // Populate assignee dropdowns
        const assigneeFilter = document.getElementById('assigneeFilter');
        const itemAssignee = document.getElementById('itemAssignee');

        const options = '<option value="">All Assignees</option>' +
          teamMembers.map(m => `<option value="${m.id}">${m.name} (${m.type})</option>`).join('');
        assigneeFilter.innerHTML = options;

        const itemOptions = '<option value="">Unassigned</option>' +
          teamMembers.map(m => `<option value="${m.id}" data-type="${m.type}">${m.name}</option>`).join('');
        itemAssignee.innerHTML = itemOptions;
      } catch (err) {
        console.error('Failed to fetch team:', err);
      }
    }


    // === TELEMETRY FUNCTIONS ===

    let telemetryRefreshInterval = null;

    async function fetchTelemetry() {
      const refreshBtn = document.getElementById('telemetryRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
        refreshBtn.innerHTML = '<span class="refresh-spinner"></span>';
      }
      
      try {
        const res = await fetch(API_BASE + '/telemetry?alerts=true');
        const data = await res.json();

        // Update fleet summary
        if (data.fleet) {
          document.getElementById('fleetTotal').textContent = data.fleet.total;
          document.getElementById('fleetActive').textContent = data.fleet.active;
          document.getElementById('fleetMoving').textContent = data.fleet.moving;
          document.getElementById('fleetAvgBattery').textContent = data.fleet.avgBatteryVoltage + 'V';
          
          // Update health score
          const healthEl = document.getElementById('fleetHealthScore');
          const healthStat = healthEl.closest('.fleet-stat');
          if (data.fleet.health) {
            healthEl.textContent = data.fleet.health.avgScore;
            healthStat.classList.remove('warning', 'critical');
            if (data.fleet.health.avgScore < 50) healthStat.classList.add('critical');
            else if (data.fleet.health.avgScore < 70) healthStat.classList.add('warning');
          }
        }

        // Update alerts
        if (data.alertSummary && data.alertSummary.total > 0) {
          document.getElementById('alertIndicator').style.display = 'flex';
          document.getElementById('alertCount').textContent = data.alertSummary.total;
          renderAlerts(data.alerts || []);
        } else {
          document.getElementById('alertIndicator').style.display = 'none';
          document.getElementById('alertsBanner').style.display = 'none';
        }

        // Render device cards
        renderTelemetryGrid(data.devices || []);
        
        // Update health overview panel
        updateHealthOverview(data.devices || [], data.alerts || []);
        
        // Update last updated time
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const lastUpdatedEl = document.getElementById('telemetryLastUpdated');
        if (lastUpdatedEl) lastUpdatedEl.textContent = timeStr;

        // Start auto-refresh if not already running
        if (!telemetryRefreshInterval) {
          telemetryRefreshInterval = setInterval(fetchTelemetry, 10000);
        }
      } catch (err) {
        console.error('Failed to fetch telemetry:', err);
        document.getElementById('telemetryGrid').innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="m15 9-6 6M9 9l6 6"/>
            </svg>
            <p>Failed to load telemetry data</p>
          </div>
        `;
        const lastUpdatedEl = document.getElementById('telemetryLastUpdated');
        if (lastUpdatedEl) lastUpdatedEl.classList.add('data-stale');
      } finally {
        const refreshBtn = document.getElementById('telemetryRefreshBtn');
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
          refreshBtn.innerHTML = 'Refresh';
        }
      }
    }

    function renderAlerts(alerts) {
      const banner = document.getElementById('alertsBanner');
      const list = document.getElementById('alertsList');
      
      if (alerts.length === 0) {
        banner.style.display = 'none';
        return;
      }

      banner.style.display = 'block';
      list.innerHTML = alerts.map(alert => `
        <div class="alert-item ${alert.severity}">
          <span class="alert-device">${alert.deviceName}</span>
          <span class="alert-message">${alert.message}</span>
          <span class="alert-time">${new Date(alert.createdAt).toLocaleTimeString()}</span>
        </div>
      `).join('');
    }

    // Toggle alerts banner
    document.getElementById('alertIndicator')?.addEventListener('click', () => {
      const banner = document.getElementById('alertsBanner');
      banner.style.display = banner.style.display === 'none' ? 'block' : 'none';
    });

    // Fleet map state
    let mapVisible = false;

    function toggleMapView() {
      mapVisible = !mapVisible;
      const container = document.getElementById('fleetMapContainer');
      container.classList.toggle('visible', mapVisible);
      if (mapVisible) {
        // Re-render map with current data
        const grid = document.getElementById('telemetryGrid');
        // Map will update on next telemetry refresh
      }
    }
    
    let healthOverviewVisible = true;
    
    function toggleHealthOverview() {
      healthOverviewVisible = !healthOverviewVisible;
      const overview = document.getElementById('healthOverview');
      overview.classList.toggle('visible', healthOverviewVisible);
    }
    
    function updateHealthOverview(devices, alerts) {
      if (!devices || devices.length === 0) return;
      
      // Calculate breakdown
      let excellent = 0, good = 0, warning = 0, critical = 0;
      let totalScore = 0;
      
      devices.forEach(device => {
        const score = device.health?.score || 100;
        totalScore += score;
        if (score >= 90) excellent++;
        else if (score >= 70) good++;
        else if (score >= 50) warning++;
        else critical++;
      });
      
      const avgScore = Math.round(totalScore / devices.length);
      const total = devices.length;
      
      // Update gauge
      const gaugeCircle = document.getElementById('gaugeCircle');
      gaugeCircle.style.setProperty('--score', avgScore);
      gaugeCircle.className = 'gauge-circle';
      if (avgScore < 50) gaugeCircle.classList.add('critical');
      else if (avgScore < 70) gaugeCircle.classList.add('warning');
      
      document.getElementById('gaugeScore').textContent = avgScore;
      
      // Update breakdown
      document.getElementById('breakdownExcellent').textContent = excellent;
      document.getElementById('breakdownGood').textContent = good;
      document.getElementById('breakdownWarning').textContent = warning;
      document.getElementById('breakdownCritical').textContent = critical;
      
      // Update bars (percentage of total)
      document.getElementById('barExcellent').style.width = (excellent / total * 100) + '%';
      document.getElementById('barGood').style.width = (good / total * 100) + '%';
      document.getElementById('barWarning').style.width = (warning / total * 100) + '%';
      document.getElementById('barCritical').style.width = (critical / total * 100) + '%';
      
      // Update alerts list
      const alertsList = document.getElementById('healthAlertsList');
      if (alerts && alerts.length > 0) {
        const recentAlerts = alerts.slice(0, 4);
        alertsList.innerHTML = recentAlerts.map(alert => {
          const timeAgo = getTimeAgo(new Date(alert.createdAt));
          return '<div class="health-alert-item ' + (alert.severity === 'critical' ? 'critical' : '') + '">' +
            '<div class="health-alert-dot"></div>' +
            '<div class="health-alert-text">' + alert.deviceName + ': ' + alert.message + '</div>' +
            '<div class="health-alert-time">' + timeAgo + '</div>' +
          '</div>';
        }).join('');
      } else {
        alertsList.innerHTML = '<div class="no-alerts">' +
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
          '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>' +
          '<polyline points="22 4 12 14.01 9 11.01"/>' +
          '</svg>' +
          '<span>All systems operational</span>' +
        '</div>';
      }
      
      // Show overview panel
      document.getElementById('healthOverview').classList.add('visible');
    }
    
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return diffMins + 'm ago';
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return diffHours + 'h ago';
      return Math.floor(diffHours / 24) + 'd ago';
    }
    
    function toggleAllAlerts() {
      const banner = document.getElementById('alertsBanner');
      banner.style.display = banner.style.display === 'none' ? 'block' : 'none';
    }

    function renderFleetMap(devices) {
      if (!mapVisible) return;
      
      const mapDevices = document.getElementById('mapDevices');
      if (!devices || devices.length === 0) {
        mapDevices.innerHTML = '';
        return;
      }

      // Find bounds of all devices
      const lats = devices.map(d => d.position?.lat || 0).filter(l => l !== 0);
      const lngs = devices.map(d => d.position?.lng || 0).filter(l => l !== 0);
      
      if (lats.length === 0) return;

      const minLat = Math.min(...lats);
      const maxLat = Math.max(...lats);
      const minLng = Math.min(...lngs);
      const maxLng = Math.max(...lngs);
      
      // Add padding
      const latPad = (maxLat - minLat) * 0.2 || 1;
      const lngPad = (maxLng - minLng) * 0.2 || 1;

      mapDevices.innerHTML = devices.map(device => {
        const lat = device.position?.lat || 0;
        const lng = device.position?.lng || 0;
        
        // Normalize position to percentage
        const x = ((lng - (minLng - lngPad)) / ((maxLng + lngPad) - (minLng - lngPad))) * 100;
        const y = (1 - ((lat - (minLat - latPad)) / ((maxLat + latPad) - (minLat - latPad)))) * 100;
        
        const isMoving = device.status?.movement;
        const isActive = device.status?.ignition;
        
        return `
          <div class="map-device ${isMoving ? 'moving' : ''} ${isActive ? 'active' : ''}"
               style="left: ${Math.max(10, Math.min(90, x))}%; top: ${Math.max(15, Math.min(85, y))}%"
               title="${device.deviceName}: ${device.metrics?.speed || 0} km/h">
            <div class="map-device-dot"></div>
            <span class="map-device-label">${device.deviceName}</span>
          </div>
        `;
      }).join('');
    }

    // Store current telemetry data for modal access
    let currentTelemetryData = [];

    function openDeviceModal(imei) {
      const device = currentTelemetryData.find(d => d.imei === imei);
      if (!device) return;

      // Vehicle info
      document.getElementById('modalDeviceName').textContent = device.deviceName || 'Unknown Device';
      document.getElementById('modalVin').textContent = device.vehicleInfo?.vin || '--';
      document.getElementById('modalVehicle').textContent = 
        [device.vehicleInfo?.make, device.vehicleInfo?.model].filter(Boolean).join(' ') || '--';
      document.getElementById('modalYear').textContent = device.vehicleInfo?.year || '--';
      document.getElementById('modalImei').textContent = device.imei;

      // Metrics
      document.getElementById('modalSpeed').textContent = device.metrics?.speed || 0;
      document.getElementById('modalBattery').textContent = device.metrics?.batteryVoltage || '--';
      document.getElementById('modalFuel').textContent = device.metrics?.fuelLevel || '--';
      document.getElementById('modalRpm').textContent = device.metrics?.engineRPM || 0;
      document.getElementById('modalTemp').textContent = device.metrics?.coolantTemp ? device.metrics.coolantTemp + 'C' : '--';
      document.getElementById('modalOdometer').textContent = formatOdometer(device.metrics?.odometer);

      // Status indicators
      setStatusIndicator('modalIgnition', device.status?.ignition);
      setStatusIndicator('modalMovement', device.status?.movement);
      setStatusIndicator('modalGps', device.status?.gpsValid);
      setStatusIndicator('modalCharging', device.status?.charging);

      // Health
      const health = device.health || { score: 100, status: 'excellent', issues: [] };
      const healthBar = document.getElementById('modalHealthBar');
      healthBar.style.width = health.score + '%';
      healthBar.className = 'health-bar';
      if (health.score < 50) healthBar.classList.add('critical');
      else if (health.score < 70) healthBar.classList.add('warning');
      document.getElementById('modalHealthScore').textContent = health.score;

      // Issues
      const issuesEl = document.getElementById('modalIssues');
      if (health.issues && health.issues.length > 0) {
        issuesEl.innerHTML = health.issues.map(issue => {
          const severity = issue.toLowerCase().includes('critical') ? 'critical' : 'warning';
          return '<div class="modal-issue ' + severity + '">' + issue + '</div>';
        }).join('');
      } else {
        issuesEl.innerHTML = '<div style="color: var(--success); font-size: 12px;">All systems normal</div>';
      }

      // Location
      document.getElementById('modalLat').textContent = device.position?.lat?.toFixed(4) || '--';
      document.getElementById('modalLng').textContent = device.position?.lng?.toFixed(4) || '--';
      document.getElementById('modalHeading').textContent = device.position?.heading || '--';
      document.getElementById('modalSats').textContent = device.position?.satellites || '--';
      document.getElementById('modalSignal').textContent = device.connectivity?.signalStrength || '--';

      // Show modal
      document.getElementById('deviceModalOverlay').classList.add('visible');
      
      // Fetch and display history
      fetchDeviceHistory(imei);
    }

    function closeDeviceModal() {
      document.getElementById('deviceModalOverlay').classList.remove('visible');
    }
    
    async function fetchDeviceHistory(imei) {
      try {
        const res = await fetch(API_BASE + '/telemetry?imei=' + imei + '&history=true');
        const data = await res.json();
        if (data.history && data.history.length > 0) {
          document.getElementById('modalHistorySection').style.display = 'block';
          renderSparkline('batterySparkline', data.history, 'batteryVoltage', 10, 15);
          renderSparkline('speedSparkline', data.history, 'speed', 0, 150);
        } else {
          document.getElementById('modalHistorySection').style.display = 'none';
        }
      } catch (err) {
        console.error('Failed to fetch device history:', err);
        document.getElementById('modalHistorySection').style.display = 'none';
      }
    }
    
    function renderSparkline(containerId, history, metric, minVal, maxVal) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      // Reverse so oldest is first
      const data = [...history].reverse();
      
      // Get values
      const values = data.map(h => {
        if (metric === 'batteryVoltage') return h.batteryVoltage || h.metrics?.batteryVoltage || 0;
        if (metric === 'speed') return h.speed || h.metrics?.speed || 0;
        return 0;
      });
      
      // Calculate range
      const actualMin = Math.min(...values.filter(v => v > 0)) * 0.9;
      const actualMax = Math.max(...values) * 1.1;
      const range = actualMax - actualMin || 1;
      
      // Render bars
      container.innerHTML = values.map((val, i) => {
        const heightPercent = ((val - actualMin) / range) * 100;
        const height = Math.max(4, Math.min(100, heightPercent));
        
        // Determine bar color
        let barClass = '';
        if (metric === 'batteryVoltage') {
          if (val < 11.0) barClass = 'critical';
          else if (val < 11.8) barClass = 'warning';
        } else if (metric === 'speed') {
          if (val > 120) barClass = 'critical';
          else if (val > 100) barClass = 'warning';
        }
        
        return '<div class="sparkline-bar ' + barClass + '" style="height: ' + height + '%" title="' + val.toFixed(1) + '"></div>';
      }).join('');
    }

    function setStatusIndicator(id, active) {
      const el = document.getElementById(id);
      if (active) {
        el.classList.add('active');
      } else {
        el.classList.remove('active');
      }
    }

    // Close modal on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDeviceModal();
    });



    function renderTelemetryGrid(devices) {
      console.log('[TELEMETRY] renderTelemetryGrid called with', devices?.length || 0, 'devices');
      const grid = document.getElementById('telemetryGrid');
      currentTelemetryData = devices || [];

      if (!devices || devices.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </svg>
            <p>No devices found</p>
          </div>
        `;
        renderDeviceList([]);
        return;
      }

      grid.innerHTML = devices.map(device => renderDeviceCard(device)).join('');
      
      // Also update fleet map and device list
      renderFleetMap(devices);
      renderDeviceList(devices);
    }
    
    // Device List View Functions
    let deviceListSortField = 'imei';
    let deviceListSortAsc = true;
    let showGridView = false;
    
    function renderDeviceList(devices) {
      console.log('[DEVICELIST] renderDeviceList called with', devices?.length || 0, 'devices');
      const tbody = document.getElementById('deviceListBody');
      if (!tbody) {
        console.error('[DEVICELIST] tbody not found!');
        return;
      }
      console.log('[DEVICELIST] tbody found, rendering...');
      
      if (!devices || devices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="loading-row">No devices enrolled</td></tr>';
        return;
      }
      
      // Sort devices
      const sorted = [...devices].sort((a, b) => {
        let aVal, bVal;
        switch (deviceListSortField) {
          case 'imei':
            aVal = a.imei || '';
            bVal = b.imei || '';
            break;
          case 'vin':
            aVal = a.vehicleInfo?.vin || '';
            bVal = b.vehicleInfo?.vin || '';
            break;
          case 'name':
            aVal = a.deviceName || '';
            bVal = b.deviceName || '';
            break;
          case 'health':
            aVal = a.health?.score || 0;
            bVal = b.health?.score || 0;
            break;
          case 'status':
            aVal = a.status?.movement ? 1 : 0;
            bVal = b.status?.movement ? 1 : 0;
            break;
          case 'speed':
            aVal = a.metrics?.speed || 0;
            bVal = b.metrics?.speed || 0;
            break;
          case 'battery':
            aVal = a.metrics?.batteryVoltage || 0;
            bVal = b.metrics?.batteryVoltage || 0;
            break;
          default:
            aVal = a.imei || '';
            bVal = b.imei || '';
        }
        if (typeof aVal === 'string') {
          return deviceListSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        return deviceListSortAsc ? aVal - bVal : bVal - aVal;
      });
      
      tbody.innerHTML = sorted.map(device => {
        const vehicle = device.vehicleInfo || {};
        const vehicleStr = [vehicle.year, vehicle.make, vehicle.model].filter(Boolean).join(' ') || 'Unknown';
        const health = device.health || { score: 100, status: 'excellent' };
        const isDeviceOffline = device.status?.offline === true;
        const isMoving = !isDeviceOffline && device.status?.movement;
        const lastSeen = device.connectivity?.lastSeen ? formatTimeAgo(new Date(device.connectivity.lastSeen)) : '--';
        const statusClass = isDeviceOffline ? 'offline' : (isMoving ? 'moving' : 'parked');
        const statusText = isDeviceOffline ? 'Offline' : (isMoving ? 'Moving' : 'Parked');
        const speed = device.metrics?.speed || 0;
        const battery = device.metrics?.batteryVoltage || '--';
        const lat = device.position?.lat?.toFixed(4) || '--';
        const lng = device.position?.lng?.toFixed(4) || '--';
        const batteryClass = typeof battery === 'number' ? (battery >= 12.4 ? 'good' : battery >= 11.8 ? 'warn' : 'low') : '';

        return `
          <tr onclick="openDeviceModal('${device.imei}')" style="cursor: pointer;">
            <td class="imei-cell">${device.imei || '--'}</td>
            <td class="vehicle-cell">${vehicleStr}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td class="speed-cell">${speed} <span class="unit">km/h</span></td>
            <td class="battery-cell ${batteryClass}">${typeof battery === 'number' ? battery.toFixed(1) : battery}V</td>
            <td class="location-cell">${lat}, ${lng}</td>
            <td><span class="health-score ${health.status}">${health.score}%</span></td>
            <td class="time-cell">${lastSeen}</td>
          </tr>
        `;
      }).join('');
      console.log('[DEVICELIST] innerHTML set, tbody now has', tbody.children.length, 'rows');
    }
    function sortDeviceList() {
      const select = document.getElementById('deviceSortBy');
      if (select) {
        deviceListSortField = select.value;
        renderDeviceList(currentTelemetryData);
      }
    }
    
    function sortDeviceListBy(field) {
      if (deviceListSortField === field) {
        deviceListSortAsc = !deviceListSortAsc;
      } else {
        deviceListSortField = field;
        deviceListSortAsc = true;
      }
      const select = document.getElementById('deviceSortBy');
      if (select) select.value = field;
      renderDeviceList(currentTelemetryData);
    }
    
    function toggleDeviceView() {
      showGridView = !showGridView;
      const grid = document.getElementById('telemetryGrid');
      const list = document.getElementById('deviceListContainer');
      const icon = document.getElementById('viewToggleIcon');
      
      if (showGridView) {
        grid.style.display = 'grid';
        list.style.display = 'none';
        if (icon) icon.textContent = '';
      } else {
        grid.style.display = 'none';
        list.style.display = 'block';
        if (icon) icon.textContent = '';
      }
    }

    function renderDeviceCard(device) {
      const isOffline = device.status?.offline === true;
      const isMoving = !isOffline && device.status?.movement;
      const ignitionOn = !isOffline && device.status?.ignition;
      const batteryClass = isOffline ? '' : getBatteryClass(device.metrics?.batteryVoltage);
      const vehicle = device.vehicleInfo || {};
      const vehicleStr = [vehicle.year, vehicle.make, vehicle.model].filter(Boolean).join(' ');
      const health = device.health || { score: 100, status: 'excellent', issues: [] };
      const healthStatus = isOffline ? 'critical' : (health.status || 'excellent');
      const healthIssue = health.issues?.[0] || (isOffline ? 'Device offline' : 'All systems normal');
      const currentSpeed = device.metrics?.speed || 0;
      const speedHistory = device.speedHistory || Array(12).fill(0).map((_, i) =>
        Math.max(0, currentSpeed + (Math.random() - 0.5) * 20 - i * 2)
      ).reverse();
      const maxSpeed = Math.max(...speedHistory, 1);
      const lastSeen = device.connectivity?.lastSeen ? new Date(device.connectivity.lastSeen) : null;
      const lastSeenStr = lastSeen ? formatTimeAgo(lastSeen) : '--';
      const signalBars = device.connectivity?.signalStrength || 0;
      const carrier = device.connectivity?.carrier || 'Unknown';
      const fuelLevel = device.metrics?.fuelLevel || 0;
      const engineRPM = device.metrics?.engineRPM || 0;
      const coolantTemp = device.metrics?.coolantTemp || 0;
      const lat = device.position?.lat?.toFixed(4) || '--';
      const lng = device.position?.lng?.toFixed(4) || '--';
      const heading = device.position?.heading || 0;
      const satellites = device.position?.satellites || 0;

      // Determine status text and class
      const statusClass = isOffline ? 'offline' : (isMoving ? 'moving' : 'parked');
      const statusText = isOffline ? 'Offline' : (isMoving ? 'Moving' : 'Parked');
      const cardClass = isOffline ? 'device-offline' : (ignitionOn ? 'ignition-on' : 'ignition-off');

      return `
        <div class="device-card ${cardClass} health-${healthStatus}" onclick="openDeviceModal('${device.imei}')" style="cursor:pointer${isOffline ? ';opacity:0.7' : ''}">
          <div class="device-health-badge ${healthStatus === 'warning' ? 'warning' : healthStatus === 'critical' ? 'critical' : ''}"></div>
          <div class="device-header">
            <div class="device-title-row">
              <span class="device-name">${device.deviceName || 'Unknown'}</span>
              <span class="device-imei" title="IMEI">${device.imei}</span>
            </div>
            <span class="device-status ${statusClass}">
              <span class="device-status-dot"></span>
              ${statusText}
            </span>
          </div>
          <div class="device-live-indicator">
            <span class="live-dot${isOffline ? ' offline' : ''}"></span>
            <span>Last seen: ${lastSeenStr}</span>
            <span class="signal-bars" title="${isOffline ? 'No signal - offline' : carrier + ' - ' + signalBars + '/5 bars'}">
              ${[1,2,3,4,5].map(i => '<span class="signal-bar ' + (i <= signalBars ? 'active' : '') + '"></span>').join('')}
            </span>
          </div>
          <div class="device-metrics">
            <div class="metric">
              <span class="metric-icon"></span>
              <span class="metric-value speed">${currentSpeed}</span>
              <span class="metric-label">km/h</span>
            </div>
            <div class="metric">
              <span class="metric-icon"></span>
              <span class="metric-value ${batteryClass}">${device.metrics?.batteryVoltage || '--'}V</span>
              <span class="metric-label">Battery</span>
            </div>
            <div class="metric">
              <span class="metric-icon"></span>
              <span class="metric-value">${device.metrics?.externalVoltage || '--'}V</span>
              <span class="metric-label">External</span>
            </div>
            <div class="metric">
              <span class="metric-icon"></span>
              <span class="metric-value">${fuelLevel}%</span>
              <span class="metric-label">Fuel</span>
            </div>
          </div>
          <div class="device-metrics-row2">
            <div class="metric-small">
              <span class="metric-icon-sm"></span>
              <span>${engineRPM} RPM</span>
            </div>
            <div class="metric-small">
              <span class="metric-icon-sm"></span>
              <span>${coolantTemp}C</span>
            </div>
            <div class="metric-small">
              <span class="metric-icon-sm"></span>
              <span>${formatOdometer(device.metrics?.odometer)}</span>
            </div>
            <div class="metric-small">
              <span class="metric-icon-sm"></span>
              <span>${satellites} sats</span>
            </div>
          </div>
          <div class="device-mini-chart">
            ${speedHistory.map(speed =>
              '<div class="mini-chart-bar" style="height: ' + Math.max(10, (speed / maxSpeed) * 100) + '%"></div>'
            ).join('')}
          </div>
          <div class="device-location">
            <span class="location-coords">${lat}, ${lng}</span>
            <span class="location-heading">Heading: ${heading}</span>
          </div>
          <div class="device-health">
            <span class="health-score ${healthStatus}">${health.score}</span>
            <span class="health-issues">${healthIssue}</span>
          </div>
          ${vehicle.vin || vehicleStr ? `
          <div class="device-vehicle">
            <span>${vehicleStr || 'Unknown Vehicle'}</span>
            ${vehicle.vin ? `<span class="device-vin">VIN: ${vehicle.vin}</span>` : ''}
          </div>
          ` : ''}
        </div>
      `;
    }

    function getBatteryClass(voltage) {
      if (!voltage) return '';
      if (voltage >= 12.4) return 'battery-good';
      if (voltage >= 11.8) return 'battery-warn';
      return 'battery-low';
    }

    function formatOdometer(km) {
      if (!km) return '--';
      if (km >= 1000) return Math.round(km / 1000) + 'k km';
      return Math.round(km) + ' km';
    }


    
    // === METRICS FUNCTIONS ===

    let currentMetricsPeriod = '24h';
    let metricsHistory = { agents: [], messages: [] };

    function setMetricsPeriod(period) {
      currentMetricsPeriod = period;
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === period);
      });
      const periodEl = document.getElementById('contributorPeriod');
      if (periodEl) periodEl.textContent = period;
      fetchMetrics();
    }

    function renderMetricsSparkline(containerId, data, color = 'var(--accent)') {
      const container = document.getElementById(containerId);
      if (!container || !data || data.length === 0) return;
      const max = Math.max(...data, 1);
      container.innerHTML = data.map((val, i) => {
        const height = Math.max(4, (val / max) * 100);
        const opacity = i === data.length - 1 ? '1' : '0.5';
        return '<div class="sparkline-bar" style="height: ' + height + '%; background: ' + color + '; opacity: ' + opacity + ';"></div>';
      }).join('');
    }

    function animateNumber(elementId, newValue) {
      const el = document.getElementById(elementId);
      if (!el) return;
      const current = parseInt(el.textContent) || 0;
      const diff = newValue - current;
      if (Math.abs(diff) === 0) { el.textContent = newValue; return; }
      let step = 0;
      const steps = 15;
      const stepValue = diff / steps;
      const animate = () => {
        step++;
        el.textContent = step === steps ? newValue : Math.round(current + stepValue * step);
        if (step < steps) requestAnimationFrame(animate);
      };
      requestAnimationFrame(animate);
    }

    // Metrics activity stream
    let metricsActivityLog = [];

    function updateMetricsActivityStream(data) {
      const stream = document.getElementById('metricsActivityStream');
      if (!stream) return;

      // Generate activity items from current data
      const activities = [];
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      if (data.agents?.activeNow > 0) {
        activities.push({ text: data.agents.activeNow + ' agents active', type: 'success', time: timeStr });
      }
      if (data.coordination?.activeLocks > 0) {
        activities.push({ text: data.coordination.activeLocks + ' resource locks held', type: 'warning', time: timeStr });
      }
      if (data.coordination?.activeClaims > 0) {
        activities.push({ text: data.coordination.activeClaims + ' active claims', type: '', time: timeStr });
      }
      if (data.tasks?.inProgress > 0) {
        activities.push({ text: data.tasks.inProgress + ' tasks in progress', type: '', time: timeStr });
      }
      if (data.telemetry?.activeDevices > 0) {
        activities.push({ text: data.telemetry.activeDevices + '/' + data.telemetry.totalDevices + ' vehicles active', type: 'success', time: timeStr });
      }
      if (data.messages?.last24h > 0) {
        activities.push({ text: data.messages.last24h + ' messages today', type: '', time: timeStr });
      }

      // Add to log and keep last 10
      metricsActivityLog = [...activities, ...metricsActivityLog].slice(0, 10);

      stream.innerHTML = metricsActivityLog.map(item =>
        '<div class="activity-item ' + item.type + '">' +
        '<span>' + item.text + '</span>' +
        '<span style="margin-left: auto; opacity: 0.6; font-size: 10px;">' + item.time + '</span>' +
        '</div>'
      ).join('');
    }

    async function fetchMetrics() {
      try {
        const res = await fetch(API_BASE + '/metrics?period=' + currentMetricsPeriod);
        const data = await res.json();

        // Update load time
        document.getElementById('metricsLoadTime').textContent = 
          'Loaded in ' + (data._meta?.loadTime || '--');

        // Update agents with animation
        animateNumber('metricAgentsActive', data.agents?.activeNow || 0);
        animateNumber('metricAgentsTotal', data.agents?.total || 0);
        animateNumber('metricAgents24h', data.agents?.active24h || 0);
        
        // Track history for sparklines
        metricsHistory.agents.push(data.agents?.activeNow || 0);
        if (metricsHistory.agents.length > 12) metricsHistory.agents.shift();
        renderMetricsSparkline('agentsSparkline', metricsHistory.agents);
        
        // Update trend indicator
        const agentsTrend = document.getElementById('agentsTrend');
        if (agentsTrend && metricsHistory.agents.length > 1) {
          const prev = metricsHistory.agents[metricsHistory.agents.length - 2] || 0;
          const curr = metricsHistory.agents[metricsHistory.agents.length - 1];
          const change = curr - prev;
          agentsTrend.className = 'metric-trend ' + (change > 0 ? 'up' : change < 0 ? 'down' : 'neutral');
          agentsTrend.textContent = change > 0 ? '+' + change : change < 0 ? change : '--';
        }

        // Update messages with animation
        animateNumber('metricMessagesTotal', data.messages?.total || 0);
        animateNumber('metricMessages24h', data.messages?.last24h || 0);
        animateNumber('metricMessagesAvg', data.messages?.avgPerDay || 0);
        
        // Track messages history
        metricsHistory.messages.push(data.messages?.last24h || 0);
        if (metricsHistory.messages.length > 12) metricsHistory.messages.shift();
        renderMetricsSparkline('messagesSparkline', metricsHistory.messages, 'var(--success)');
        
        // Update messages trend
        const msgTrend = document.getElementById('messagesTrend');
        if (msgTrend) {
          const avg = data.messages?.avgPerDay || 0;
          const today = data.messages?.last24h || 0;
          if (today > avg * 1.1) {
            msgTrend.className = 'metric-trend up';
            msgTrend.textContent = '+' + Math.round(((today - avg) / Math.max(avg, 1)) * 100) + '%';
          } else if (today < avg * 0.9) {
            msgTrend.className = 'metric-trend down';
            msgTrend.textContent = Math.round(((today - avg) / Math.max(avg, 1)) * 100) + '%';
          } else {
            msgTrend.className = 'metric-trend neutral';
            msgTrend.textContent = 'avg';
          }
        }

        // Update tasks with progress bar animation
        const rate = data.tasks?.completionRate || '0%';
        document.getElementById('metricTasksRate').textContent = rate;
        animateNumber('metricTasksTotal', data.tasks?.total || 0);
        animateNumber('metricTasksProgress', data.tasks?.inProgress || 0);
        const completedEl = document.getElementById('metricTasksCompleted');
        if (completedEl) animateNumber('metricTasksCompleted', data.tasks?.completed || 0);
        
        // Update tasks progress bar
        const progressBar = document.getElementById('tasksProgressBar');
        if (progressBar) {
          progressBar.style.width = rate;
          const rateNum = parseInt(rate) || 0;
          if (rateNum >= 75) progressBar.className = 'metric-progress-fill success';
          else if (rateNum >= 50) progressBar.className = 'metric-progress-fill warning';
          else progressBar.className = 'metric-progress-fill danger';
        }

        // Update coordination with animations
        animateNumber('metricLocks', data.coordination?.activeLocks || 0);
        animateNumber('metricClaims', data.coordination?.activeClaims || 0);
        animateNumber('metricHandoffs', data.coordination?.pendingHandoffs || 0);
        animateNumber('metricWorkflows', data.workflows?.totalRuns || 0);

        // Update memory with animation
        animateNumber('metricMemoryTotal', data.memory?.totalItems || 0);
        const categoriesEl = document.getElementById('memoryCategories');
        if (data.memory?.categories && Object.keys(data.memory.categories).length > 0) {
          categoriesEl.innerHTML = Object.entries(data.memory.categories)
            .slice(0, 4)
            .map(([cat, count]) => `<div class="metric-row"><span>${cat}</span><span>${count}</span></div>`)
            .join('');
        } else {
          categoriesEl.innerHTML = '<div style="color: var(--text-secondary); font-size: 11px;">No items stored</div>';
        }

        // Update telemetry with progress bar
        const totalDevices = data.telemetry?.totalDevices || 0;
        const activeDevices = data.telemetry?.activeDevices || 0;
        animateNumber('metricDevices', totalDevices);
        animateNumber('metricDevicesActive', activeDevices);
        document.getElementById('metricBattery').textContent =
          (data.telemetry?.avgBatteryVoltage || '--') + 'V';

        // Update fleet active bar
        const fleetBar = document.getElementById('fleetActiveBar');
        if (fleetBar && totalDevices > 0) {
          fleetBar.style.width = Math.round((activeDevices / totalDevices) * 100) + '%';
        }

        // Update top contributors with ranking
        const contributorsEl = document.getElementById('contributorsList');
        if (data.agents?.topContributors?.length > 0) {
          const maxMsgs = Math.max(...data.agents.topContributors.map(c => c.messagesSent), 1);
          contributorsEl.innerHTML = data.agents.topContributors
            .map((c, i) => {
              const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
              const avatarBg = c.agentId.toLowerCase().includes('claude') ? 'var(--agent-color)' : 'var(--human-color)';
              const barWidth = Math.round((c.messagesSent / maxMsgs) * 100);
              return `
              <div class="contributor-item">
                <div class="contributor-rank ${rankClass}">${i + 1}</div>
                <div class="contributor-avatar" style="background: ${avatarBg}">${c.agentId.substring(0, 2).toUpperCase()}</div>
                <div class="contributor-info">
                  <div class="contributor-name">${c.agentId}</div>
                  <div class="contributor-stat">${c.messagesSent} messages</div>
                </div>
                <div class="contributor-bar">
                  <div class="contributor-bar-fill" style="width: ${barWidth}%"></div>
                </div>
              </div>
            `}).join('');
        } else {
          contributorsEl.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; padding: 12px;">No activity recorded yet</div>';
        }

        // Update system status panel
        const versionEl = document.getElementById('systemVersion');
        const toolsEl = document.getElementById('systemTools');
        const lastDeployEl = document.getElementById('lastDeploy');
        const uptimeEl = document.getElementById('systemUptime');

        if (versionEl) versionEl.textContent = data.uptime?.version || '0.1.0';
        if (toolsEl) toolsEl.textContent = data.uptime?.tools || 21;
        if (lastDeployEl && data.uptime?.lastDeployment) {
          const deployDate = new Date(data.uptime.lastDeployment);
          lastDeployEl.textContent = deployDate.toLocaleTimeString();
        }
        if (uptimeEl) {
          const now = new Date();
          uptimeEl.textContent = now.getHours() + 'h ' + now.getMinutes() + 'm';
        }

        // Update activity stream
        updateMetricsActivityStream(data);

      } catch (err) {
        console.error('Failed to fetch metrics:', err);
        document.getElementById('metricsLoadTime').textContent = 'Error loading';
      }
    }


    // ============================================
    // CRM FUNCTIONALITY
    // ============================================

    // CRM Data Store (in-memory cache, backed by API/Redis)
    let crmShops = [];
    let crmActivities = [];
    let crmCurrentView = 'pipeline';
    let crmSearchQuery = '';
    let crmStageFilter = 'all';
    let crmSortBy = 'lastContact';
    let crmEditingShopId = null;
    let crmLoading = false;

    // API base URL
    const CRM_API_URL = '/api/shops';

    // Pipeline stages in order
    const CRM_STAGES = ['prospect', 'qualified', 'demo', 'proposal', 'customer'];
    const CRM_STAGE_LABELS = {
      prospect: 'Prospect',
      qualified: 'Qualified',
      demo: 'Demo Scheduled',
      proposal: 'Proposal Sent',
      customer: 'Customer'
    };

    // Initialize CRM
    async function initCrm() {
      await loadCrmData();
      renderCrm();
      updateCrmStats();
    }

    // Load CRM data from API
    async function loadCrmData() {
      crmLoading = true;
      try {
        // Fetch shops
        const shopsRes = await fetch(CRM_API_URL);
        const shopsData = await shopsRes.json();
        crmShops = shopsData.shops || [];

        // Fetch all activities
        const activitiesRes = await fetch(`${CRM_API_URL}?activities=true`);
        const activitiesData = await activitiesRes.json();
        crmActivities = activitiesData.activities || [];

        console.log(`CRM loaded: ${crmShops.length} shops, ${crmActivities.length} activities`);
      } catch (e) {
        console.error('Failed to load CRM data from API:', e);
        crmShops = [];
        crmActivities = [];
      }
      crmLoading = false;
    }

    // Save shop to API
    async function saveShop(shopData) {
      try {
        const res = await fetch(CRM_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(shopData)
        });
        const data = await res.json();
        if (data.success) {
          // Update local cache
          const index = crmShops.findIndex(s => s.id === data.shop.id);
          if (index !== -1) {
            crmShops[index] = data.shop;
          } else {
            crmShops.push(data.shop);
          }
        }
        return data;
      } catch (e) {
        console.error('Failed to save shop:', e);
        return { success: false, error: e.message };
      }
    }

    // Delete shop from API
    async function deleteShopFromApi(shopId) {
      try {
        const res = await fetch(`${CRM_API_URL}?id=${shopId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          crmShops = crmShops.filter(s => s.id !== shopId);
          crmActivities = crmActivities.filter(a => a.shopId !== shopId);
        }
        return data;
      } catch (e) {
        console.error('Failed to delete shop:', e);
        return { success: false, error: e.message };
      }
    }

    // Save activity to API
    async function saveActivity(activityData) {
      try {
        const res = await fetch(CRM_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...activityData, activity: true })
        });
        const data = await res.json();
        if (data.success && data.activity) {
          crmActivities.unshift(data.activity);
        }
        return data;
      } catch (e) {
        console.error('Failed to save activity:', e);
        return { success: false, error: e.message };
      }
    }

    // Render CRM based on current view
    function renderCrm() {
      if (crmCurrentView === 'pipeline') {
        renderCrmPipeline();
      } else {
        renderCrmList();
      }
    }

    // Render pipeline (Kanban) view
    function renderCrmPipeline() {
      // Map stage names to element IDs (capitalize first letter)
      const stageToId = {
        prospect: 'pipelineProspect',
        qualified: 'pipelineQualified',
        demo: 'pipelineDemo',
        proposal: 'pipelineProposal',
        customer: 'pipelineCustomer'
      };

      CRM_STAGES.forEach(stage => {
        const column = document.getElementById(stageToId[stage]);
        if (!column) {
          console.log('CRM: Column not found for stage:', stage);
          return;
        }

        const shopsInStage = getFilteredShops().filter(s => s.stage === stage);

        if (shopsInStage.length === 0) {
          column.innerHTML = '<div class="crm-empty-column">No shops in this stage</div>';
        } else {
          column.innerHTML = shopsInStage.map(shop => createShopCard(shop)).join('');
        }

        // Update column count
        const countEl = document.getElementById(`pipeline${stage.charAt(0).toUpperCase() + stage.slice(1)}Count`);
        if (countEl) {
          countEl.textContent = shopsInStage.length;
        }
      });

      // Update header stats
      document.getElementById('crmTotalShops').textContent = crmShops.length;
      document.getElementById('crmProspects').textContent = crmShops.filter(s => s.stage === 'prospect').length;
      document.getElementById('crmQualified').textContent = crmShops.filter(s => s.stage === 'qualified').length;
      document.getElementById('crmDemo').textContent = crmShops.filter(s => s.stage === 'demo').length;
      document.getElementById('crmCustomers').textContent = crmShops.filter(s => s.stage === 'customer').length;

      // Update health stats (NEW - from API)
      const avgHealth = crmShops.length > 0
        ? Math.round(crmShops.reduce((sum, s) => sum + (s.healthScore || 50), 0) / crmShops.length)
        : 0;
      const overdueCount = crmShops.filter(s => s.isOverdue).length;
      document.getElementById('crmAvgHealth').textContent = avgHealth;
      document.getElementById('crmOverdue').textContent = overdueCount;

      // Color-code health indicator
      const healthEl = document.getElementById('healthIndicator');
      if (healthEl) {
        if (avgHealth >= 80) {
          healthEl.style.borderColor = '#22c55e';
          healthEl.style.background = 'rgba(34, 197, 94, 0.1)';
          document.getElementById('crmAvgHealth').style.color = '#22c55e';
        } else if (avgHealth >= 60) {
          healthEl.style.borderColor = '#f59e0b';
          healthEl.style.background = 'rgba(245, 158, 11, 0.1)';
          document.getElementById('crmAvgHealth').style.color = '#f59e0b';
        } else {
          healthEl.style.borderColor = '#ef4444';
          healthEl.style.background = 'rgba(239, 68, 68, 0.1)';
          document.getElementById('crmAvgHealth').style.color = '#ef4444';
        }
      }
    }

    // Render list view
    function renderCrmList() {
      const listBody = document.getElementById('crmListBody');
      if (!listBody) return;

      const shops = getFilteredShops();

      if (shops.length === 0) {
        listBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 40px;">No shops found</td></tr>';
        return;
      }

      listBody.innerHTML = shops.map(shop => `
        <tr onclick="openShopDetail('${shop.id}')" style="cursor: pointer;">
          <td>
            <div style="font-weight: 500;">${escapeHtml(shop.name || 'Unnamed')}</div>
            <div style="font-size: 11px; color: var(--text-secondary);">${escapeHtml(shop.city || '')}, ${escapeHtml(shop.state || '')}</div>
          </td>
          <td>${escapeHtml(shop.contactName || '-')}</td>
          <td><span class="crm-stage-badge stage-${shop.stage}">${CRM_STAGE_LABELS[shop.stage] || shop.stage}</span></td>
          <td>$${shop.estMonthlyValue || 0}/mo</td>
          <td>${formatTimeAgo(shop.lastContact)}</td>
          <td>${getAssigneeName(shop.assignedTo)}</td>
        </tr>
      `).join('');
    }

    // Create shop card for pipeline view
    function createShopCard(shop) {
      const lastActivity = crmActivities.find(a => a.shopId === shop.id);
      const activityIcon = lastActivity ? getActivityIcon(lastActivity.type) : '';

      // Health score indicator (NEW)
      const healthColor = shop.healthScore >= 80 ? '#22c55e'
        : shop.healthScore >= 60 ? '#f59e0b'
        : shop.healthScore >= 40 ? '#ef4444' : '#991b1b';
      const healthLabel = shop.healthLabel || (shop.healthScore >= 80 ? 'hot' : shop.healthScore >= 60 ? 'warm' : 'cold');

      // Next action display (NEW)
      const nextActionHtml = shop.nextAction
        ? `<div class="crm-next-action ${shop.isOverdue ? 'overdue' : ''}">${shop.isOverdue ? ' ' : ''}${escapeHtml(shop.nextAction)}</div>`
        : '';

      return `
        <div class="crm-shop-card ${shop.isOverdue ? 'card-overdue' : ''}" onclick="openShopDetail('${shop.id}')">
          <div class="crm-shop-header">
            <span class="crm-shop-name">${escapeHtml(shop.name || 'Unnamed')}</span>
            <span class="crm-health-badge" style="background: ${healthColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${shop.healthScore || '--'}</span>
          </div>
          <div class="crm-shop-contact">${escapeHtml(shop.contactName || 'No contact')}${shop.contactRole ? '  ' + escapeHtml(shop.contactRole) : ''}</div>
          ${nextActionHtml}
          <div class="crm-shop-meta">
            <span>${shop.bays || 0} bays  ${shop.technicians || 0} techs</span>
            <span>$${shop.estMonthlyValue || 0}/mo</span>
          </div>
          <div class="crm-shop-footer">
            <span class="crm-assignee">${getAssigneeName(shop.assignedTo)}</span>
            <span class="crm-last-contact">${activityIcon} ${shop.daysSinceContact !== undefined ? shop.daysSinceContact + 'd ago' : formatTimeAgo(shop.lastContact)}</span>
          </div>
        </div>
      `;
    }

    // Get filtered and sorted shops
    function getFilteredShops() {
      let shops = [...crmShops];

      // Apply search filter
      if (crmSearchQuery) {
        const query = crmSearchQuery.toLowerCase();
        shops = shops.filter(s =>
          s.name.toLowerCase().includes(query) ||
          s.contactName.toLowerCase().includes(query) ||
          s.city.toLowerCase().includes(query) ||
          s.contactEmail.toLowerCase().includes(query)
        );
      }

      // Apply stage filter
      if (crmStageFilter !== 'all') {
        shops = shops.filter(s => s.stage === crmStageFilter);
      }

      // Apply sorting
      shops.sort((a, b) => {
        switch (crmSortBy) {
          case 'name':
            return a.name.localeCompare(b.name);
          case 'value':
            return b.estMonthlyValue - a.estMonthlyValue;
          case 'lastContact':
          default:
            return new Date(b.lastContact) - new Date(a.lastContact);
        }
      });

      return shops;
    }

    // Update CRM stats in header
    function updateCrmStats() {
      const totalShops = crmShops.length;
      const totalPipeline = crmShops.filter(s => s.stage !== 'customer').reduce((sum, s) => sum + s.estMonthlyValue, 0);
      const totalMrr = crmShops.filter(s => s.stage === 'customer').reduce((sum, s) => sum + s.estMonthlyValue, 0);
      const avgDealSize = totalShops > 0 ? Math.round(crmShops.reduce((sum, s) => sum + s.estMonthlyValue, 0) / totalShops) : 0;

      const statsEl = document.getElementById('crmStatsValue');
      if (statsEl) {
        statsEl.innerHTML = `
          <span>${totalShops} shops</span>
          <span></span>
          <span>$${totalPipeline.toLocaleString()} pipeline</span>
          <span></span>
          <span>$${totalMrr.toLocaleString()} MRR</span>
        `;
      }
    }

    // View switching
    function switchCrmView(view) {
      crmCurrentView = view;

      // Update view mode select if it exists
      const viewSelect = document.getElementById('crmViewMode');
      if (viewSelect) viewSelect.value = view;

      // Toggle view visibility
      const pipelineEl = document.getElementById('crmPipeline');
      const listEl = document.getElementById('crmListView');

      if (pipelineEl) pipelineEl.style.display = view === 'pipeline' ? 'flex' : 'none';
      if (listEl) listEl.style.display = view === 'list' ? 'block' : 'none';

      renderCrm();
    }

    // Search handler
    function handleCrmSearch(query) {
      crmSearchQuery = query;
      renderCrm();
    }

    // Filter shops (alias for search - used by HTML)
    function filterShops(query) {
      handleCrmSearch(query);
    }

    // Stage filter handler
    function handleCrmStageFilter(stage) {
      crmStageFilter = stage;
      renderCrm();
    }

    // Sort handler
    function handleCrmSort(sortBy) {
      crmSortBy = sortBy;
      renderCrm();
    }

    // Open add shop modal
    function openAddShopModal() {
      crmEditingShopId = null;
      document.getElementById('shopModalTitle').textContent = 'Add New Shop';
      document.getElementById('shopForm').reset();
      // Show overlay and modal
      document.getElementById('shopModalOverlay').style.display = 'flex';
      document.getElementById('shopModal').style.display = 'flex';
    }

    // Open edit shop modal
    function openEditShopModal(shopId) {
      const shop = crmShops.find(s => s.id === shopId);
      if (!shop) return;

      crmEditingShopId = shopId;
      document.getElementById('shopModalTitle').textContent = 'Edit Shop';

      // Populate form fields - Basic info
      document.getElementById('shopName').value = shop.name;
      document.getElementById('shopAddress').value = shop.address || '';
      document.getElementById('shopCity').value = shop.city || '';
      document.getElementById('shopState').value = shop.state || '';
      document.getElementById('shopZip').value = shop.zip || '';
      document.getElementById('shopStage').value = shop.stage;
      // Shop details
      document.getElementById('shopBays').value = shop.bays || '';
      document.getElementById('shopTechnicians').value = shop.technicians || '';
      document.getElementById('shopSpecialty').value = shop.specialty || '';
      document.getElementById('shopMonthlyVolume').value = shop.monthlyVolume || '';
      document.getElementById('shopDealerCompetition').value = shop.dealerCompetition || '';
      // Contact
      document.getElementById('contactName').value = shop.contactName || '';
      document.getElementById('contactRole').value = shop.contactRole || 'owner';
      document.getElementById('contactEmail').value = shop.contactEmail || '';
      document.getElementById('contactPhone').value = shop.contactPhone || '';
      // Sales & pipeline
      document.getElementById('shopSource').value = shop.leadSource || '';
      document.getElementById('shopAssigned').value = shop.assignedTo || 'tyler';
      // Subscription & devices
      document.getElementById('shopSubscriptionStatus').value = shop.subscriptionStatus || '';
      document.getElementById('shopMonthlyRate').value = shop.monthlyRate || '';
      document.getElementById('shopDevicesNeeded').value = shop.devicesNeeded || '';
      document.getElementById('shopDevicesDeployed').value = shop.devicesDeployed || '';
      document.getElementById('shopContractStart').value = shop.contractStart || '';
      document.getElementById('shopContractEnd').value = shop.contractEnd || '';
      // Financials
      document.getElementById('shopEstValue').value = shop.estMonthlyValue || '';
      document.getElementById('shopLifetimeValue').value = shop.lifetimeValue || '';
      // Notes
      document.getElementById('shopNotes').value = shop.notes || '';

      // Show the modal overlay (need to show both overlay and modal)
      document.getElementById('shopModalOverlay').style.display = 'flex';
      document.getElementById('shopModal').style.display = 'flex';
    }

    // Close shop modal
    function closeShopModal() {
      document.getElementById('shopModalOverlay').style.display = 'none';
      document.getElementById('shopModal').style.display = 'none';
      crmEditingShopId = null;
    }

    // Handle shop form submit
    async function handleShopSubmit(event) {
      event.preventDefault();

      const shopData = {
        // Basic info
        name: document.getElementById('shopName').value,
        address: document.getElementById('shopAddress').value,
        city: document.getElementById('shopCity').value,
        state: document.getElementById('shopState').value,
        zip: document.getElementById('shopZip').value,
        // Shop details
        bays: parseInt(document.getElementById('shopBays').value) || 0,
        technicians: parseInt(document.getElementById('shopTechnicians').value) || 0,
        specialty: document.getElementById('shopSpecialty').value || 'general',
        monthlyVolume: parseInt(document.getElementById('shopMonthlyVolume').value) || 0,
        dealerCompetition: document.getElementById('shopDealerCompetition').value || '',
        // Contact
        contactName: document.getElementById('contactName').value,
        contactRole: document.getElementById('contactRole').value || 'owner',
        contactEmail: document.getElementById('contactEmail').value,
        contactPhone: document.getElementById('contactPhone').value,
        // Sales & pipeline
        leadSource: document.getElementById('shopSource').value || '',
        assignedTo: document.getElementById('shopAssigned').value || 'tyler',
        stage: document.getElementById('shopStage').value,
        // Subscription & devices
        subscriptionStatus: document.getElementById('shopSubscriptionStatus').value || '',
        monthlyRate: parseFloat(document.getElementById('shopMonthlyRate').value) || 0,
        devicesNeeded: parseInt(document.getElementById('shopDevicesNeeded').value) || 0,
        devicesDeployed: parseInt(document.getElementById('shopDevicesDeployed').value) || 0,
        contractStart: document.getElementById('shopContractStart').value || '',
        contractEnd: document.getElementById('shopContractEnd').value || '',
        // Financials
        estMonthlyValue: parseInt(document.getElementById('shopEstValue').value) || 0,
        lifetimeValue: parseInt(document.getElementById('shopLifetimeValue').value) || 0,
        // Notes
        notes: document.getElementById('shopNotes').value
      };

      // Include ID if editing
      if (crmEditingShopId) {
        shopData.id = crmEditingShopId;
      }

      const isNew = !crmEditingShopId;
      const result = await saveShop(shopData);

      if (result.success) {
        // Log activity for new shops
        if (isNew && result.shop) {
          await saveActivity({
            shopId: result.shop.id,
            type: 'note',
            author: shopData.assignedTo || 'system',
            content: 'Created new shop record'
          });
        }
        closeShopModal();
        renderCrm();
        updateCrmStats();
      } else {
        alert('Failed to save shop: ' + (result.error || 'Unknown error'));
      }
    }

    // Open shop detail modal
    function openShopDetail(shopId) {
      const shop = crmShops.find(s => s.id === shopId);
      if (!shop) return;

      // Store current shop ID for actions
      window.currentShopId = shopId;

      // Populate header
      const nameEl = document.getElementById('shopDetailName');
      const stageEl = document.getElementById('shopDetailStage');
      if (nameEl) nameEl.textContent = shop.name;
      if (stageEl) {
        stageEl.textContent = CRM_STAGE_LABELS[shop.stage] || shop.stage;
        stageEl.className = 'crm-stage-badge stage-' + shop.stage;
      }

      // Populate shop details
      const address = `${shop.address || ''}, ${shop.city || ''}, ${shop.state || ''} ${shop.zip || ''}`;
      document.getElementById('detailAddress').textContent = address.trim() || '--';
      document.getElementById('detailBays').textContent = shop.bays || '--';
      document.getElementById('detailTechnicians').textContent = shop.technicians || '--';
      document.getElementById('detailSpecialty').textContent = getSpecialtyLabel(shop.specialty) || '--';
      document.getElementById('detailVolume').textContent = shop.monthlyVolume ? `${shop.monthlyVolume} cars/mo` : '--';
      document.getElementById('detailCompetition').textContent = shop.dealerCompetition ?
        shop.dealerCompetition.charAt(0).toUpperCase() + shop.dealerCompetition.slice(1) : '--';

      // Populate contact details
      document.getElementById('detailContactName').textContent = shop.contactName || '--';
      document.getElementById('detailContactRole').textContent = shop.contactRole || '--';
      const emailEl = document.getElementById('detailContactEmail');
      const phoneEl = document.getElementById('detailContactPhone');
      if (emailEl) {
        emailEl.textContent = shop.contactEmail || '--';
        emailEl.href = shop.contactEmail ? `mailto:${shop.contactEmail}` : '#';
      }
      if (phoneEl) {
        phoneEl.textContent = shop.contactPhone || '--';
        phoneEl.href = shop.contactPhone ? `tel:${shop.contactPhone}` : '#';
      }

      // Populate sales & pipeline
      document.getElementById('detailSource').textContent = getLeadSourceLabel(shop.leadSource) || '--';
      document.getElementById('detailAssigned').textContent = getAssigneeName(shop.assignedTo) || '--';

      // Populate subscription & devices
      document.getElementById('detailSubscriptionStatus').textContent = getSubscriptionStatusLabel(shop.subscriptionStatus) || '--';
      document.getElementById('detailMonthlyRate').textContent = shop.monthlyRate ? `$${shop.monthlyRate}/mo` : '--';
      document.getElementById('detailDevicesDeployed').textContent = shop.devicesDeployed || '0';
      document.getElementById('detailDevices').textContent = shop.devicesNeeded || '--';
      document.getElementById('detailContractStart').textContent = shop.contractStart ? formatDate(shop.contractStart) : '--';
      document.getElementById('detailContractEnd').textContent = shop.contractEnd ? formatDate(shop.contractEnd) : 'Month-to-month';

      // Populate financials
      document.getElementById('detailValue').textContent = shop.estMonthlyValue ? `$${shop.estMonthlyValue}/mo` : '--';
      document.getElementById('detailLifetimeValue').textContent = shop.lifetimeValue ? `$${shop.lifetimeValue.toLocaleString()}` : '$0';

      // Populate notes
      document.getElementById('detailNotes').textContent = shop.notes || '--';

      // Populate activity timeline
      renderShopActivities(shopId);

      // Show the modal
      const overlay = document.getElementById('shopDetailOverlay');
      if (overlay) overlay.style.display = 'flex';
      document.getElementById('shopDetailModal').style.display = 'flex';
      document.getElementById('shopDetailModal').dataset.shopId = shopId;
    }

    // Close shop detail modal
    function closeShopDetail() {
      const overlay = document.getElementById('shopDetailOverlay');
      if (overlay) overlay.style.display = 'none';
      document.getElementById('shopDetailModal').style.display = 'none';
    }

    // Render activity timeline for a shop
    function renderShopActivities(shopId) {
      const container = document.getElementById('shopActivityTimeline') || document.getElementById('detailActivityTimeline');
      const activities = crmActivities.filter(a => a.shopId === shopId).sort((a, b) =>
        new Date(b.timestamp) - new Date(a.timestamp)
      );

      if (activities.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No activities logged yet</div>';
        return;
      }

      container.innerHTML = activities.map(activity => `
        <div class="activity-timeline-item">
          <div class="activity-icon ${activity.type}">${getActivityIcon(activity.type)}</div>
          <div class="activity-content">
            <div class="activity-header">
              <span class="activity-type">${getActivityTypeLabel(activity.type)}</span>
              <span class="activity-time">${formatDateTime(activity.timestamp)}</span>
            </div>
            <div class="activity-text">${escapeHtml(activity.content)}</div>
            <div class="activity-author">by ${getAssigneeName(activity.author)}</div>
          </div>
        </div>
      `).join('');
    }

    // Open activity log modal
    function openActivityModal(shopId) {
      document.getElementById('activityShopId').value = shopId;
      document.getElementById('activityForm').reset();
      document.getElementById('activityModalOverlay').style.display = 'flex';
    }

    // Close activity modal
    function closeActivityModal() {
      document.getElementById('activityModalOverlay').style.display = 'none';
    }

    // Handle activity form submit
    async function handleActivitySubmit(event) {
      event.preventDefault();

      const shopId = document.getElementById('activityShopId').value;
      const activityType = document.getElementById('activityType').value;
      const activitySummary = document.getElementById('activitySummary').value;
      const activityNextSteps = document.getElementById('activityNextSteps').value;

      // Combine summary and next steps
      let content = activitySummary;
      if (activityNextSteps) {
        content += '\n\nNext Steps: ' + activityNextSteps;
      }

      await logCrmActivity(shopId, activityType, content);
      closeActivityModal();

      // Refresh detail view if open
      if (document.getElementById('shopDetailModal').style.display !== 'none') {
        renderShopActivities(shopId);
      }
    }

    // Log a CRM activity
    async function logCrmActivity(shopId, type, content) {
      const author = USERNAME.toLowerCase().includes('eli') ? 'eli' :
              USERNAME.toLowerCase().includes('tyler') ? 'tyler' :
              USERNAME.toLowerCase().includes('ryan') ? 'ryan' : 'eli';

      const result = await saveActivity({
        shopId: shopId,
        type: type,
        author: author,
        content: content
      });

      if (result.success) {
        // Update local shop's last contact
        const shop = crmShops.find(s => s.id === shopId);
        if (shop) {
          shop.lastContact = new Date().toISOString();
        }
        renderCrm();
      }
    }

    // Advance shop to next stage
    async function advanceShopStage(shopId) {
      const shop = crmShops.find(s => s.id === shopId);
      if (!shop) return;

      const currentIndex = CRM_STAGES.indexOf(shop.stage);
      if (currentIndex < CRM_STAGES.length - 1) {
        const newStage = CRM_STAGES[currentIndex + 1];

        // Update shop via API
        const result = await saveShop({ id: shopId, stage: newStage });
        if (result.success) {
          await logCrmActivity(shopId, 'note', `Advanced to ${CRM_STAGE_LABELS[newStage]} stage`);
          closeShopDetail();
          renderCrm();
          updateCrmStats();
        }
      }
    }

    // Delete shop
    async function deleteShop(shopId) {
      if (!confirm('Are you sure you want to delete this shop? This cannot be undone.')) return;

      const result = await deleteShopFromApi(shopId);
      if (result.success) {
        closeShopDetail();
        renderCrm();
        updateCrmStats();
      } else {
        alert('Failed to delete shop: ' + (result.error || 'Unknown error'));
      }
    }

    // Helper functions
    function getAssigneeName(id) {
      const names = {
        eli: 'Eli',
        tyler: 'Tyler',
        ryan: 'Ryan'
      };
      return names[id] || id;
    }

    function getSubscriptionStatusLabel(status) {
      const labels = {
        '': 'Not Started',
        'trial': 'Trial',
        'active': 'Active',
        'paused': 'Paused',
        'cancelled': 'Cancelled'
      };
      return labels[status] || status || 'Not Started';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '--';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function getSpecialtyLabel(specialty) {
      const labels = {
        general: 'General Repair',
        european: 'European Imports',
        asian: 'Asian Imports',
        domestic: 'Domestic Vehicles',
        diesel: 'Diesel',
        transmission: 'Transmission',
        'oil-change': 'Oil Change/Quick Lube',
        collision: 'Collision/Body',
        tire: 'Tire & Alignment'
      };
      return labels[specialty] || specialty;
    }

    function getLeadSourceLabel(source) {
      const labels = {
        founder: 'Founder',
        referral: 'Referral',
        'cold-call': 'Cold Call',
        website: 'Website',
        'trade-show': 'Trade Show',
        linkedin: 'LinkedIn',
        advertising: 'Advertising',
        partner: 'Partner',
        inbound: 'Inbound Inquiry',
        other: 'Other'
      };
      return labels[source] || source;
    }

    function getActivityIcon(type) {
      const icons = {
        call: '',
        email: '',
        meeting: '',
        demo: '',
        note: '',
        proposal: ''
      };
      return icons[type] || '';
    }

    function getActivityTypeLabel(type) {
      const labels = {
        call: 'Phone Call',
        email: 'Email',
        meeting: 'Meeting',
        demo: 'Demo',
        note: 'Note',
        proposal: 'Proposal'
      };
      return labels[type] || type;
    }

    function formatTimeAgo(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'N/A';

      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 60) return diffMins + 'm ago';
      if (diffHours < 24) return diffHours + 'h ago';
      if (diffDays < 7) return diffDays + 'd ago';
      return date.toLocaleDateString();
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Make functions globally available
    window.switchCrmView = switchCrmView;
    window.handleCrmSearch = handleCrmSearch;
    window.handleCrmStageFilter = handleCrmStageFilter;
    window.handleCrmSort = handleCrmSort;
    window.openAddShopModal = openAddShopModal;
    window.openEditShopModal = openEditShopModal;
    window.closeShopModal = closeShopModal;
    window.handleShopSubmit = handleShopSubmit;
    window.openShopDetail = openShopDetail;
    window.closeShopDetail = closeShopDetail;
    window.openActivityModal = openActivityModal;
    window.closeActivityModal = closeActivityModal;
    window.handleActivitySubmit = handleActivitySubmit;
    window.advanceShopStage = advanceShopStage;
    window.deleteShop = deleteShop;
    window.filterShops = filterShops;
    window.sortCrmList = handleCrmSort;

    // Additional helper functions for the HTML buttons
    window.logActivity = function(type) {
      if (window.currentShopId) {
        openActivityModalWithType(window.currentShopId, type);
      }
    };
    window.scheduleDemo = function() {
      if (window.currentShopId) {
        openActivityModalWithType(window.currentShopId, 'demo');
      }
    };
    window.advanceStage = function() {
      if (window.currentShopId) {
        advanceShopStage(window.currentShopId);
      }
    };
    window.editCurrentShop = function() {
      if (window.currentShopId) {
        closeShopDetail();
        openEditShopModal(window.currentShopId);
      }
    };
    window.openAddActivity = function() {
      if (window.currentShopId) {
        openActivityModal(window.currentShopId);
      }
    };

    // Open activity modal with pre-selected type
    function openActivityModalWithType(shopId, type) {
      // Check if there's a dedicated activity modal
      const activityModal = document.getElementById('activityModal');
      if (activityModal) {
        document.getElementById('activityShopId').value = shopId;
        document.getElementById('activityType').value = type;
        activityModal.style.display = 'flex';
      } else {
        // Fallback: just log a note
        const content = prompt(`Enter ${type} details:`);
        if (content) {
          logCrmActivity(shopId, type, content);
          if (document.getElementById('shopDetailModal').style.display !== 'none') {
            renderShopActivities(shopId);
          }
        }
      }
    }

    // ============================================
    // END CRM FUNCTIONALITY
    // ============================================

    // ============================================
    // SALES ENGINEERING FUNCTIONALITY
    // ============================================

    const SALES_API_URL = '/api/sales-files';
    let salesFiles = [];
    let salesCurrentFolder = null;
    let salesSelectedTemplate = null;
    let salesChatHistory = [];

    function initSalesEng() {
      fetchSalesFiles();
      setupSalesFolderListeners();
    }

    async function fetchSalesFiles() {
      try {
        const res = await fetch(SALES_API_URL);
        if (res.ok) {
          const data = await res.json();
          salesFiles = data.files || [];
          updateSalesFolderCounts();
          updateSalesStats();
        }
      } catch (err) {
        console.error('Failed to fetch sales files:', err);
        // Use mock data for now
        salesFiles = [];
      }
    }

    function updateSalesFolderCounts() {
      const counts = {
        proposals: salesFiles.filter(f => f.folder === 'proposals').length,
        'pitch-decks': salesFiles.filter(f => f.folder === 'pitch-decks').length,
        emails: salesFiles.filter(f => f.folder === 'emails').length,
        'one-pagers': salesFiles.filter(f => f.folder === 'one-pagers').length,
        demos: salesFiles.filter(f => f.folder === 'demos').length,
        'case-studies': salesFiles.filter(f => f.folder === 'case-studies').length,
        other: salesFiles.filter(f => f.folder === 'other').length
      };

      document.getElementById('folderProposalsCount').textContent = counts.proposals;
      document.getElementById('folderPitchCount').textContent = counts['pitch-decks'];
      document.getElementById('folderEmailsCount').textContent = counts.emails;
      document.getElementById('folderOnePagersCount').textContent = counts['one-pagers'];
      document.getElementById('folderDemosCount').textContent = counts.demos;
      document.getElementById('folderCaseStudiesCount').textContent = counts['case-studies'];
      document.getElementById('folderOtherCount').textContent = counts.other;
    }

    function updateSalesStats() {
      document.getElementById('salesTotalDocs').textContent = salesFiles.length;
      const todayFiles = salesFiles.filter(f => {
        const today = new Date().toDateString();
        return new Date(f.createdAt).toDateString() === today;
      });
      document.getElementById('salesGenerated').textContent = todayFiles.length;
    }

    function setupSalesFolderListeners() {
      document.querySelectorAll('.sales-folder').forEach(folder => {
        folder.addEventListener('click', () => {
          document.querySelectorAll('.sales-folder').forEach(f => f.classList.remove('active'));
          folder.classList.add('active');
          salesCurrentFolder = folder.dataset.folder;
          renderSalesFiles(salesCurrentFolder);
        });
      });
    }

    function renderSalesFiles(folderName) {
      const filesList = document.getElementById('salesFilesList');
      const files = salesFiles.filter(f => f.folder === folderName);

      if (files.length === 0) {
        filesList.innerHTML = '<div class="sales-file-empty">No files in this folder</div>';
        return;
      }

      filesList.innerHTML = files.map(file => `
        <div class="sales-file-item" onclick="openSalesFile('${file.id}')">
          <span class="sales-file-icon">${getFileIcon(file.type)}</span>
          <span class="sales-file-name">${file.name}</span>
          <span class="sales-file-date">${formatDate(file.createdAt)}</span>
        </div>
      `).join('');
    }

    function getFileIcon(type) {
      const icons = {
        'pitch-deck': '',
        'proposal': '',
        'one-pager': '',
        'email': '',
        'demo-script': '',
        'case-study': '',
        'other': '',
        'blank': ''
      };
      return icons[type] || '';
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function selectTemplate(templateType) {
      salesSelectedTemplate = templateType;
      const docContent = document.getElementById('salesDocContent');

      // Show template editor
      docContent.innerHTML = `
        <div class="template-editor">
          <div style="margin-bottom: 16px;">
            <span style="font-size: 32px;">${getFileIcon(templateType)}</span>
            <h3 style="margin: 8px 0; font-size: 18px;">${templateType.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-secondary);">Document Name</label>
            <input type="text" id="salesDocName" placeholder="Enter document name..." style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);" />
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-secondary);">Customer/Target (optional)</label>
            <input type="text" id="salesDocTarget" placeholder="e.g., ABC Auto Shop" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);" />
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-secondary);">Additional Notes</label>
            <textarea id="salesDocNotes" rows="4" placeholder="Any specific requirements or talking points..." style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); resize: vertical;"></textarea>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="generateDocument()" style="flex: 1; background: var(--accent); color: white; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;"> Generate with AI</button>
            <button onclick="showTemplateGrid()" style="background: var(--bg-tertiary); color: var(--text-primary); padding: 14px 20px; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
          </div>
        </div>
      `;
    }

    function showTemplateGrid() {
      salesSelectedTemplate = null;
      currentEditingFile = null;
      const docContent = document.getElementById('salesDocContent');
      docContent.innerHTML = `
        <div class="sales-template-grid">
          <div class="sales-template-card" onclick="selectTemplate('pitch-deck')">
            <div class="template-icon"></div>
            <div class="template-name">Pitch Deck</div>
            <div class="template-desc">Investor & partner presentations</div>
          </div>
          <div class="sales-template-card" onclick="selectTemplate('proposal')">
            <div class="template-icon"></div>
            <div class="template-name">Proposal</div>
            <div class="template-desc">Customer proposals & quotes</div>
          </div>
          <div class="sales-template-card" onclick="selectTemplate('one-pager')">
            <div class="template-icon"></div>
            <div class="template-name">One-Pager</div>
            <div class="template-desc">Product overview sheets</div>
          </div>
          <div class="sales-template-card" onclick="selectTemplate('email')">
            <div class="template-icon"></div>
            <div class="template-name">Email Template</div>
            <div class="template-desc">Follow-up & outreach emails</div>
          </div>
          <div class="sales-template-card" onclick="selectTemplate('demo-script')">
            <div class="template-icon"></div>
            <div class="template-name">Demo Script</div>
            <div class="template-desc">Product demo talking points</div>
          </div>
          <div class="sales-template-card" onclick="selectTemplate('case-study')">
            <div class="template-icon"></div>
            <div class="template-name">Case Study</div>
            <div class="template-desc">Customer success stories</div>
          </div>
          <div class="sales-template-card" onclick="selectTemplate('other')">
            <div class="template-icon"></div>
            <div class="template-name">Other Document</div>
            <div class="template-desc">Custom documents & notes</div>
          </div>
          <div class="sales-template-card blank" onclick="openBlankEditor()">
            <div class="template-icon"></div>
            <div class="template-name">Blank Document</div>
            <div class="template-desc">Start from scratch</div>
          </div>
        </div>
      `;
    }

    async function generateDocument() {
      const name = document.getElementById('salesDocName')?.value || 'Untitled';
      const target = document.getElementById('salesDocTarget')?.value || '';
      const notes = document.getElementById('salesDocNotes')?.value || '';

      if (!name.trim()) {
        alert('Please enter a document name');
        return;
      }

      // Add loading state
      const docContent = document.getElementById('salesDocContent');
      docContent.innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
          <div style="font-size: 48px; margin-bottom: 20px; animation: pulse 1.5s ease-in-out infinite;"></div>
          <h3 style="margin-bottom: 10px;">Generating with Claude AI...</h3>
          <p style="color: var(--text-secondary);">Creating your ${salesSelectedTemplate.replace(/-/g, ' ')}${target ? ` for ${target}` : ''}</p>
          <p style="color: var(--text-secondary); font-size: 12px; margin-top: 10px;">Fetching company context and generating intelligent content...</p>
        </div>
        <style>@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }</style>
      `;

      try {
        // Call the AI-powered generation API
        const res = await fetch('/api/generate-sales-doc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: salesSelectedTemplate,
            name,
            target,
            notes,
            createdBy: 'eli'
          })
        });

        const data = await res.json();
        console.log('[Sales Eng] Generation response:', { ok: res.ok, success: data.success, file: data.file?.id });

        if (res.ok && data.success) {
          // Add to local files array
          salesFiles.push(data.file);
          updateSalesFolderCounts();
          updateSalesStats();

          // Show the generated document in edit mode
          currentEditingFile = data.file;
          docContent.innerHTML = `
            <div class="file-editor">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 24px;">${getFileIcon(data.file.type)}</span>
                  <input type="text" id="editFileName" value="${escapeHtml(data.file.name)}" style="font-size: 18px; font-weight: 600; background: transparent; border: none; color: var(--text-primary); border-bottom: 1px solid transparent; padding: 4px 0;" onfocus="this.style.borderBottomColor='var(--accent)'" onblur="this.style.borderBottomColor='transparent'" />
                  <span style="background: var(--success); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">AI GENERATED</span>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="saveCurrentDoc()" style="background: var(--success); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Save</button>
                  <button onclick="previewDoc()" style="background: var(--accent); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">Preview</button>
                  <button onclick="downloadDoc()" style="background: var(--bg-tertiary); padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">Download</button>
                  <button onclick="showTemplateGrid()" style="background: var(--bg-tertiary); padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">New Doc</button>
                </div>
              </div>
              <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                <select id="editFileFolder" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                  <option value="proposals" ${data.file.folder === 'proposals' ? 'selected' : ''}>Proposals</option>
                  <option value="pitch-decks" ${data.file.folder === 'pitch-decks' ? 'selected' : ''}>Pitch Decks</option>
                  <option value="emails" ${data.file.folder === 'emails' ? 'selected' : ''}>Email Templates</option>
                  <option value="one-pagers" ${data.file.folder === 'one-pagers' ? 'selected' : ''}>One-Pagers</option>
                  <option value="demos" ${data.file.folder === 'demos' ? 'selected' : ''}>Demo Scripts</option>
                  <option value="case-studies" ${data.file.folder === 'case-studies' ? 'selected' : ''}>Case Studies</option>
                  <option value="other" ${data.file.folder === 'other' ? 'selected' : ''}>Other</option>
                </select>
                ${target ? `<span style="color: var(--text-secondary); font-size: 12px; align-self: center;">Target: ${escapeHtml(target)}</span>` : ''}
              </div>
              <textarea id="editFileContent" style="width: 100%; height: calc(100% - 120px); min-height: 400px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; line-height: 1.6; resize: vertical; font-family: inherit;">${escapeHtml(data.content || data.file.content)}</textarea>
            </div>
          `;

          // Also post to chat for team visibility
          fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              author: 'eli',
              authorType: 'human',
              message: `[Sales Engineering] Generated ${salesSelectedTemplate}: "${name}"${target ? ` for ${target}` : ''}`
            })
          }).catch(() => {}); // Don't block on chat
        } else {
          // Handle error or fallback
          const errorMsg = data.error || 'Unknown error';
          if (errorMsg.includes('not configured')) {
            // Fallback to template-based generation
            docContent.innerHTML = `
              <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;"></div>
                <h3 style="margin-bottom: 10px;">AI Generation Unavailable</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">${errorMsg}</p>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Using template-based generation instead...</p>
              </div>
            `;
            // Fallback to old generate-doc API
            setTimeout(() => fallbackGenerate(name, target, notes), 1500);
          } else {
            docContent.innerHTML = `
              <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;"></div>
                <h3 style="margin-bottom: 10px;">Generation Failed</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">${escapeHtml(errorMsg)}</p>
                <button onclick="showTemplateGrid()" style="background: var(--accent); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Try Again</button>
              </div>
            `;
          }
        }
      } catch (err) {
        console.error('Generation error:', err);
        docContent.innerHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;"></div>
            <h3 style="margin-bottom: 10px;">Network Error</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Could not reach the generation API</p>
            <button onclick="showTemplateGrid()" style="background: var(--accent); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Try Again</button>
          </div>
        `;
      }
    }

    // Fallback to template-based generation if AI is unavailable
    async function fallbackGenerate(name, target, notes) {
      try {
        const res = await fetch('/api/generate-doc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: salesSelectedTemplate.replace(/-/g, '_'),
            target: target ? 'shop-owner' : 'general',
            prompt: `${name}${notes ? ': ' + notes : ''}`,
            customization: { shopName: target || 'Customer' },
            requestedBy: 'eli'
          })
        });
        const data = await res.json();
        if (data.content) {
          // Save to sales-files
          const saveRes = await fetch('/api/sales-files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name,
              type: salesSelectedTemplate,
              folder: getFolderForType(salesSelectedTemplate),
              content: data.content,
              target,
              notes,
              createdBy: 'eli'
            })
          });
          const saveData = await saveRes.json();
          if (saveData.file) {
            salesFiles.push(saveData.file);
            updateSalesFolderCounts();
            updateSalesStats();
            openSalesFile(saveData.file.id);
          }
        }
      } catch (err) {
        console.error('Fallback generation error:', err);
        showTemplateGrid();
      }
    }

    function getFolderForType(type) {
      const folderMap = {
        'pitch-deck': 'pitch-decks',
        'proposal': 'proposals',
        'one-pager': 'one-pagers',
        'email': 'emails',
        'demo-script': 'demos',
        'case-study': 'case-studies',
        'other': 'other',
        'blank': 'other'
      };
      return folderMap[type] || 'other';
    }

    async function sendSalesChat() {
      const input = document.getElementById('salesChatInput');
      const message = input.value.trim();
      if (!message) return;

      // Add user message to chat
      const chatMessages = document.getElementById('salesChatMessages');
      chatMessages.innerHTML += `
        <div class="sales-chat-msg user">
          <div class="sales-msg-avatar"></div>
          <div class="sales-msg-content">${escapeHtml(message)}</div>
        </div>
      `;
      input.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Add typing indicator
      const typingId = 'typing-' + Date.now();
      chatMessages.innerHTML += `
        <div class="sales-chat-msg assistant" id="${typingId}">
          <div class="sales-msg-avatar"></div>
          <div class="sales-msg-content">
            <em>Thinking...</em>
          </div>
        </div>
      `;
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        // Call the chat API
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            author: 'eli',
            authorType: 'human',
            message: `[Sales Engineering Request] ${message}`
          })
        });

        // Simulate AI response for now
        setTimeout(() => {
          const typing = document.getElementById(typingId);
          if (typing) {
            typing.querySelector('.sales-msg-content').innerHTML = `
              <strong>Sales Assistant</strong>
              <p>I've processed your request: "${message.substring(0, 50)}${message.length > 50 ? '...' : ''}"</p>
              <p>The document is being generated. You'll find it in the appropriate folder when ready.</p>
            `;
          }
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 1500);

      } catch (err) {
        console.error('Sales chat error:', err);
        const typing = document.getElementById(typingId);
        if (typing) {
          typing.querySelector('.sales-msg-content').innerHTML = `
            <strong>Sales Assistant</strong>
            <p style="color: var(--danger);">Sorry, I encountered an error. Please try again.</p>
          `;
        }
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let currentEditingFile = null;

    function openSalesFile(fileId) {
      const file = salesFiles.find(f => f.id === fileId);
      if (!file) return;
      currentEditingFile = file;

      const docContent = document.getElementById('salesDocContent');
      docContent.innerHTML = `
        <div class="file-editor">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;">${getFileIcon(file.type)}</span>
              <input type="text" id="editFileName" value="${escapeHtml(file.name)}" style="font-size: 18px; font-weight: 600; background: transparent; border: none; color: var(--text-primary); border-bottom: 1px solid transparent; padding: 4px 0;" onfocus="this.style.borderBottomColor='var(--accent)'" onblur="this.style.borderBottomColor='transparent'" />
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="saveCurrentDoc()" style="background: var(--success); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"> Save</button>
              <button onclick="deleteCurrentDoc()" style="background: var(--danger); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;"></button>
              <button onclick="showTemplateGrid()" style="background: var(--bg-tertiary); padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;"> Back</button>
            </div>
          </div>
          <div style="display: flex; gap: 10px; margin-bottom: 16px;">
            <select id="editFileFolder" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
              <option value="proposals" ${file.folder === 'proposals' ? 'selected' : ''}>Proposals</option>
              <option value="pitch-decks" ${file.folder === 'pitch-decks' ? 'selected' : ''}>Pitch Decks</option>
              <option value="emails" ${file.folder === 'emails' ? 'selected' : ''}>Email Templates</option>
              <option value="one-pagers" ${file.folder === 'one-pagers' ? 'selected' : ''}>One-Pagers</option>
              <option value="demos" ${file.folder === 'demos' ? 'selected' : ''}>Demo Scripts</option>
              <option value="case-studies" ${file.folder === 'case-studies' ? 'selected' : ''}>Case Studies</option>
              <option value="other" ${file.folder === 'other' ? 'selected' : ''}>Other</option>
            </select>
            <span style="color: var(--text-secondary); font-size: 12px; align-self: center;">Created: ${new Date(file.createdAt).toLocaleString()}</span>
          </div>
          <textarea id="editFileContent" style="width: 100%; height: calc(100% - 120px); min-height: 300px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; line-height: 1.6; resize: vertical; font-family: inherit;">${escapeHtml(file.content || '')}</textarea>
        </div>
      `;
    }

    function openBlankEditor() {
      currentEditingFile = null;
      const docContent = document.getElementById('salesDocContent');
      docContent.innerHTML = `
        <div class="file-editor">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;"></span>
              <input type="text" id="editFileName" placeholder="Document name..." style="font-size: 18px; font-weight: 600; background: transparent; border: none; color: var(--text-primary); border-bottom: 1px solid var(--accent); padding: 4px 0; width: 300px;" />
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="saveCurrentDoc()" style="background: var(--success); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"> Save</button>
              <button onclick="showTemplateGrid()" style="background: var(--bg-tertiary); padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;"> Back</button>
            </div>
          </div>
          <div style="display: flex; gap: 10px; margin-bottom: 16px;">
            <select id="editFileFolder" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
              <option value="other" selected>Other</option>
              <option value="proposals">Proposals</option>
              <option value="pitch-decks">Pitch Decks</option>
              <option value="emails">Email Templates</option>
              <option value="one-pagers">One-Pagers</option>
              <option value="demos">Demo Scripts</option>
              <option value="case-studies">Case Studies</option>
            </select>
            <select id="editFileType" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
              <option value="other" selected>Other Document</option>
              <option value="proposal">Proposal</option>
              <option value="pitch-deck">Pitch Deck</option>
              <option value="email">Email</option>
              <option value="one-pager">One-Pager</option>
              <option value="demo-script">Demo Script</option>
              <option value="case-study">Case Study</option>
            </select>
          </div>
          <textarea id="editFileContent" placeholder="Start typing your document..." style="width: 100%; height: calc(100% - 120px); min-height: 300px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; line-height: 1.6; resize: vertical; font-family: inherit;"></textarea>
        </div>
      `;
      document.getElementById('editFileName').focus();
    }

    async function saveCurrentDoc() {
      const name = document.getElementById('editFileName')?.value?.trim();
      const content = document.getElementById('editFileContent')?.value || '';
      const folder = document.getElementById('editFileFolder')?.value || 'other';

      if (!name) {
        alert('Please enter a document name');
        return;
      }

      try {
        // Save to GitHub (primary persistent storage)
        const safeName = name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
        const githubPath = `${folder}/${safeName}.md`;
        const target = currentEditingFile?.target || '';

        const githubRes = await fetch('/api/sales-context', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            path: githubPath,
            content: content,
            company: target || undefined,
            message: `Save ${name} via Sales Engineering`
          })
        });

        let githubUrl = null;
        if (githubRes.ok) {
          const githubData = await githubRes.json();
          githubUrl = githubData.url;
        }

        // Also save to Redis (for quick access)
        let saveSuccess = false;
        if (currentEditingFile) {
          // Update existing file
          const res = await fetch('/api/sales-files', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: currentEditingFile.id,
              name,
              content,
              folder,
              githubUrl
            })
          });
          if (res.ok) {
            const data = await res.json();
            const idx = salesFiles.findIndex(f => f.id === currentEditingFile.id);
            if (idx >= 0) salesFiles[idx] = data.file;
            currentEditingFile = data.file;
            saveSuccess = true;
          } else {
            const error = await res.text();
            console.error('PATCH save failed:', res.status, error);
          }
        } else {
          // Create new file
          const type = document.getElementById('editFileType')?.value || 'other';
          const res = await fetch('/api/sales-files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name,
              type,
              folder,
              content,
              createdBy: 'eli',
              githubUrl
            })
          });
          if (res.ok) {
            const data = await res.json();
            salesFiles.push(data.file);
            currentEditingFile = data.file;
            saveSuccess = true;
          } else {
            const error = await res.text();
            console.error('POST save failed:', res.status, error);
          }
        }

        updateSalesFolderCounts();
        updateSalesStats();

        // Show appropriate message based on save result
        if (saveSuccess) {
          if (githubUrl) {
            alert(`Document saved to GitHub!\n\n${githubUrl}`);
          } else {
            alert('Document saved! (GitHub sync pending - check if GITHUB_TOKEN is configured)');
          }
        } else {
          alert('Failed to save document to database. Please check console for details.');
        }
      } catch (err) {
        console.error('Save error:', err);
        alert('Failed to save document');
      }
    }

    async function deleteCurrentDoc() {
      if (!currentEditingFile) return;
      if (!confirm(`Delete "${currentEditingFile.name}"? This cannot be undone.`)) return;

      try {
        const res = await fetch(`/api/sales-files?id=${currentEditingFile.id}`, {
          method: 'DELETE'
        });
        if (res.ok) {
          salesFiles = salesFiles.filter(f => f.id !== currentEditingFile.id);
          currentEditingFile = null;
          updateSalesFolderCounts();
          updateSalesStats();
          showTemplateGrid();
          alert('Document deleted');
        }
      } catch (err) {
        console.error('Delete error:', err);
        alert('Failed to delete document');
      }
    }

    function filterSalesFiles(query) {
      if (!salesCurrentFolder) return;
      const filesList = document.getElementById('salesFilesList');
      const files = salesFiles.filter(f =>
        f.folder === salesCurrentFolder &&
        f.name.toLowerCase().includes(query.toLowerCase())
      );

      if (files.length === 0) {
        filesList.innerHTML = '<div class="sales-file-empty">No matching files</div>';
        return;
      }

      filesList.innerHTML = files.map(file => `
        <div class="sales-file-item" onclick="openSalesFile('${file.id}')">
          <span class="sales-file-icon">${getFileIcon(file.type)}</span>
          <span class="sales-file-name">${file.name}</span>
          <span class="sales-file-date">${formatDate(file.createdAt)}</span>
        </div>
      `).join('');
    }

    function openNewDocModal() {
      // Show template grid if not already showing
      showTemplateGrid();
    }

    function createNewFolder() {
      const folderName = prompt('Enter folder name:');
      if (!folderName) return;
      alert(`Folder "${folderName}" would be created. (Feature coming soon)`);
    }

    function previewDoc() {
      if (currentEditingFile) {
        const content = document.getElementById('editFileContent')?.value || currentEditingFile.content;
        const win = window.open('', '_blank');
        win.document.write(`<html><head><title>${currentEditingFile.name}</title><style>body{font-family:system-ui;padding:40px;max-width:800px;margin:0 auto;line-height:1.6;}</style></head><body><pre style="white-space:pre-wrap;">${escapeHtml(content)}</pre></body></html>`);
      }
    }

    function downloadDoc() {
      if (!currentEditingFile) return;
      const content = document.getElementById('editFileContent')?.value || currentEditingFile.content;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentEditingFile.name}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function saveDoc() {
      saveCurrentDoc();
    }

    // ============================================
    // END SALES ENGINEERING FUNCTIONALITY
    // ============================================


    async function fetchRoadmap() {
      try {
        const project = document.getElementById('projectFilter').value;
        const assignee = document.getElementById('assigneeFilter').value;
        const priority = document.getElementById('priorityFilter')?.value || '';
        const cycleId = document.getElementById('cycleFilter')?.value || '';

        let url = API_BASE + '/roadmap?';
        if (project) url += 'project=' + encodeURIComponent(project) + '&';
        if (assignee) url += 'assignee=' + encodeURIComponent(assignee) + '&';
        if (priority) url += 'priority=' + encodeURIComponent(priority) + '&';
        if (cycleId) url += 'cycleId=' + encodeURIComponent(cycleId);

        const res = await fetch(url);
        const data = await res.json();
        roadmapItems = data.items || [];
        // Filter by cycle client-side
        if (cycleId) {
          roadmapItems = roadmapItems.filter(item => item.cycleId === cycleId);
        }
        renderRoadmap();
        updateRoadmapStats();
        fetchWorkload();
      } catch (err) {
        console.error('Failed to fetch roadmap:', err);
      }
    }

    // Fetch and populate cycles dropdown
    async function fetchCycles() {
      try {
        const res = await fetch(API_BASE + '/roadmap?type=cycles');
        const data = await res.json();
        const cycles = data.cycles || [];
        const cycleFilter = document.getElementById('cycleFilter');
        if (cycleFilter && cycles.length > 0) {
          let options = '<option value="">All Sprints</option>';
          cycles.forEach(cycle => {
            const statusIcon = cycle.status === 'active' ? ' ' : cycle.status === 'completed' ? ' ' : ' ';
            options += `<option value="${cycle.id}">${statusIcon}${escapeHtml(cycle.name)}</option>`;
          });
          cycleFilter.innerHTML = options;
        }
      } catch (err) {
        console.error('Failed to fetch cycles:', err);
      }
    }

    function updateRoadmapStats() {
      const counts = {
        backlog: 0,
        'in-progress': 0,
        review: 0,
        done: 0
      };
      
      roadmapItems.forEach(item => {
        const status = item.status === 'planned' ? 'backlog' : item.status;
        if (counts[status] !== undefined) {
          counts[status]++;
        }
      });
      
      const total = roadmapItems.length || 1;
      
      // Update counts
      document.getElementById('roadmapBacklogCount').textContent = counts.backlog;
      document.getElementById('roadmapInProgressCount').textContent = counts['in-progress'];
      document.getElementById('roadmapReviewCount').textContent = counts.review;
      document.getElementById('roadmapDoneCount').textContent = counts.done;
      
      // Update progress bar
      const donePercent = (counts.done / total) * 100;
      const reviewPercent = (counts.review / total) * 100;
      const inProgressPercent = (counts['in-progress'] / total) * 100;
      
      document.getElementById('progressDone').style.width = donePercent + '%';
      document.getElementById('progressReview').style.width = reviewPercent + '%';
      document.getElementById('progressInProgress').style.width = inProgressPercent + '%';
      document.getElementById('progressPercent').textContent = Math.round(donePercent) + '%';
    }

    async function fetchWorkload() {
      try {
        const res = await fetch(API_BASE + '/roadmap', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'get-workload' })
        });
        const data = await res.json();
        renderWorkload(data.workload || {});
      } catch (err) {
        console.error('Failed to fetch workload:', err);
      }
    }

    function renderWorkload(workload) {
      const container = document.getElementById('workloadBar');
      if (!container) return;

      const html = Object.entries(workload)
        .filter(([name]) => name !== 'unassigned')
        .sort((a, b) => b[1].total - a[1].total)
        .map(([name, data]) => {
          const member = teamMembers.find(m => m.id === name || m.name.toLowerCase() === name.toLowerCase());
          const color = member?.color || 'var(--accent)';
          const initials = name.substring(0, 2).toUpperCase();
          const highLoad = data.total > 10 ? 'high-load' : '';
          return `
            <div class="workload-item ${highLoad}" onclick="document.getElementById('assigneeFilter').value='${member?.id || name}';fetchRoadmap();" style="cursor:pointer">
              <div class="avatar" style="background:${color}">${initials}</div>
              <span>${member?.name || name}</span>
              <span class="count">${data.total}</span>
            </div>
          `;
        }).join('');

      container.innerHTML = html || '<span style="color:var(--text-muted);font-size:12px">No workload data</span>';
    }

    function renderRoadmap() {
      const columns = {
        'backlog': document.getElementById('backlogItems'),
        'planned': document.getElementById('backlogItems'), // combine with backlog
        'in-progress': document.getElementById('inProgressItems'),
        'review': document.getElementById('reviewItems'),
        'done': document.getElementById('doneItems')
      };

      // Clear all columns
      Object.values(columns).forEach(col => col.innerHTML = '');

      // Group items by status
      const grouped = {
        'backlog': [],
        'in-progress': [],
        'review': [],
        'done': []
      };

      roadmapItems.forEach(item => {
        const status = item.status === 'planned' ? 'backlog' : item.status;
        if (grouped[status]) {
          grouped[status].push(item);
        }
      });

      // Render each group
      Object.entries(grouped).forEach(([status, items]) => {
        const container = columns[status];
        if (!container) return;

        if (items.length === 0) {
          container.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; text-align: center; padding: 20px;">No items</div>';
          return;
        }

        container.innerHTML = items.map(item => {
          const member = teamMembers.find(m => m.id === item.assignee);
          const assigneeHtml = member ? `
            <div class="roadmap-item-assignee">
              <div class="assignee-avatar ${member.type}" style="background: ${member.color || 'var(--accent)'}">${getInitials(member.name)}</div>
            </div>
          ` : '';

          // Determine available quick actions based on current status
          const quickActions = {
            'backlog': ['in-progress'],
            'in-progress': ['review', 'backlog'],
            'review': ['done', 'in-progress'],
            'done': ['review']
          };
          const actions = quickActions[status] || [];
          const actionLabels = {
            'backlog': ' Back',
            'in-progress': ' Start',
            'review': ' Review',
            'done': ' Done'
          };
          
          const actionsHtml = actions.length > 0 ? `
            <div class="roadmap-item-actions">
              ${actions.map(a => `<button class="roadmap-action-btn" onclick="event.stopPropagation(); moveRoadmapItem('${item.id}', '${a}')">${actionLabels[a] || a}</button>`).join('')}
            </div>
          ` : '';

          return `
            <div class="roadmap-item" draggable="true" data-item-id="${item.id}" onclick="showItemDetails('${item.id}')" ondragstart="handleDragStart(event, '${item.id}')" ondragend="handleDragEnd(event)">
              <div class="roadmap-item-title">${escapeHtml(item.title)}</div>
              ${item.description ? `<div class="roadmap-item-description">${escapeHtml(item.description)}</div>` : ''}
              <div class="roadmap-item-meta">
                <span class="roadmap-item-project">${item.project}</span>
                <span class="roadmap-item-priority ${item.priority}">${item.priority}</span>
                ${assigneeHtml}
              </div>
              ${actionsHtml}
            </div>
          `;
        }).join('');
      });
    }

    // Drag and Drop functions
    let draggedItemId = null;
    
    function handleDragStart(e, itemId) {
      draggedItemId = itemId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', itemId);
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedItemId = null;
      // Remove all drag-over classes
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }
    
    function handleDragOver(e, status) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const column = e.currentTarget;
      column.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }
    
    async function handleDrop(e, newStatus) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      const itemId = e.dataTransfer.getData('text/plain') || draggedItemId;
      if (!itemId) return;
      
      await moveRoadmapItem(itemId, newStatus);
    }
    
    // Initialize drag-drop on columns after DOM ready
    function initDragDrop() {
      const columns = document.querySelectorAll('.roadmap-column');
      columns.forEach(col => {
        const status = col.dataset.status;
        const itemsContainer = col.querySelector('.column-items');
        
        if (itemsContainer) {
          itemsContainer.addEventListener('dragover', (e) => handleDragOver(e, status));
          itemsContainer.addEventListener('dragleave', handleDragLeave);
          itemsContainer.addEventListener('drop', (e) => handleDrop(e, status));
        }
      });
    }

    async function moveRoadmapItem(itemId, newStatus) {
      try {
        const res = await fetch(API_BASE + '/roadmap', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: itemId, status: newStatus })
        });
        
        if (res.ok) {
          // Refresh roadmap
          await fetchRoadmap();
        } else {
          console.error('Failed to move item');
        }
      } catch (err) {
        console.error('Error moving roadmap item:', err);
      }
    }

    function showAddRoadmapItem() {
      document.getElementById('addItemModal').classList.add('active');
      document.getElementById('addItemForm').reset();
    }

    function hideAddRoadmapItem() {
      document.getElementById('addItemModal').classList.remove('active');
    }

    // External Agent Modal Functions
    function showAddAgentModal() {
      document.getElementById('addAgentModal').style.display = 'flex';
      document.getElementById('inviteLinkResult').style.display = 'none';
      document.getElementById('addAgentForm').reset();
    }

    function hideAddAgentModal() {
      document.getElementById('addAgentModal').style.display = 'none';
    }

    async function generateAgentInvite() {
      try {
        const res = await fetch(API_BASE + '/external-agents?action=invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ createdBy: USERNAME, expiresIn: '7d' })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('inviteLinkInput').value = data.joinUrl;
          document.getElementById('inviteLinkResult').style.display = 'block';
        } else {
          alert('Failed to generate invite: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Error generating invite: ' + e.message);
      }
    }

    function copyInviteLink() {
      const input = document.getElementById('inviteLinkInput');
      input.select();
      document.execCommand('copy');
      alert('Link copied to clipboard!');
    }

    document.getElementById('addAgentForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const agent = {
        name: document.getElementById('agentName').value,
        description: document.getElementById('agentDescription').value,
        capabilities: document.getElementById('agentCapabilities').value,
        contactInfo: document.getElementById('agentContact').value,
        owner: USERNAME
      };

      try {
        const res = await fetch(API_BASE + '/external-agents', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(agent)
        });
        const data = await res.json();
        if (data.success) {
          hideAddAgentModal();
          fetchAgents(); // Refresh the agent list
          alert('External agent added successfully!');
        } else {
          alert('Failed to add agent: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Error adding agent: ' + e.message);
      }
    });

    async function submitRoadmapItem(e) {
      e.preventDefault();

      const assigneeSelect = document.getElementById('itemAssignee');
      const selectedOption = assigneeSelect.options[assigneeSelect.selectedIndex];

      const item = {
        title: document.getElementById('itemTitle').value,
        description: document.getElementById('itemDescription').value,
        project: document.getElementById('itemProject').value,
        priority: document.getElementById('itemPriority').value,
        assignee: assigneeSelect.value || undefined,
        assigneeType: selectedOption.dataset.type || 'human',
        status: document.getElementById('itemStatus').value
      };

      try {
        const res = await fetch(API_BASE + '/roadmap', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to create item');
        }

        hideAddRoadmapItem();
        fetchRoadmap();
      } catch (err) {
        console.error('Failed to create item:', err);
        alert('Failed to create item: ' + err.message);
      }
    }

    function showItemDetails(itemId) {
      const item = roadmapItems.find(i => i.id === itemId);
      if (!item) return;

      // For now, just allow quick status change
      const newStatus = prompt(
        `Change status for "${item.title}"?\nCurrent: ${item.status}\n\nOptions: backlog, planned, in-progress, review, done`,
        item.status
      );

      if (newStatus && ['backlog', 'planned', 'in-progress', 'review', 'done'].includes(newStatus)) {
        updateItemStatus(itemId, newStatus);
      }
    }

    async function updateItemStatus(itemId, status) {
      try {
        const res = await fetch(API_BASE + '/roadmap', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: itemId, status })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to update item');
        }

        fetchRoadmap();
      } catch (err) {
        console.error('Failed to update item:', err);
        alert('Failed to update: ' + err.message);
      }
    }

    // Close modal on overlay click
    document.getElementById('addItemModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        hideAddRoadmapItem();
      }
    });

    // Form submit handler
    document.getElementById('addItemForm').addEventListener('submit', submitRoadmapItem);

    
    // Start app - check auth first
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[HUB] DOMContentLoaded fired');
      const loadingScreen = document.getElementById('loadingScreen');
      
      // Safety timeout - hide loading screen after 5 seconds no matter what
      const safetyTimeout = setTimeout(() => {
        console.log('[HUB] Safety timeout - force hiding loading screen');
        if (loadingScreen) loadingScreen.style.display = 'none';
      }, 5000);
      
      try {
        console.log('[HUB] Setting up forms...');
        setupLoginForm();
        setupRegisterForm();
        setupAuthToggle();
        console.log('[HUB] Forms setup complete');

        console.log('[HUB] Checking session...');
        const authenticated = await checkSession();
        console.log('[HUB] Session check result:', authenticated);
        
        // Clear safety timeout since we got here
        clearTimeout(safetyTimeout);
        
        // Hide loading screen
        console.log('[HUB] Hiding loading screen');
        if (loadingScreen) loadingScreen.style.display = 'none';
        
        if (authenticated) {
          console.log('[HUB] User authenticated, initializing...');
          isAuthenticated = true;
          hideLoginModal();
          await init();
          console.log('[HUB] Init complete');
        } else {
          console.log('[HUB] Not authenticated, showing login');
          showLoginModal();
        }
      } catch (error) {
        console.error('[HUB] Startup error:', error);
        clearTimeout(safetyTimeout);
        // Always hide loading screen even on error
        if (loadingScreen) loadingScreen.style.display = 'none';
        // Show login as fallback
        showLoginModal();
      }
    });


    // Mobile Navigation Functions
    let currentMobilePanel = 'chat';
    let unreadMessages = 0;

    function switchMobilePanel(panelName) {
      const panels = document.querySelectorAll('main > .panel');
      const navItems = document.querySelectorAll('.mobile-nav-item');

      // Map panel names to indices (for main panels)
      const panelMap = { 'team': 0, 'chat': 1 };

      // Handle tab-based panels (telemetry, metrics, crm, sales)
      const tabPanels = ['telemetry', 'metrics', 'crm', 'sales'];

      // Remove active class from all panels and nav items
      panels.forEach(p => p.classList.remove('mobile-active'));
      navItems.forEach(n => n.classList.remove('active'));

      if (tabPanels.includes(panelName)) {
        // For tab-based panels, show the main panel (chat area) and switch tab
        if (panels[1]) {
          panels[1].classList.add('mobile-active');
        }
        switchTab(panelName);
      } else {
        // For regular panels, show by index
        const panelIndex = panelMap[panelName];
        if (panels[panelIndex] !== undefined) {
          panels[panelIndex].classList.add('mobile-active');
        }
        // If it's chat, make sure we're on chat tab
        if (panelName === 'chat') {
          switchTab('chat');
        }
      }

      const navItem = document.querySelector(`.mobile-nav-item[data-panel="${panelName}"]`);
      if (navItem) {
        navItem.classList.add('active');
      }

      currentMobilePanel = panelName;

      // Clear badge when viewing chat
      if (panelName === 'chat') {
        unreadMessages = 0;
        updateChatBadge();
      }
    }

    function updateChatBadge() {
      const badge = document.getElementById('chatBadge');
      if (badge) {
        if (unreadMessages > 0 && currentMobilePanel !== 'chat') {
          badge.textContent = unreadMessages > 99 ? '99+' : unreadMessages;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    function updateTeamBadge(onlineCount) {
      const badge = document.getElementById('teamBadge');
      if (badge) {
        if (onlineCount > 0) {
          badge.textContent = onlineCount;
          badge.style.display = 'flex';
          badge.style.background = 'var(--success)';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // Initialize mobile panel on page load
    function initMobileNav() {
      // Check if mobile view
      if (window.innerWidth <= 1024) {
        switchMobilePanel('chat');
      }
    }

    // Hook into existing message polling to track unread
    const originalRenderMessages = typeof renderMessages === 'function' ? renderMessages : null;

    // Intercept new messages for badge updates
    function trackNewMessages(newMessageCount) {
      if (currentMobilePanel !== 'chat' && newMessageCount > 0) {
        unreadMessages += newMessageCount;
        updateChatBadge();
      }
    }

    // Initialize on load
    window.addEventListener('load', initMobileNav);
    window.addEventListener('resize', () => {
      if (window.innerWidth <= 1024) {
        // Ensure a panel is active on mobile
        if (!document.querySelector('.panel.mobile-active')) {
          switchMobilePanel(currentMobilePanel || 'chat');
        }
      }
    });

    // === MOBILE ENHANCEMENTS ===
    
    // Pull-to-refresh for chat
    let pullStartY = 0;
    let isPulling = false;
    
    function initPullToRefresh() {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages || window.innerWidth > 768) return;
      
      chatMessages.addEventListener('touchstart', (e) => {
        if (chatMessages.scrollTop === 0) {
          pullStartY = e.touches[0].clientY;
          isPulling = true;
        }
      }, { passive: true });
      
      chatMessages.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        const pullDistance = e.touches[0].clientY - pullStartY;
        if (pullDistance > 60 && chatMessages.scrollTop === 0) {
          chatMessages.classList.add('pulling');
        }
      }, { passive: true });
      
      chatMessages.addEventListener('touchend', () => {
        if (isPulling && chatMessages.classList.contains('pulling')) {
          chatMessages.classList.remove('pulling');
          // Trigger refresh
          fetchMessages();
          // Show brief feedback
          showToast('Messages refreshed');
        }
        isPulling = false;
      }, { passive: true });
    }
    
    // Toast notification for mobile
    function showToast(message, duration = 2000) {
      const existing = document.querySelector('.mobile-toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'mobile-toast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 13px;
        z-index: 9999;
        animation: toastIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'toastOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
    
    // Add toast animations to head
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
      }
      @keyframes toastOut {
        from { opacity: 1; transform: translateX(-50%) translateY(0); }
        to { opacity: 0; transform: translateX(-50%) translateY(20px); }
      }
    `;
    document.head.appendChild(toastStyle);
    
    // Haptic feedback helper (where supported)
    function haptic(type = 'light') {
      if ('vibrate' in navigator) {
        const patterns = {
          light: [10],
          medium: [20],
          heavy: [30],
          success: [10, 50, 10],
          error: [30, 50, 30]
        };
        navigator.vibrate(patterns[type] || patterns.light);
      }
    }
    
    // Enhanced mobile button feedback
    function addMobileFeedback() {
      document.querySelectorAll('button, .mobile-nav-item').forEach(btn => {
        btn.addEventListener('touchstart', () => {
          btn.style.transform = 'scale(0.95)';
          haptic('light');
        }, { passive: true });
        btn.addEventListener('touchend', () => {
          btn.style.transform = '';
        }, { passive: true });
      });
    }
    
    // Initialize mobile features
    if (window.innerWidth <= 768) {
      initPullToRefresh();
      addMobileFeedback();
    }



    // Feature Testing Functions
    async function runFeatureTests(featureId) {
      try {
        const res = await fetch(API_BASE + '/feature-tests?action=run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ featureId, runBy: USERNAME })
        });
        const data = await res.json();
        return data;
      } catch (e) {
        console.error('Failed to run tests:', e);
        return { error: e.message };
      }
    }

    async function completeFeature(featureId, force = false) {
      try {
        const res = await fetch(API_BASE + '/feature-tests?action=complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ featureId, runBy: USERNAME, force })
        });
        const data = await res.json();

        if (!res.ok) {
          alert('Cannot complete feature: ' + (data.error || 'Tests failed'));
          return data;
        }

        // Refresh features list
        await fetchActiveContext();
        return data;
      } catch (e) {
        console.error('Failed to complete feature:', e);
        return { error: e.message };
      }
    }

    async function getFeatureTests(featureId) {
      try {
        const res = await fetch(API_BASE + '/feature-tests?featureId=' + featureId + '&includeRuns=true', {
          credentials: 'include'
        });
        return await res.json();
      } catch (e) {
        console.error('Failed to get tests:', e);
        return { tests: [], recentRuns: [] };
      }
    }

    function showTestModal(featureId, featureTitle) {
      // Create modal for running tests
      const existingModal = document.getElementById('testModal');
      if (existingModal) existingModal.remove();

      const modal = document.createElement('div');
      modal.id = 'testModal';
      modal.className = 'modal-overlay active';
      modal.innerHTML = `
        <div class="modal" style="max-width: 600px;">
          <div class="modal-title">
             Feature Tests: ${featureTitle}
          </div>
          <div id="testModalContent" style="min-height: 200px;">
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 24px; margin-bottom: 10px;"></div>
              <div>Loading tests...</div>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="document.getElementById('testModal').remove()">Close</button>
            <button type="button" class="btn-submit" id="runTestsBtn" onclick="executeFeatureTests('${featureId}')">
               Run All Tests
            </button>
            <button type="button" class="btn-submit" style="background: var(--success);" id="completeBtn" onclick="tryCompleteFeature('${featureId}')" disabled>
               Complete Feature
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Load tests
      loadTestsIntoModal(featureId);
    }

    async function loadTestsIntoModal(featureId) {
      const content = document.getElementById('testModalContent');
      const data = await getFeatureTests(featureId);

      if (data.tests.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
            <div style="font-size: 32px; margin-bottom: 10px;"></div>
            <div style="margin-bottom: 10px;">No tests defined for this feature</div>
            <div style="font-size: 12px;">Features can be completed without tests, but it's not recommended.</div>
          </div>
        `;
        document.getElementById('completeBtn').disabled = false;
        return;
      }

      let html = '<div style="margin-bottom: 16px;">';
      html += '<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">TEST CASES (' + data.tests.length + ')</div>';

      for (const test of data.tests) {
        const recentRun = data.recentRuns?.find(r => r.testId === test.id);
        const statusIcon = recentRun
          ? (recentRun.status === 'passed' ? '' : recentRun.status === 'failed' ? '' : '')
          : '';
        const statusColor = recentRun
          ? (recentRun.status === 'passed' ? 'var(--success)' : 'var(--danger)')
          : 'var(--text-secondary)';

        html += `
          <div class="context-item" style="border-left-color: ${statusColor}; margin-bottom: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="margin-right: 6px;">${statusIcon}</span>
                <strong>${test.name}</strong>
              </div>
              <span style="font-size: 10px; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">${test.type}</span>
            </div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${test.description || 'No description'}</div>
            ${recentRun ? `<div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">Last run: ${new Date(recentRun.timestamp).toLocaleString()} - ${recentRun.message}</div>` : ''}
          </div>
        `;
      }
      html += '</div>';

      // Show recent runs summary
      if (data.recentRuns && data.recentRuns.length > 0) {
        const passed = data.recentRuns.filter(r => r.status === 'passed').length;
        const total = data.recentRuns.length;
        const passRate = Math.round((passed / total) * 100);

        html += `
          <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: ${passRate === 100 ? 'var(--success)' : 'var(--warning)'};">${passRate}%</div>
            <div style="font-size: 11px; color: var(--text-secondary);">Pass Rate (${passed}/${total})</div>
          </div>
        `;

        if (passRate === 100) {
          document.getElementById('completeBtn').disabled = false;
        }
      }

      content.innerHTML = html;
    }

    async function executeFeatureTests(featureId) {
      const btn = document.getElementById('runTestsBtn');
      const content = document.getElementById('testModalContent');

      btn.disabled = true;
      btn.textContent = ' Running...';

      content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="font-size: 32px; margin-bottom: 10px;"></div>
          <div>Running tests...</div>
        </div>
      `;

      const results = await runFeatureTests(featureId);

      btn.disabled = false;
      btn.textContent = ' Run All Tests';

      if (results.error) {
        content.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--danger);">
            <div style="font-size: 32px; margin-bottom: 10px;"></div>
            <div>Error: ${results.error}</div>
          </div>
        `;
        return;
      }

      // Display results
      let html = `
        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
          <div style="font-size: 36px; font-weight: bold; color: ${results.canComplete ? 'var(--success)' : 'var(--danger)'};">
            ${results.passRate}%
          </div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ${results.passed} passed, ${results.failed} failed, ${results.errors} errors, ${results.skipped} skipped
          </div>
          <div style="margin-top: 8px; font-size: 13px;">
            ${results.canComplete ? ' Ready to complete!' : ' Fix failing tests before completing'}
          </div>
        </div>
      `;

      html += '<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">TEST RESULTS</div>';

      for (const run of results.runs) {
        const icon = run.status === 'passed' ? '' : run.status === 'failed' ? '' : run.status === 'error' ? '' : '';
        const color = run.status === 'passed' ? 'var(--success)' : run.status === 'failed' ? 'var(--danger)' : 'var(--warning)';

        html += `
          <div class="context-item" style="border-left-color: ${color}; margin-bottom: 6px;">
            <div style="display: flex; justify-content: space-between;">
              <span>${icon} ${run.testId}</span>
              <span style="font-size: 10px; color: var(--text-secondary);">${run.duration}ms</span>
            </div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${run.message}</div>
          </div>
        `;
      }

      content.innerHTML = html;

      // Enable complete button if tests passed
      document.getElementById('completeBtn').disabled = !results.canComplete;
    }

    async function tryCompleteFeature(featureId) {
      const btn = document.getElementById('completeBtn');
      btn.disabled = true;
      btn.textContent = ' Completing...';

      const result = await completeFeature(featureId);

      if (result.success) {
        document.getElementById('testModal').remove();
        alert(' Feature completed successfully!');
      } else {
        btn.disabled = false;
        btn.textContent = ' Complete Feature';
      }
    }

    // Make functions globally accessible
    window.showTestModal = showTestModal;
    window.runFeatureTests = runFeatureTests;
    window.completeFeature = completeFeature;


    function handleContextPanelClick(event) {
      const featureItem = event.target.closest('.context-item.feature');
      if (featureItem) {
        const id = featureItem.dataset.id;
        const title = featureItem.dataset.title;
        if (id && title) {
          showTestModal(id, title);
        }
      }
    }


    // =========================================
    // DIRECT MESSAGING SYSTEM
    // =========================================

    let dmPanelOpen = false;
    let currentDMConversation = null;
    let dmPendingAttachment = null;
    let dmKnownUsers = [];

    function toggleDMPanel() {
      dmPanelOpen = !dmPanelOpen;
      document.getElementById('dmPanel').classList.toggle('active', dmPanelOpen);
      if (dmPanelOpen) {
        loadDMConversations();
      }
    }

    async function loadDMConversations() {
      try {
        const res = await fetch(API_BASE + '/dm?userId=' + encodeURIComponent(USERNAME), {
          credentials: 'include'
        });
        const data = await res.json();

        const container = document.getElementById('dmConversations');

        if (!data.conversations || data.conversations.length === 0) {
          container.innerHTML = `
            <div class="dm-empty">
              <div class="dm-empty-icon"></div>
              <div>No conversations yet</div>
              <div style="font-size: 12px; margin-top: 4px;">Start a direct message with someone</div>
            </div>
          `;
          return;
        }

        container.innerHTML = data.conversations.map(convo => {
          const otherUser = convo.participants.find(p => p !== USERNAME) || convo.participants[0];
          const otherType = convo.participantTypes[otherUser] || 'agent';
          const unread = convo.unreadCount?.[USERNAME] || 0;
          const lastMsg = convo.lastMessage;
          const timeAgo = lastMsg ? formatTimeAgo(new Date(lastMsg.timestamp)) : '';

          return `
            <div class="dm-convo-item ${unread > 0 ? 'unread' : ''}" onclick="openDMChat('${convo.id}', '${escapeHtml(otherUser)}', '${otherType}')">
              <div class="dm-convo-header">
                <div class="dm-convo-name">
                  <span>${otherType === 'agent' ? '' : ''}</span>
                  <span>${escapeHtml(otherUser)}</span>
                  ${unread > 0 ? `<span class="dm-unread-badge">${unread}</span>` : ''}
                </div>
                <span class="dm-convo-time">${timeAgo}</span>
              </div>
              <div class="dm-convo-preview">${lastMsg ? escapeHtml(lastMsg.preview) : 'No messages'}</div>
            </div>
          `;
        }).join('');

        // Update badge
        updateDMBadge(data.totalUnread);

      } catch (e) {
        console.error('Failed to load DM conversations:', e);
      }
    }

    async function openDMChat(conversationId, recipientName, recipientType) {
      currentDMConversation = { id: conversationId, recipient: recipientName, type: recipientType };

      document.getElementById('dmConversationsList').style.display = 'none';
      document.getElementById('dmChatView').classList.add('active');
      document.getElementById('dmChatRecipient').textContent = recipientName;
      document.getElementById('dmChatRecipientType').textContent = recipientType === 'agent' ? ' Agent' : ' Human';

      await loadDMMessages(conversationId);
    }

    async function loadDMMessages(conversationId) {
      try {
        const res = await fetch(API_BASE + '/dm?conversationId=' + encodeURIComponent(conversationId) + '&userId=' + encodeURIComponent(USERNAME), {
          credentials: 'include'
        });
        const data = await res.json();

        const container = document.getElementById('dmChatMessages');

        if (!data.messages || data.messages.length === 0) {
          container.innerHTML = '<div class="dm-empty" style="padding: 20px;"><div>No messages yet</div></div>';
          return;
        }

        container.innerHTML = data.messages.map(msg => {
          const isSent = msg.from === USERNAME;
          const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          let attachmentHTML = '';
          if (msg.attachments && msg.attachments.length > 0) {
            attachmentHTML = msg.attachments.map(att => {
              if (att.type === 'image') {
                return `<div class="dm-message-attachment"><img src="${att.data}" alt="${escapeHtml(att.name)}" onclick="window.open(this.src)" /></div>`;
              }
              return `<div class="dm-message-attachment"> ${escapeHtml(att.name)}</div>`;
            }).join('');
          }

          return `
            <div class="dm-message ${isSent ? 'sent' : 'received'}">
              <div>${escapeHtml(msg.message)}</div>
              ${attachmentHTML}
              <div class="dm-message-time">${time}${msg.read && isSent ? ' ' : ''}</div>
            </div>
          `;
        }).join('');

        container.scrollTop = container.scrollHeight;

        // Refresh badge
        checkDMUnread();

      } catch (e) {
        console.error('Failed to load DM messages:', e);
      }
    }

    function closeDMChat() {
      currentDMConversation = null;
      document.getElementById('dmChatView').classList.remove('active');
      document.getElementById('dmConversationsList').style.display = 'block';
      loadDMConversations();
    }

    function handleDMKeypress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendDM();
      }
    }

    async function sendDM() {
      const input = document.getElementById('dmMessageInput');
      const message = input.value.trim();

      if (!message && !dmPendingAttachment) return;
      if (!currentDMConversation) return;

      const payload = {
        from: USERNAME,
        fromType: 'human',
        to: currentDMConversation.recipient,
        toType: currentDMConversation.type,
        message: message
      };

      if (dmPendingAttachment) {
        payload.attachments = [dmPendingAttachment];
        dmPendingAttachment = null;
      }

      input.value = '';

      try {
        const res = await fetch(API_BASE + '/dm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          // If this was a new conversation, update the ID
          const data = await res.json();
          if (!currentDMConversation.id && data.conversationId) {
            currentDMConversation.id = data.conversationId;
          }
          await loadDMMessages(currentDMConversation.id || data.conversationId);
        }
      } catch (e) {
        console.error('Failed to send DM:', e);
      }
    }

    async function checkDMUnread() {
      try {
        const res = await fetch(API_BASE + '/dm?userId=' + encodeURIComponent(USERNAME) + '&checkUnread=true', {
          credentials: 'include'
        });
        const data = await res.json();
        updateDMBadge(data.totalUnread || 0);
      } catch (e) {
        console.error('Failed to check DM unread:', e);
      }
    }

    function updateDMBadge(count) {
      const badge = document.getElementById('dmBadgeCount');
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function showNewDMModal() {
      document.getElementById('dmNewModal').classList.add('active');
      loadDMUserList();
    }

    function hideNewDMModal() {
      document.getElementById('dmNewModal').classList.remove('active');
    }

    async function loadDMUserList() {
      try {
        // Get agents
        const agentsRes = await fetch(API_BASE + '/agents', { credentials: 'include' });
        const agentsData = await agentsRes.json();

        dmKnownUsers = (agentsData.agents || []).map(a => ({
          id: a.id,
          name: a.name || a.id,
          type: 'agent'
        }));

        // Add some known humans if any (you could fetch from users endpoint if available)
        // For now, just show agents

        renderDMUserList();
      } catch (e) {
        console.error('Failed to load user list:', e);
      }
    }

    function filterDMUsers() {
      renderDMUserList();
    }

    function renderDMUserList() {
      const search = document.getElementById('dmSearchUser').value.toLowerCase();
      const filtered = dmKnownUsers.filter(u =>
        u.name.toLowerCase().includes(search) || u.id.toLowerCase().includes(search)
      );

      const container = document.getElementById('dmUserList');
      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No users found</div>';
        return;
      }

      container.innerHTML = filtered.map(user => `
        <div class="dm-user-item" onclick="startDMWith('${escapeHtml(user.id)}', '${user.type}')">
          <div class="dm-user-avatar ${user.type}">${user.name.substring(0, 2).toUpperCase()}</div>
          <div>
            <div style="font-weight: 600;">${escapeHtml(user.name)}</div>
            <div style="font-size: 11px; color: var(--text-secondary);">${user.type === 'agent' ? ' Agent' : ' Human'}</div>
          </div>
        </div>
      `).join('');
    }

    function startDMWith(userId, userType) {
      hideNewDMModal();
      currentDMConversation = { id: null, recipient: userId, type: userType };
      document.getElementById('dmConversationsList').style.display = 'none';
      document.getElementById('dmChatView').classList.add('active');
      document.getElementById('dmChatRecipient').textContent = userId;
      document.getElementById('dmChatRecipientType').textContent = userType === 'agent' ? ' Agent' : ' Human';
      document.getElementById('dmChatMessages').innerHTML = '<div class="dm-empty" style="padding: 20px;"><div>Start the conversation!</div></div>';
    }

    function openDMWithAgent(agentId, type) {
      // Open the DM panel first
      if (!dmPanelOpen) {
        dmPanelOpen = true;
        document.getElementById('dmPanel').classList.add('active');
      }
      // Then start the conversation with the agent
      startDMWith(agentId, type || 'agent');
    }

    // Note: Primary formatTimeAgo is defined earlier - this is a duplicate that should be removed
    // Keeping for now but making it call the main one for consistency
    // function formatTimeAgo - REMOVED DUPLICATE

    // Handle file attachment
    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('dmFileInput');
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function(e) {
            dmPendingAttachment = {
              id: 'att-' + Date.now(),
              type: file.type.startsWith('image/') ? 'image' : 'file',
              name: file.name,
              mimeType: file.type,
              size: file.size,
              data: e.target.result
            };
            // Show preview in input area
            document.getElementById('dmMessageInput').placeholder = ' ' + file.name + ' attached - type message or send';
          };
          reader.readAsDataURL(file);
        });
      }

      // Check for DM unread on load
      setTimeout(checkDMUnread, 2000);
      // Poll for new DMs every 30 seconds
      setInterval(checkDMUnread, 30000);
    });

  </script>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-nav" id="mobileNav">
    <div class="mobile-nav-inner">
      <button class="mobile-nav-item" data-panel="team" onclick="switchMobilePanel('team')">
        <span class="mobile-nav-icon"></span>
        <span>Team</span>
        <span class="mobile-nav-badge" id="teamBadge" style="display: none;">0</span>
      </button>
      <button class="mobile-nav-item active" data-panel="chat" onclick="switchMobilePanel('chat')">
        <span class="mobile-nav-icon"></span>
        <span>Chat</span>
        <span class="mobile-nav-badge" id="chatBadge" style="display: none;">0</span>
      </button>
      <button class="mobile-nav-item" data-panel="crm" onclick="switchMobilePanel('crm')">
        <span class="mobile-nav-icon"></span>
        <span>CRM</span>
      </button>
      <button class="mobile-nav-item" data-panel="sales" onclick="switchMobilePanel('sales')">
        <span class="mobile-nav-icon"></span>
        <span>Sales</span>
      </button>
      <button class="mobile-nav-item" data-panel="telemetry" onclick="switchMobilePanel('telemetry')">
        <span class="mobile-nav-icon"></span>
        <span>Fleet</span>
      </button>
      <button class="mobile-nav-item" data-panel="metrics" onclick="switchMobilePanel('metrics')">
        <span class="mobile-nav-icon"></span>
        <span>Stats</span>
      </button>
    </div>
  </nav>

  <!-- CRM Add/Edit Shop Modal -->
  <div class="crm-modal-overlay" id="shopModalOverlay" style="display: none;" onclick="if(event.target === this) closeShopModal()">
    <div class="crm-modal" id="shopModal">
      <div class="crm-modal-header">
        <h3 id="shopModalTitle">Add New Shop</h3>
        <button class="crm-modal-close" onclick="closeShopModal()">&times;</button>
      </div>
      <div class="crm-modal-body">
        <form id="shopForm" onsubmit="handleShopSubmit(event)">
          <input type="hidden" id="shopId" />

          <div class="crm-form-section">
            <h4>Shop Information</h4>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopName">Shop Name *</label>
                <input type="text" id="shopName" required placeholder="e.g., Mike's Auto Repair" />
              </div>
              <div class="crm-form-group">
                <label for="shopStage">Stage *</label>
                <select id="shopStage" required>
                  <option value="prospect">Prospect</option>
                  <option value="qualified">Qualified</option>
                  <option value="demo">Demo Scheduled</option>
                  <option value="proposal">Proposal</option>
                  <option value="customer">Customer</option>
                  <option value="churned">Churned</option>
                </select>
              </div>
            </div>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopAddress">Address</label>
                <input type="text" id="shopAddress" placeholder="123 Main St" />
              </div>
              <div class="crm-form-group">
                <label for="shopCity">City</label>
                <input type="text" id="shopCity" placeholder="Austin" />
              </div>
            </div>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopState">State</label>
                <input type="text" id="shopState" placeholder="TX" maxlength="2" />
              </div>
              <div class="crm-form-group">
                <label for="shopZip">Zip Code</label>
                <input type="text" id="shopZip" placeholder="78701" />
              </div>
            </div>
          </div>

          <div class="crm-form-section">
            <h4>Shop Details</h4>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopBays">Number of Bays</label>
                <input type="number" id="shopBays" placeholder="4" min="1" max="50" />
              </div>
              <div class="crm-form-group">
                <label for="shopTechnicians">Technicians</label>
                <input type="number" id="shopTechnicians" placeholder="3" min="0" max="100" />
              </div>
            </div>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopSpecialty">Specialty</label>
                <select id="shopSpecialty">
                  <option value="">General Automotive</option>
                  <option value="european">European Vehicles</option>
                  <option value="asian">Asian Vehicles</option>
                  <option value="domestic">Domestic Vehicles</option>
                  <option value="diesel">Diesel/Heavy Duty</option>
                  <option value="fleet">Fleet Services</option>
                  <option value="tire">Tire & Alignment</option>
                  <option value="transmission">Transmission</option>
                </select>
              </div>
              <div class="crm-form-group">
                <label for="shopMonthlyVolume">Monthly Car Volume</label>
                <input type="number" id="shopMonthlyVolume" placeholder="150" min="0" />
              </div>
            </div>
            <div class="crm-form-group">
              <label for="shopDealerCompetition">Nearby Dealership Competition</label>
              <select id="shopDealerCompetition">
                <option value="">Unknown</option>
                <option value="none">None nearby</option>
                <option value="low">Low (1-2 within 5mi)</option>
                <option value="medium">Medium (3-5 within 5mi)</option>
                <option value="high">High (5+ within 5mi)</option>
              </select>
            </div>
          </div>

          <div class="crm-form-section">
            <h4>Primary Contact</h4>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="contactName">Contact Name *</label>
                <input type="text" id="contactName" required placeholder="Mike Johnson" />
              </div>
              <div class="crm-form-group">
                <label for="contactRole">Role</label>
                <select id="contactRole">
                  <option value="owner">Owner</option>
                  <option value="manager">Service Manager</option>
                  <option value="tech">Lead Technician</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="contactEmail">Email</label>
                <input type="email" id="contactEmail" placeholder="mike@shop.com" />
              </div>
              <div class="crm-form-group">
                <label for="contactPhone">Phone</label>
                <input type="tel" id="contactPhone" placeholder="(512) 555-1234" />
              </div>
            </div>
          </div>

          <div class="crm-form-section">
            <h4>Sales & Pipeline</h4>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopSource">Lead Source</label>
                <select id="shopSource">
                  <option value="">Select source...</option>
                  <option value="founder">Founder (Internal)</option>
                  <option value="referral">Referral</option>
                  <option value="website">Website</option>
                  <option value="linkedin">LinkedIn</option>
                  <option value="coldcall">Cold Call</option>
                  <option value="trade_show">Trade Show</option>
                  <option value="partner">Partner</option>
                  <option value="inbound">Inbound Inquiry</option>
                </select>
              </div>
              <div class="crm-form-group">
                <label for="shopAssigned">Account Owner</label>
                <select id="shopAssigned">
                  <option value="tyler">Tyler</option>
                  <option value="eli">Eli</option>
                  <option value="ryan">Ryan</option>
                </select>
              </div>
            </div>
          </div>

          <div class="crm-form-section">
            <h4>Subscription & Devices</h4>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopSubscriptionStatus">Subscription Status</label>
                <select id="shopSubscriptionStatus">
                  <option value="">Not Started</option>
                  <option value="trial">Trial</option>
                  <option value="active">Active</option>
                  <option value="paused">Paused</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
              <div class="crm-form-group">
                <label for="shopMonthlyRate">Monthly Rate ($)</label>
                <input type="number" id="shopMonthlyRate" placeholder="0" min="0" step="0.01" />
                <small class="form-hint">Actual monthly subscription amount</small>
              </div>
            </div>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopDevicesNeeded">Devices Needed</label>
                <input type="number" id="shopDevicesNeeded" placeholder="0" min="0" />
                <small class="form-hint">Estimated devices for full deployment</small>
              </div>
              <div class="crm-form-group">
                <label for="shopDevicesDeployed">Devices Deployed</label>
                <input type="number" id="shopDevicesDeployed" placeholder="0" min="0" />
                <small class="form-hint">Currently installed and active</small>
              </div>
            </div>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopContractStart">Contract Start</label>
                <input type="date" id="shopContractStart" />
              </div>
              <div class="crm-form-group">
                <label for="shopContractEnd">Contract End</label>
                <input type="date" id="shopContractEnd" />
                <small class="form-hint">Leave blank for month-to-month</small>
              </div>
            </div>
          </div>

          <div class="crm-form-section">
            <h4>Financials (Estimates)</h4>
            <div class="crm-form-row">
              <div class="crm-form-group">
                <label for="shopEstValue">Est. Monthly Value ($)</label>
                <input type="number" id="shopEstValue" placeholder="0" min="0" />
                <small class="form-hint">Projected revenue when fully deployed</small>
              </div>
              <div class="crm-form-group">
                <label for="shopLifetimeValue">Lifetime Value ($)</label>
                <input type="number" id="shopLifetimeValue" placeholder="0" min="0" />
                <small class="form-hint">Total revenue to date</small>
              </div>
            </div>
          </div>

          <div class="crm-form-section">
            <h4>Notes</h4>
            <div class="crm-form-group">
              <textarea id="shopNotes" rows="4" placeholder="Any additional notes about this shop..."></textarea>
            </div>
          </div>

          <div class="crm-form-actions">
            <button type="button" class="crm-btn-cancel" onclick="closeShopModal()">Cancel</button>
            <button type="submit" class="crm-btn-save">Save Shop</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- CRM Shop Detail Modal -->
  <div class="crm-modal-overlay" id="shopDetailOverlay" style="display: none;" onclick="if(event.target === this) closeShopDetail()">
    <div class="crm-modal crm-modal-large" id="shopDetailModal">
      <div class="crm-modal-header">
        <div>
          <h3 id="shopDetailName">Shop Name</h3>
          <span class="crm-stage-badge" id="shopDetailStage">Stage</span>
        </div>
        <button class="crm-modal-close" onclick="closeShopDetail()">&times;</button>
      </div>
      <div class="crm-modal-body crm-detail-body">
        <div class="crm-detail-main">
          <!-- Shop Info Card -->
          <div class="crm-detail-card">
            <div class="crm-detail-card-header">
              <h4>Shop Information</h4>
              <button class="crm-btn-edit" onclick="editCurrentShop()">Edit</button>
            </div>
            <div class="crm-detail-grid">
              <div class="crm-detail-item">
                <label>Address</label>
                <span id="detailAddress">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Bays</label>
                <span id="detailBays">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Technicians</label>
                <span id="detailTechnicians">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Specialty</label>
                <span id="detailSpecialty">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Monthly Volume</label>
                <span id="detailVolume">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Dealer Competition</label>
                <span id="detailCompetition">--</span>
              </div>
            </div>
          </div>

          <!-- Contact Info Card -->
          <div class="crm-detail-card">
            <div class="crm-detail-card-header">
              <h4>Primary Contact</h4>
            </div>
            <div class="crm-detail-grid">
              <div class="crm-detail-item">
                <label>Name</label>
                <span id="detailContactName">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Role</label>
                <span id="detailContactRole">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Email</label>
                <a id="detailContactEmail" href="#">--</a>
              </div>
              <div class="crm-detail-item">
                <label>Phone</label>
                <a id="detailContactPhone" href="#">--</a>
              </div>
            </div>
          </div>

          <!-- Sales & Pipeline Card -->
          <div class="crm-detail-card">
            <div class="crm-detail-card-header">
              <h4>Sales & Pipeline</h4>
            </div>
            <div class="crm-detail-grid">
              <div class="crm-detail-item">
                <label>Lead Source</label>
                <span id="detailSource">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Account Owner</label>
                <span id="detailAssigned">--</span>
              </div>
            </div>
          </div>

          <!-- Subscription & Devices Card -->
          <div class="crm-detail-card">
            <div class="crm-detail-card-header">
              <h4>Subscription & Devices</h4>
            </div>
            <div class="crm-detail-grid">
              <div class="crm-detail-item">
                <label>Status</label>
                <span id="detailSubscriptionStatus">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Monthly Rate</label>
                <span id="detailMonthlyRate">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Devices Deployed</label>
                <span id="detailDevicesDeployed">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Devices Needed</label>
                <span id="detailDevices">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Contract Start</label>
                <span id="detailContractStart">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Contract End</label>
                <span id="detailContractEnd">--</span>
              </div>
            </div>
          </div>

          <!-- Financials Card -->
          <div class="crm-detail-card">
            <div class="crm-detail-card-header">
              <h4>Financials</h4>
            </div>
            <div class="crm-detail-grid">
              <div class="crm-detail-item">
                <label>Est. Monthly Value</label>
                <span id="detailValue">--</span>
              </div>
              <div class="crm-detail-item">
                <label>Lifetime Value</label>
                <span id="detailLifetimeValue">--</span>
              </div>
            </div>
          </div>

          <!-- Notes Card -->
          <div class="crm-detail-card">
            <div class="crm-detail-card-header">
              <h4>Notes</h4>
            </div>
            <div class="crm-detail-grid">
              <div class="crm-detail-item full-width">
                <span id="detailNotes">--</span>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="crm-quick-actions">
            <button class="crm-action-btn" onclick="logActivity('call')">Log Call</button>
            <button class="crm-action-btn" onclick="logActivity('email')">Log Email</button>
            <button class="crm-action-btn" onclick="logActivity('meeting')">Log Meeting</button>
            <button class="crm-action-btn" onclick="scheduleDemo()">Schedule Demo</button>
            <button class="crm-action-btn advance" onclick="advanceStage()">Advance Stage</button>
          </div>
        </div>

        <!-- Activity Timeline Sidebar -->
        <div class="crm-detail-sidebar">
          <div class="crm-detail-card">
            <div class="crm-detail-card-header">
              <h4>Activity Timeline</h4>
              <button class="crm-btn-add" onclick="openAddActivity()">+ Add</button>
            </div>
            <div class="crm-activity-timeline" id="shopActivityTimeline">
              <div class="crm-activity-empty">No activity recorded yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CRM Add Activity Modal -->
  <div class="crm-modal-overlay" id="activityModalOverlay" style="display: none;" onclick="if(event.target === this) closeActivityModal()">
    <div class="crm-modal crm-modal-small">
      <div class="crm-modal-header">
        <h3>Log Activity</h3>
        <button class="crm-modal-close" onclick="closeActivityModal()">&times;</button>
      </div>
      <div class="crm-modal-body">
        <form id="activityForm" onsubmit="handleActivitySubmit(event)">
          <input type="hidden" id="activityShopId" />
          <div class="crm-form-group">
            <label for="activityType">Activity Type *</label>
            <select id="activityType" required>
              <option value="call">Phone Call</option>
              <option value="email">Email</option>
              <option value="meeting">Meeting</option>
              <option value="demo">Demo</option>
              <option value="note">Note</option>
              <option value="proposal">Proposal Sent</option>
            </select>
          </div>
          <div class="crm-form-group">
            <label for="activityDate">Date *</label>
            <input type="datetime-local" id="activityDate" required />
          </div>
          <div class="crm-form-group">
            <label for="activitySummary">Summary *</label>
            <textarea id="activitySummary" rows="3" required placeholder="What happened?"></textarea>
          </div>
          <div class="crm-form-group">
            <label for="activityNextSteps">Next Steps</label>
            <textarea id="activityNextSteps" rows="2" placeholder="What's the follow-up?"></textarea>
          </div>
          <div class="crm-form-actions">
            <button type="button" class="crm-btn-cancel" onclick="closeActivityModal()">Cancel</button>
            <button type="submit" class="crm-btn-save">Log Activity</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Direct Messages Panel -->
  <div class="dm-panel" id="dmPanel">
    <!-- Conversations List View -->
    <div id="dmConversationsList">
      <div class="dm-panel-header">
        <h3> Direct Messages</h3>
        <button class="dm-close-btn" onclick="toggleDMPanel()"></button>
      </div>
      <div style="padding: 0 8px;">
        <button class="dm-new-chat-btn" onclick="showNewDMModal()">+ New Message</button>
      </div>
      <div class="dm-conversations" id="dmConversations">
        <div class="dm-empty">
          <div class="dm-empty-icon"></div>
          <div>No conversations yet</div>
          <div style="font-size: 12px; margin-top: 4px;">Start a direct message with someone</div>
        </div>
      </div>
    </div>

    <!-- Chat View -->
    <div class="dm-chat-view" id="dmChatView">
      <div class="dm-chat-header">
        <button class="dm-back-btn" onclick="closeDMChat()"></button>
        <div>
          <div id="dmChatRecipient" style="font-weight: 600;"></div>
          <div id="dmChatRecipientType" style="font-size: 11px; color: var(--text-secondary);"></div>
        </div>
      </div>
      <div class="dm-chat-messages" id="dmChatMessages"></div>
      <div class="dm-chat-input">
        <input type="file" id="dmFileInput" accept="image/*,.pdf,.txt,.md,.json" style="display: none;" />
        <button class="dm-attach-btn" onclick="document.getElementById('dmFileInput').click()" title="Attach file"></button>
        <input type="text" id="dmMessageInput" placeholder="Type a message..." onkeypress="handleDMKeypress(event)" />
        <button onclick="sendDM()"></button>
      </div>
    </div>
  </div>

  <!-- New DM Modal -->
  <div class="dm-new-modal" id="dmNewModal">
    <div class="dm-new-modal-content">
      <h3 style="margin: 0 0 16px 0;">Start a conversation</h3>
      <input type="text" id="dmSearchUser" placeholder="Search users..." style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);" oninput="filterDMUsers()" />
      <div class="dm-user-list" id="dmUserList"></div>
      <button style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer;" onclick="hideNewDMModal()">Cancel</button>
    </div>
  </div>


  <!-- Device Detail Modal -->
  <div class="device-modal-overlay" id="deviceModalOverlay" onclick="closeDeviceModal()">
    <div class="device-modal" onclick="event.stopPropagation()">
      <div class="device-modal-header">
        <h3 id="modalDeviceName">Device Name</h3>
        <button class="modal-close" onclick="closeDeviceModal()">&times;</button>
      </div>
      <div class="device-modal-content">
        <div class="modal-section">
          <h4>Vehicle Information</h4>
          <div class="modal-info-grid">
            <div class="info-item">
              <span class="info-label">VIN</span>
              <span class="info-value" id="modalVin">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">Make/Model</span>
              <span class="info-value" id="modalVehicle">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">Year</span>
              <span class="info-value" id="modalYear">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">IMEI</span>
              <span class="info-value" id="modalImei">--</span>
            </div>
          </div>
        </div>
        <div class="modal-section">
          <h4>Current Metrics</h4>
          <div class="modal-metrics-grid">
            <div class="modal-metric">
              <span class="modal-metric-value" id="modalSpeed">0</span>
              <span class="modal-metric-label">km/h</span>
            </div>
            <div class="modal-metric">
              <span class="modal-metric-value" id="modalBattery">--</span>
              <span class="modal-metric-label">Battery (V)</span>
            </div>
            <div class="modal-metric">
              <span class="modal-metric-value" id="modalFuel">--</span>
              <span class="modal-metric-label">Fuel %</span>
            </div>
            <div class="modal-metric">
              <span class="modal-metric-value" id="modalRpm">0</span>
              <span class="modal-metric-label">RPM</span>
            </div>
            <div class="modal-metric">
              <span class="modal-metric-value" id="modalTemp">--</span>
              <span class="modal-metric-label">Coolant</span>
            </div>
            <div class="modal-metric">
              <span class="modal-metric-value" id="modalOdometer">--</span>
              <span class="modal-metric-label">Odometer</span>
            </div>
          </div>
        </div>
        <div class="modal-section">
          <h4>Status</h4>
          <div class="modal-status-grid">
            <div class="status-indicator" id="modalIgnition">
              <span class="status-dot"></span> Ignition
            </div>
            <div class="status-indicator" id="modalMovement">
              <span class="status-dot"></span> Movement
            </div>
            <div class="status-indicator" id="modalGps">
              <span class="status-dot"></span> GPS
            </div>
            <div class="status-indicator" id="modalCharging">
              <span class="status-dot"></span> Charging
            </div>
          </div>
        </div>
        <div class="modal-section">
          <h4>Health</h4>
          <div class="modal-health">
            <div class="health-bar-container">
              <div class="health-bar" id="modalHealthBar" style="width: 100%"></div>
            </div>
            <span class="health-score-label" id="modalHealthScore">100</span>
          </div>
          <div class="modal-issues" id="modalIssues"></div>
        </div>
        <div class="modal-section">
          <h4>Location</h4>
          <div class="modal-location">
            <span id="modalLat">--</span>, <span id="modalLng">--</span>
            <span class="location-meta">
              Heading: <span id="modalHeading">--</span> | 
              Satellites: <span id="modalSats">--</span> |
              Signal: <span id="modalSignal">--</span>/5
            </span>
          </div>
        </div>
        <div class="modal-section sparkline-container" id="modalHistorySection" style="display:none;">
          <h4>24-Hour History</h4>
          <div class="chart-row">
            <div class="chart-card">
              <div class="chart-card-title">Battery Voltage</div>
              <div class="sparkline" id="batterySparkline"></div>
              <div class="sparkline-labels">
                <span>24h ago</span>
                <span>Now</span>
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-card-title">Speed (km/h)</div>
              <div class="sparkline" id="speedSparkline"></div>
              <div class="sparkline-labels">
                <span>24h ago</span>
                <span>Now</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
